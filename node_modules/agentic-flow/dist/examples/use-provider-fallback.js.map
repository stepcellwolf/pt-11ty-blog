{"version":3,"file":"use-provider-fallback.js","sourceRoot":"","sources":["../../src/examples/use-provider-fallback.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Example: Long-Running Agent with Provider Fallback\n *\n * This example demonstrates:\n * - Automatic provider fallback\n * - Cost optimization\n * - Health monitoring\n * - Checkpointing for crash recovery\n * - Budget constraints\n */\n\nimport { LongRunningAgent } from '../core/long-running-agent.js';\nimport { ProviderConfig } from '../core/provider-manager.js';\nimport { logger } from '../utils/logger.js';\n\nasync function main() {\n  console.log('üöÄ Starting Long-Running Agent with Provider Fallback\\n');\n\n  // Configure providers with priorities and costs\n  const providers: ProviderConfig[] = [\n    {\n      name: 'gemini',\n      apiKey: process.env.GOOGLE_GEMINI_API_KEY,\n      priority: 1, // Try Gemini first (fastest, cheapest)\n      maxRetries: 3,\n      timeout: 30000,\n      costPerToken: 0.00015, // $0.15 per 1M tokens\n      enabled: !!process.env.GOOGLE_GEMINI_API_KEY,\n      healthCheckInterval: 60000 // Check every minute\n    },\n    {\n      name: 'anthropic',\n      apiKey: process.env.ANTHROPIC_API_KEY,\n      priority: 2, // Fallback to Claude (higher quality)\n      maxRetries: 3,\n      timeout: 60000,\n      costPerToken: 0.003, // $3 per 1M tokens (Sonnet)\n      enabled: !!process.env.ANTHROPIC_API_KEY,\n      healthCheckInterval: 60000\n    },\n    {\n      name: 'openrouter',\n      apiKey: process.env.OPENROUTER_API_KEY,\n      priority: 3, // Fallback to OpenRouter\n      maxRetries: 3,\n      timeout: 60000,\n      costPerToken: 0.001, // Varies by model\n      enabled: !!process.env.OPENROUTER_API_KEY,\n      healthCheckInterval: 60000\n    },\n    {\n      name: 'onnx',\n      priority: 4, // Last resort (local, free but slower)\n      maxRetries: 2,\n      timeout: 120000,\n      costPerToken: 0, // FREE\n      enabled: true,\n      healthCheckInterval: 300000 // Check every 5 minutes\n    }\n  ];\n\n  // Create agent with cost and performance optimization\n  const agent = new LongRunningAgent({\n    agentName: 'research-and-code-agent',\n    providers,\n    fallbackStrategy: {\n      type: 'cost-optimized', // Prefer cheaper providers\n      maxFailures: 3, // Open circuit breaker after 3 failures\n      recoveryTime: 60000, // Try recovery after 1 minute\n      retryBackoff: 'exponential',\n      costThreshold: 0.50, // Max $0.50 per request\n      latencyThreshold: 30000 // Max 30s per request\n    },\n    checkpointInterval: 30000, // Save state every 30 seconds\n    maxRuntime: 3600000, // Max 1 hour\n    costBudget: 5.00 // Max $5 total spend\n  });\n\n  await agent.start();\n\n  try {\n    // Simulate long-running workflow with different task complexities\n    console.log('\\nüìã Task 1: Simple Code Generation (Gemini optimal)\\n');\n    const task1 = await agent.executeTask({\n      name: 'generate-hello-world',\n      complexity: 'simple',\n      estimatedTokens: 200,\n      execute: async (provider: string) => {\n        console.log(`  Using provider: ${provider}`);\n        // Simulated API call\n        await new Promise(resolve => setTimeout(resolve, 1000));\n        return { code: 'console.log(\"Hello World\");', provider };\n      }\n    });\n    console.log(`  ‚úÖ Result:`, task1);\n\n    console.log('\\nüìã Task 2: Complex Architecture Design (Claude optimal)\\n');\n    const task2 = await agent.executeTask({\n      name: 'design-microservices-architecture',\n      complexity: 'complex',\n      estimatedTokens: 5000,\n      execute: async (provider: string) => {\n        console.log(`  Using provider: ${provider}`);\n        await new Promise(resolve => setTimeout(resolve, 2000));\n        return {\n          architecture: 'Event-driven microservices with CQRS',\n          provider\n        };\n      }\n    });\n    console.log(`  ‚úÖ Result:`, task2);\n\n    console.log('\\nüìã Task 3: Medium Refactoring (Auto-optimized)\\n');\n    const task3 = await agent.executeTask({\n      name: 'refactor-legacy-code',\n      complexity: 'medium',\n      estimatedTokens: 1500,\n      execute: async (provider: string) => {\n        console.log(`  Using provider: ${provider}`);\n        await new Promise(resolve => setTimeout(resolve, 1500));\n        return {\n          refactored: true,\n          improvements: ['Better naming', 'Modular design'],\n          provider\n        };\n      }\n    });\n    console.log(`  ‚úÖ Result:`, task3);\n\n    // Simulate provider failure for demonstration\n    console.log('\\nüìã Task 4: Testing Fallback (Simulated Failure)\\n');\n    let failureCount = 0;\n    const task4 = await agent.executeTask({\n      name: 'test-fallback',\n      complexity: 'simple',\n      estimatedTokens: 300,\n      execute: async (provider: string) => {\n        console.log(`  Attempting with provider: ${provider}`);\n\n        // Simulate failure on first two attempts\n        if (failureCount < 2) {\n          failureCount++;\n          throw new Error('Simulated rate limit error');\n        }\n\n        await new Promise(resolve => setTimeout(resolve, 1000));\n        return {\n          message: 'Success after fallback!',\n          provider,\n          attempts: failureCount + 1\n        };\n      }\n    });\n    console.log(`  ‚úÖ Result:`, task4);\n\n    // Get final status\n    console.log('\\nüìä Final Agent Status:\\n');\n    const status = agent.getStatus();\n    console.log(JSON.stringify(status, null, 2));\n\n    console.log('\\nüí∞ Cost Summary:\\n');\n    const metrics = agent.getMetrics();\n    console.log('Total Cost:', `$${metrics.costs.total.toFixed(4)}`);\n    console.log('Total Tokens:', metrics.costs.totalTokens.toLocaleString());\n    console.log('\\nBy Provider:');\n    for (const [provider, cost] of Object.entries(metrics.costs.byProvider)) {\n      console.log(`  ${provider}: $${cost.toFixed(4)}`);\n    }\n\n    console.log('\\nüìà Provider Health:\\n');\n    for (const health of metrics.health) {\n      console.log(`${health.provider}:`);\n      console.log(`  Healthy: ${health.isHealthy}`);\n      console.log(`  Success Rate: ${(health.successRate * 100).toFixed(1)}%`);\n      console.log(`  Avg Latency: ${health.averageLatency.toFixed(0)}ms`);\n      console.log(`  Circuit Breaker: ${health.circuitBreakerOpen ? 'OPEN' : 'CLOSED'}`);\n      console.log('');\n    }\n\n  } catch (error) {\n    console.error('‚ùå Agent execution failed:', error);\n  } finally {\n    await agent.stop();\n    console.log('\\n‚úÖ Agent stopped successfully\\n');\n  }\n}\n\n// Run example\nif (import.meta.url === `file://${process.argv[1]}`) {\n  main().catch(console.error);\n}\n\nexport { main as runProviderFallbackExample };\n"]}