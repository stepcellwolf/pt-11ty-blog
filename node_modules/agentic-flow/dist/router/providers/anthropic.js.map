{"version":3,"file":"anthropic.js","sourceRoot":"","sources":["../../../src/router/providers/anthropic.ts"],"names":[],"mappings":"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","sourcesContent":["// Anthropic provider implementation\nimport Anthropic from '@anthropic-ai/sdk';\nimport {\n  LLMProvider,\n  ChatParams,\n  ChatResponse,\n  StreamChunk,\n  ProviderConfig,\n  ProviderError,\n  ContentBlock\n} from '../types.js';\n\nexport class AnthropicProvider implements LLMProvider {\n  name = 'anthropic';\n  type = 'anthropic' as const;\n  supportsStreaming = true;\n  supportsTools = true;\n  supportsMCP = true; // Native support\n\n  private client: Anthropic;\n  private config: ProviderConfig;\n\n  constructor(config: ProviderConfig) {\n    this.config = config;\n\n    if (!config.apiKey) {\n      throw new Error('Anthropic API key is required');\n    }\n\n    this.client = new Anthropic({\n      apiKey: config.apiKey,\n      baseURL: config.baseUrl,\n      timeout: config.timeout || 120000,\n      maxRetries: config.maxRetries || 3\n    });\n  }\n\n  validateCapabilities(features: string[]): boolean {\n    const supported = ['chat', 'streaming', 'tools', 'mcp'];\n    return features.every(f => supported.includes(f));\n  }\n\n  async chat(params: ChatParams): Promise<ChatResponse> {\n    try {\n      // Extract system message if present (Anthropic requires it as top-level parameter)\n      const systemMessage = params.messages.find(m => m.role === 'system');\n      const nonSystemMessages = params.messages.filter(m => m.role !== 'system');\n\n      const response = await this.client.messages.create({\n        model: params.model,\n        messages: nonSystemMessages as any,\n        system: systemMessage ? (typeof systemMessage.content === 'string' ? systemMessage.content : JSON.stringify(systemMessage.content)) : undefined,\n        temperature: params.temperature,\n        max_tokens: params.maxTokens || 4096,\n        tools: params.tools as any,\n        tool_choice: params.toolChoice as any\n      });\n\n      return {\n        id: response.id,\n        model: response.model,\n        content: response.content as ContentBlock[],\n        stopReason: response.stop_reason as any,\n        usage: {\n          inputTokens: response.usage.input_tokens,\n          outputTokens: response.usage.output_tokens\n        },\n        metadata: {\n          provider: 'anthropic',\n          cost: this.calculateCost(response.usage),\n          latency: 0 // Will be set by router\n        }\n      };\n    } catch (error: any) {\n      throw this.handleError(error);\n    }\n  }\n\n  async *stream(params: ChatParams): AsyncGenerator<StreamChunk> {\n    try {\n      // Extract system message if present (Anthropic requires it as top-level parameter)\n      const systemMessage = params.messages.find(m => m.role === 'system');\n      const nonSystemMessages = params.messages.filter(m => m.role !== 'system');\n\n      const stream = await this.client.messages.create({\n        model: params.model,\n        messages: nonSystemMessages as any,\n        system: systemMessage ? (typeof systemMessage.content === 'string' ? systemMessage.content : JSON.stringify(systemMessage.content)) : undefined,\n        temperature: params.temperature,\n        max_tokens: params.maxTokens || 4096,\n        tools: params.tools as any,\n        tool_choice: params.toolChoice as any,\n        stream: true\n      });\n\n      for await (const event of stream) {\n        yield event as StreamChunk;\n      }\n    } catch (error: any) {\n      throw this.handleError(error);\n    }\n  }\n\n  private calculateCost(usage: { input_tokens: number; output_tokens: number }): number {\n    // Claude 3.5 Sonnet pricing: $3/MTok input, $15/MTok output\n    const inputCost = (usage.input_tokens / 1_000_000) * 3;\n    const outputCost = (usage.output_tokens / 1_000_000) * 15;\n    return inputCost + outputCost;\n  }\n\n  private handleError(error: any): ProviderError {\n    const providerError = new Error(\n      error.message || 'Anthropic request failed'\n    ) as ProviderError;\n\n    providerError.provider = 'anthropic';\n    providerError.statusCode = error.status;\n    providerError.retryable = error.status >= 500 || error.status === 429;\n\n    return providerError;\n  }\n}\n"]}