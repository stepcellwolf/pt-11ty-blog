{"version":3,"file":"parallel-validation.js","sourceRoot":"","sources":["../../src/hooks/parallel-validation.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Validation hooks to ensure agents follow parallel execution best practices\n */\n\nexport interface AgentResponse {\n  code?: string;\n  output?: string;\n  subprocesses?: Array<{ command: string; result: any }>;\n  toolCalls?: Array<{ name: string; args: any }>;\n}\n\nexport interface ExecutionMetrics {\n  avgBatchSize: number;\n  subprocessesSpawned: number;\n  reasoningBankUsage: number;\n  parallelOpsCount?: number;\n  sequentialOpsCount?: number;\n}\n\nexport interface ParallelValidationResult {\n  score: number; // 0-1, where 1 is perfect parallel execution\n  issues: string[];\n  recommendations: string[];\n  metrics: {\n    parallelOpsCount: number;\n    sequentialOpsCount: number;\n    avgBatchSize: number;\n    subprocessesSpawned: number;\n    reasoningBankUsage: number;\n  };\n}\n\n/**\n * Validate agent's parallel execution patterns\n */\nexport function validateParallelExecution(\n  response: AgentResponse,\n  metrics: ExecutionMetrics\n): ParallelValidationResult {\n  const issues: string[] = [];\n  const recommendations: string[] = [];\n  let score = 1.0;\n\n  // Check 1: Sequential subprocess spawning\n  if (hasSequentialSubprocessSpawning(response)) {\n    issues.push(\"Sequential subprocess spawning detected\");\n    recommendations.push(\n      \"Use Promise.all() to spawn all subprocesses concurrently:\\n\" +\n      \"await Promise.all([exec('agent1'), exec('agent2'), exec('agent3')])\"\n    );\n    score -= 0.3;\n  }\n\n  // Check 2: Missing ReasoningBank coordination\n  if ((response.subprocesses?.length || 0) > 1 && !usesReasoningBank(response)) {\n    issues.push(\"Multiple subprocesses without ReasoningBank coordination\");\n    recommendations.push(\n      \"Store subprocess results in ReasoningBank for proper coordination:\\n\" +\n      \"await reasoningBank.storePattern({ sessionId: 'swarm/task-id/agent-id', task, output, reward, success })\"\n    );\n    score -= 0.2;\n  }\n\n  // Check 3: Small batch sizes\n  if (metrics.avgBatchSize < 3) {\n    issues.push(`Small batch size detected: ${metrics.avgBatchSize} (recommended: 5+)`);\n    recommendations.push(\n      \"Increase batch size to maximize parallelism. Target 5-10 concurrent operations.\"\n    );\n    score -= 0.1;\n  }\n\n  // Check 4: No QUIC transport for large-scale operations\n  if (metrics.subprocessesSpawned > 10 && !usesQuicTransport(response)) {\n    issues.push(\"Large-scale operation without QUIC transport\");\n    recommendations.push(\n      \"Use QUIC transport for 50-70% performance improvement:\\n\" +\n      \"npx agentic-flow --agent TYPE --task TASK --transport quic\"\n    );\n    score -= 0.15;\n  }\n\n  // Check 5: Missing result synthesis\n  if ((response.subprocesses?.length || 0) > 1 && !synthesizesResults(response)) {\n    issues.push(\"Multiple subprocesses without result synthesis\");\n    recommendations.push(\n      \"Combine subprocess results into a unified report:\\n\" +\n      \"const allResults = await Promise.all(subprocesses.map(retrieveResult));\\n\" +\n      \"const report = synthesize(allResults);\"\n    );\n    score -= 0.15;\n  }\n\n  // Check 6: No pattern storage for successful executions\n  if (score > 0.8 && !storesSuccessPattern(response)) {\n    recommendations.push(\n      \"Store successful execution patterns in ReasoningBank for learning:\\n\" +\n      \"await reasoningBank.storePattern({ sessionId, task, output, reward, success })\"\n    );\n    score -= 0.1;\n  }\n\n  return {\n    score: Math.max(0, score),\n    issues,\n    recommendations,\n    metrics: {\n      parallelOpsCount: countParallelOps(response),\n      sequentialOpsCount: countSequentialOps(response),\n      avgBatchSize: metrics.avgBatchSize,\n      subprocessesSpawned: metrics.subprocessesSpawned,\n      reasoningBankUsage: metrics.reasoningBankUsage\n    }\n  };\n}\n\n// Helper functions\nfunction hasSequentialSubprocessSpawning(response: AgentResponse): boolean {\n  // Check if subprocess spawning uses await in sequence vs Promise.all\n  const code = response.code || response.output || '';\n  const hasAwaitExec = /await\\s+exec/.test(code);\n  const hasPromiseAll = /Promise\\.all\\(/i.test(code);\n\n  return hasAwaitExec && !hasPromiseAll;\n}\n\nfunction usesReasoningBank(response: AgentResponse): boolean {\n  const code = response.code || response.output || '';\n  return /reasoningBank\\.(store|retrieve|search|storePattern)/.test(code);\n}\n\nfunction usesQuicTransport(response: AgentResponse): boolean {\n  const code = response.code || response.output || '';\n  return /--transport\\s+quic/i.test(code) || /QuicTransport/.test(code);\n}\n\nfunction synthesizesResults(response: AgentResponse): boolean {\n  const code = response.code || response.output || '';\n  return /synthesize|combine|merge|aggregate/i.test(code);\n}\n\nfunction storesSuccessPattern(response: AgentResponse): boolean {\n  const code = response.code || response.output || '';\n  return /storePattern|reasoningBank\\.store/.test(code);\n}\n\nfunction countParallelOps(response: AgentResponse): number {\n  const code = response.code || response.output || '';\n  const promiseAllMatches = code.match(/Promise\\.all\\(/g);\n  return promiseAllMatches?.length || 0;\n}\n\nfunction countSequentialOps(response: AgentResponse): number {\n  const code = response.code || response.output || '';\n  const awaitMatches = code.match(/await\\s+(?!Promise\\.all)/g);\n  return awaitMatches?.length || 0;\n}\n\n/**\n * Post-execution hook: Log validation results and suggestions\n */\nexport async function postExecutionValidation(\n  response: AgentResponse,\n  metrics: ExecutionMetrics\n): Promise<ParallelValidationResult> {\n  const validation = validateParallelExecution(response, metrics);\n\n  console.log('\\nðŸ“Š Parallel Execution Validation');\n  console.log('â•'.repeat(60));\n  console.log(`Score: ${(validation.score * 100).toFixed(1)}%`);\n  console.log(`Parallel Ops: ${validation.metrics.parallelOpsCount}`);\n  console.log(`Sequential Ops: ${validation.metrics.sequentialOpsCount}`);\n  console.log(`Batch Size: ${validation.metrics.avgBatchSize}`);\n  console.log(`Subprocesses: ${validation.metrics.subprocessesSpawned}`);\n  console.log(`ReasoningBank Usage: ${validation.metrics.reasoningBankUsage}`);\n\n  if (validation.issues.length > 0) {\n    console.log('\\nâš ï¸  Issues Detected:');\n    validation.issues.forEach((issue, i) => {\n      console.log(`  ${i + 1}. ${issue}`);\n    });\n  }\n\n  if (validation.recommendations.length > 0) {\n    console.log('\\nðŸ’¡ Recommendations:');\n    validation.recommendations.forEach((rec, i) => {\n      console.log(`  ${i + 1}. ${rec}`);\n    });\n  }\n\n  console.log('â•'.repeat(60));\n\n  return validation;\n}\n\n/**\n * Grade parallel execution quality\n */\nexport function gradeParallelExecution(score: number): {\n  grade: string;\n  description: string;\n  color: string;\n} {\n  if (score >= 0.9) {\n    return {\n      grade: 'A',\n      description: 'Excellent parallel execution',\n      color: 'green'\n    };\n  } else if (score >= 0.75) {\n    return {\n      grade: 'B',\n      description: 'Good parallel execution with minor improvements needed',\n      color: 'blue'\n    };\n  } else if (score >= 0.6) {\n    return {\n      grade: 'C',\n      description: 'Acceptable parallel execution with room for improvement',\n      color: 'yellow'\n    };\n  } else if (score >= 0.4) {\n    return {\n      grade: 'D',\n      description: 'Poor parallel execution, needs significant improvements',\n      color: 'orange'\n    };\n  } else {\n    return {\n      grade: 'F',\n      description: 'Sequential execution detected, parallelism not utilized',\n      color: 'red'\n    };\n  }\n}\n"]}