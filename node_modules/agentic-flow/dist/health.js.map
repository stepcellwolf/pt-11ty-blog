{"version":3,"file":"health.js","sourceRoot":"","sources":["../src/health.ts"],"names":[],"mappings":"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","sourcesContent":["// Health check endpoint with QUIC support\nimport http from 'http';\nimport { logger } from './utils/logger.js';\nimport type { QuicClient, QuicStats } from './transport/quic.js';\nimport type { QuicConfigSchema } from './config/quic.js';\n\ninterface HealthStatus {\n  status: 'healthy' | 'degraded' | 'unhealthy';\n  timestamp: string;\n  uptime: number;\n  version: string;\n  checks: {\n    api: { status: 'pass' | 'fail'; message?: string };\n    memory: { status: 'pass' | 'warn' | 'fail'; usage: number; limit: number };\n    quic?: { status: 'pass' | 'warn' | 'fail'; enabled: boolean; available?: boolean; connections?: number };\n  };\n}\n\nlet serverStartTime = Date.now();\n\nexport async function getHealthStatus(): Promise<HealthStatus> {\n  const memUsage = process.memoryUsage();\n  const memLimit = 512 * 1024 * 1024; // 512MB\n  const memPercent = (memUsage.heapUsed / memLimit) * 100;\n\n  const apiKey = process.env.ANTHROPIC_API_KEY;\n\n  const checks: HealthStatus['checks'] = {\n    api: {\n      status: apiKey && apiKey.startsWith('sk-ant-') ? 'pass' : 'fail',\n      message: apiKey ? undefined : 'ANTHROPIC_API_KEY not configured'\n    },\n    memory: {\n      status: memPercent > 90 ? 'fail' : memPercent > 75 ? 'warn' : 'pass',\n      usage: Math.round(memUsage.heapUsed / 1024 / 1024),\n      limit: Math.round(memLimit / 1024 / 1024)\n    }\n  };\n\n  // Check QUIC availability if enabled\n  const quicEnabled = process.env.AGENTIC_FLOW_ENABLE_QUIC === 'true';\n  if (quicEnabled) {\n    try {\n      // Dynamic import to avoid loading QUIC module when not needed\n      const { checkQuicAvailability } = await import('./config/quic.js');\n      const availability = await checkQuicAvailability();\n\n      checks.quic = {\n        status: availability.available ? 'pass' : 'warn',\n        enabled: true,\n        available: availability.available,\n        connections: 0\n      };\n    } catch (error) {\n      logger.warn('QUIC health check failed', { error });\n      checks.quic = {\n        status: 'fail',\n        enabled: true,\n        available: false\n      };\n    }\n  }\n\n  let overallStatus: 'healthy' | 'degraded' | 'unhealthy' = 'healthy';\n  if (checks.memory.status === 'fail' || checks.api.status === 'fail') {\n    overallStatus = 'unhealthy';\n  } else if (checks.memory.status === 'warn' || checks.quic?.status === 'warn') {\n    overallStatus = 'degraded';\n  }\n\n  return {\n    status: overallStatus,\n    timestamp: new Date().toISOString(),\n    uptime: (Date.now() - serverStartTime) / 1000,\n    version: process.env.npm_package_version || '1.5.10',\n    checks\n  };\n}\n\nexport function startHealthServer(port: number = 8080): http.Server {\n  const server = http.createServer(async (req, res) => {\n    if (req.url === '/health' && req.method === 'GET') {\n      const health = await getHealthStatus();\n      const statusCode = health.status === 'healthy' ? 200 : health.status === 'degraded' ? 200 : 503;\n\n      res.writeHead(statusCode, { 'Content-Type': 'application/json' });\n      res.end(JSON.stringify(health, null, 2));\n\n      logger.debug('Health check requested', { status: health.status, quicEnabled: !!health.checks.quic });\n    } else if (req.url === '/health/quic' && req.method === 'GET') {\n      // QUIC-specific health endpoint\n      const quicEnabled = process.env.AGENTIC_FLOW_ENABLE_QUIC === 'true';\n\n      if (!quicEnabled) {\n        res.writeHead(200, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify({ enabled: false, message: 'QUIC transport is disabled' }));\n        return;\n      }\n\n      try {\n        const { checkQuicAvailability, loadQuicConfig } = await import('./config/quic.js');\n        const availability = await checkQuicAvailability();\n        const config = loadQuicConfig();\n\n        res.writeHead(availability.available ? 200 : 503, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify({\n          enabled: true,\n          available: availability.available,\n          reason: availability.reason,\n          config: {\n            host: config.host,\n            port: config.port,\n            maxConnections: config.maxConnections,\n            maxStreams: config.maxConcurrentStreams\n          }\n        }, null, 2));\n      } catch (error) {\n        res.writeHead(503, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify({\n          enabled: true,\n          available: false,\n          error: (error as Error).message\n        }));\n      }\n    } else {\n      res.writeHead(404, { 'Content-Type': 'application/json' });\n      res.end(JSON.stringify({ error: 'Not found' }));\n    }\n  });\n\n  server.listen(port, () => {\n    logger.info('Health check server started', { port });\n  });\n\n  return server;\n}\n"]}