{"version":3,"file":"SharedMemoryPool.js","sourceRoot":"","sources":["../../src/memory/SharedMemoryPool.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Shared Memory Pool for AgentDB\n *\n * Provides a singleton memory pool that multiple agents can share:\n * - Single SQLite database connection (reduces overhead)\n * - Single embedding model instance (saves ~150MB per agent)\n * - Shared query cache (LRU with TTL)\n * - Shared embedding cache (deduplication)\n *\n * Memory savings: ~300-500MB for 4+ concurrent agents\n *\n * @example\n * ```typescript\n * import { SharedMemoryPool } from 'agentic-flow/memory';\n *\n * const pool = SharedMemoryPool.getInstance();\n * const db = pool.getDatabase();\n * const embedder = pool.getEmbedder();\n * ```\n */\n\n// Use AgentDB's sql.js fallback instead of better-sqlite3\ntype Database = any;\nimport { EmbeddingService } from 'agentdb/controllers';\nimport * as path from 'path';\nimport * as fs from 'fs';\n\ninterface CachedQuery {\n  result: any;\n  expires: number;\n}\n\nexport interface SharedMemoryPoolConfig {\n  dbPath?: string;\n  cacheSize?: number;\n  embeddingCacheSize?: number;\n  embeddingModel?: string;\n  embeddingDimension?: number;\n}\n\nexport class SharedMemoryPool {\n  private static instance: SharedMemoryPool;\n  private db: Database.Database;\n  private embedder: EmbeddingService;\n  private queryCache: Map<string, CachedQuery>;\n  private embeddingCache: Map<string, Float32Array>;\n  private config: Required<SharedMemoryPoolConfig>;\n  private initialized: boolean = false;\n\n  private constructor(config: SharedMemoryPoolConfig = {}) {\n    this.config = {\n      dbPath: config.dbPath || './agentdb.db',\n      cacheSize: config.cacheSize || 1000,\n      embeddingCacheSize: config.embeddingCacheSize || 10000,\n      embeddingModel: config.embeddingModel || 'Xenova/all-MiniLM-L6-v2',\n      embeddingDimension: config.embeddingDimension || 384\n    };\n\n    // Initialize SQLite with optimized settings\n    const dbDir = path.dirname(this.config.dbPath);\n    if (!fs.existsSync(dbDir)) {\n      fs.mkdirSync(dbDir, { recursive: true });\n    }\n\n    this.db = new Database(this.config.dbPath);\n\n    // Optimize SQLite for performance\n    this.db.pragma('journal_mode = WAL');          // Write-Ahead Logging\n    this.db.pragma('synchronous = NORMAL');        // Balanced safety/performance\n    this.db.pragma('cache_size = -65536');         // 64MB cache\n    this.db.pragma('mmap_size = 268435456');       // 256MB memory-mapped I/O\n    this.db.pragma('page_size = 8192');            // 8KB pages\n    this.db.pragma('temp_store = MEMORY');         // Keep temp tables in memory\n\n    // Initialize embedding service (will be lazy-loaded)\n    this.embedder = new EmbeddingService({\n      model: this.config.embeddingModel,\n      dimension: this.config.embeddingDimension,\n      provider: 'transformers'\n    });\n\n    // Initialize caches\n    this.queryCache = new Map();\n    this.embeddingCache = new Map();\n  }\n\n  /**\n   * Get singleton instance of SharedMemoryPool\n   */\n  public static getInstance(config?: SharedMemoryPoolConfig): SharedMemoryPool {\n    if (!SharedMemoryPool.instance) {\n      SharedMemoryPool.instance = new SharedMemoryPool(config);\n    }\n    return SharedMemoryPool.instance;\n  }\n\n  /**\n   * Reset singleton instance (for testing)\n   */\n  public static resetInstance(): void {\n    if (SharedMemoryPool.instance) {\n      SharedMemoryPool.instance.close();\n      SharedMemoryPool.instance = null as any;\n    }\n  }\n\n  /**\n   * Ensure embedding service is initialized\n   */\n  public async ensureInitialized(): Promise<void> {\n    if (!this.initialized) {\n      await this.embedder.initialize();\n      this.initialized = true;\n    }\n  }\n\n  /**\n   * Get shared database connection\n   */\n  public getDatabase(): Database.Database {\n    return this.db;\n  }\n\n  /**\n   * Get shared embedding service\n   */\n  public getEmbedder(): EmbeddingService {\n    return this.embedder;\n  }\n\n  /**\n   * Get or compute embedding with caching\n   *\n   * @param text Text to embed\n   * @returns Cached or newly computed embedding\n   */\n  public async getCachedEmbedding(text: string): Promise<Float32Array> {\n    const cached = this.embeddingCache.get(text);\n    if (cached) return cached;\n\n    await this.ensureInitialized();\n    const embedding = await this.embedder.embed(text);\n\n    // LRU eviction if cache too large\n    if (this.embeddingCache.size >= this.config.embeddingCacheSize) {\n      const firstKey = this.embeddingCache.keys().next().value;\n      if (firstKey) {\n        this.embeddingCache.delete(firstKey);\n      }\n    }\n\n    this.embeddingCache.set(text, embedding);\n    return embedding;\n  }\n\n  /**\n   * Cache query result with TTL\n   *\n   * @param key Cache key\n   * @param result Result to cache\n   * @param ttl Time-to-live in milliseconds (default: 60s)\n   */\n  public cacheQuery(key: string, result: any, ttl: number = 60000): void {\n    // LRU eviction if cache too large\n    if (this.queryCache.size >= this.config.cacheSize) {\n      const firstKey = this.queryCache.keys().next().value;\n      if (firstKey) {\n        this.queryCache.delete(firstKey);\n      }\n    }\n\n    this.queryCache.set(key, {\n      result,\n      expires: Date.now() + ttl\n    });\n  }\n\n  /**\n   * Get cached query result\n   *\n   * @param key Cache key\n   * @returns Cached result or null if expired/missing\n   */\n  public getCachedQuery(key: string): any | null {\n    const cached = this.queryCache.get(key);\n    if (!cached) return null;\n\n    if (Date.now() > cached.expires) {\n      this.queryCache.delete(key);\n      return null;\n    }\n\n    return cached.result;\n  }\n\n  /**\n   * Clear all caches\n   */\n  public clearCaches(): void {\n    this.queryCache.clear();\n    this.embeddingCache.clear();\n  }\n\n  /**\n   * Get memory pool statistics\n   */\n  public getStats() {\n    const dbStats = this.db.prepare(`\n      SELECT\n        (SELECT COUNT(*) FROM sqlite_master WHERE type='table') as tables,\n        (SELECT page_count * page_size FROM pragma_page_count(), pragma_page_size()) as dbSize\n    `).get() as any;\n\n    return {\n      database: {\n        path: this.config.dbPath,\n        size: dbStats.dbSize,\n        tables: dbStats.tables,\n        walMode: this.db.pragma('journal_mode', { simple: true }),\n      },\n      cache: {\n        queryCacheSize: this.queryCache.size,\n        queryCacheMax: this.config.cacheSize,\n        embeddingCacheSize: this.embeddingCache.size,\n        embeddingCacheMax: this.config.embeddingCacheSize,\n      },\n      embedder: {\n        model: this.config.embeddingModel,\n        dimension: this.config.embeddingDimension,\n        initialized: this.initialized,\n      },\n      memory: {\n        heapUsed: Math.round(process.memoryUsage().heapUsed / 1024 / 1024),\n        external: Math.round(process.memoryUsage().external / 1024 / 1024),\n      }\n    };\n  }\n\n  /**\n   * Close database connection and cleanup\n   */\n  public close(): void {\n    this.clearCaches();\n    this.db.close();\n    this.initialized = false;\n  }\n}\n\n// Export singleton getter for convenience\nexport const getSharedMemoryPool = SharedMemoryPool.getInstance;\n"]}