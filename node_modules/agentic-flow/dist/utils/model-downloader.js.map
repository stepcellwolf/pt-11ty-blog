{"version":3,"file":"model-downloader.js","sourceRoot":"","sources":["../../src/utils/model-downloader.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Automatic Model Downloader for ONNX Phi-4\n *\n * Downloads Phi-4 ONNX model from HuggingFace on first use\n */\n\nimport { createWriteStream, existsSync, mkdirSync } from 'fs';\nimport { dirname, join } from 'path';\nimport { pipeline } from 'stream/promises';\nimport { createHash } from 'crypto';\nimport { readFileSync } from 'fs';\n\nexport interface DownloadProgress {\n  downloaded: number;\n  total: number;\n  percentage: number;\n}\n\nexport interface ModelInfo {\n  repo: string;\n  filename: string;\n  localPath: string;\n  sha256?: string;\n}\n\nexport class ModelDownloader {\n  private baseUrl = 'https://huggingface.co';\n\n  /**\n   * Phi-4 Mini ONNX INT4 quantized model (CPU optimized)\n   * Size: ~52MB model + ~4.86GB data = ~4.9GB total\n   * Note: Requires TWO files - model.onnx and model.onnx.data\n   */\n  private phi4Model: ModelInfo = {\n    repo: 'microsoft/Phi-4-mini-instruct-onnx',\n    filename: 'cpu_and_mobile/cpu-int4-rtn-block-32-acc-level-4/model.onnx',\n    localPath: './models/phi-4-mini/cpu_and_mobile/cpu-int4-rtn-block-32-acc-level-4/model.onnx'\n  };\n\n  private phi4ModelData: ModelInfo = {\n    repo: 'microsoft/Phi-4-mini-instruct-onnx',\n    filename: 'cpu_and_mobile/cpu-int4-rtn-block-32-acc-level-4/model.onnx.data',\n    localPath: './models/phi-4-mini/cpu_and_mobile/cpu-int4-rtn-block-32-acc-level-4/model.onnx.data'\n  };\n\n  /**\n   * Check if model exists locally\n   */\n  isModelDownloaded(modelPath?: string): boolean {\n    const path = modelPath || this.phi4Model.localPath;\n    return existsSync(path);\n  }\n\n  /**\n   * Get model download URL\n   */\n  private getDownloadUrl(model: ModelInfo): string {\n    return `${this.baseUrl}/${model.repo}/resolve/main/${model.filename}`;\n  }\n\n  /**\n   * Download model with progress tracking\n   */\n  async downloadModel(\n    modelInfo?: ModelInfo,\n    onProgress?: (progress: DownloadProgress) => void\n  ): Promise<string> {\n    const model = modelInfo || this.phi4Model;\n\n    // Check if already downloaded\n    if (this.isModelDownloaded(model.localPath)) {\n      console.log(`‚úÖ Model already exists at ${model.localPath}`);\n      return model.localPath;\n    }\n\n    // Create directory\n    const dir = dirname(model.localPath);\n    if (!existsSync(dir)) {\n      mkdirSync(dir, { recursive: true });\n    }\n\n    const url = this.getDownloadUrl(model);\n    console.log(`üì¶ Downloading Phi-4 ONNX model from HuggingFace...`);\n    console.log(`   URL: ${url}`);\n    console.log(`   Destination: ${model.localPath}`);\n\n    try {\n      const response = await fetch(url);\n\n      if (!response.ok) {\n        throw new Error(`Download failed: ${response.statusText}`);\n      }\n\n      const totalSize = parseInt(response.headers.get('content-length') || '0', 10);\n      let downloadedSize = 0;\n\n      if (!response.body) {\n        throw new Error('Response body is null');\n      }\n\n      const fileStream = createWriteStream(model.localPath);\n\n      // Track progress\n      const reader = response.body.getReader();\n      const chunks: Uint8Array[] = [];\n\n      while (true) {\n        const { done, value } = await reader.read();\n\n        if (done) break;\n\n        if (value) {\n          chunks.push(value);\n          downloadedSize += value.length;\n\n          if (onProgress && totalSize > 0) {\n            onProgress({\n              downloaded: downloadedSize,\n              total: totalSize,\n              percentage: (downloadedSize / totalSize) * 100\n            });\n          }\n\n          // Write chunk\n          fileStream.write(value);\n        }\n      }\n\n      fileStream.end();\n\n      // Wait for file stream to finish\n      await new Promise<void>((resolve, reject) => {\n        fileStream.on('finish', () => resolve());\n        fileStream.on('error', reject);\n      });\n\n      console.log(`‚úÖ Model downloaded successfully`);\n      console.log(`   Size: ${(downloadedSize / (1024 * 1024)).toFixed(2)} MB`);\n      console.log(`   Path: ${model.localPath}`);\n\n      return model.localPath;\n\n    } catch (error) {\n      console.error(`‚ùå Model download failed:`, error);\n      throw new Error(`Failed to download model: ${error}`);\n    }\n  }\n\n  /**\n   * Download Phi-4 ONNX model if needed (downloads BOTH .onnx and .onnx.data files)\n   */\n  async ensurePhi4Model(onProgress?: (progress: DownloadProgress) => void): Promise<string> {\n    const mainFileExists = this.isModelDownloaded(this.phi4Model.localPath);\n    const dataFileExists = this.isModelDownloaded(this.phi4ModelData.localPath);\n\n    if (mainFileExists && dataFileExists) {\n      return this.phi4Model.localPath;\n    }\n\n    console.log(`üîç Phi-4-mini ONNX model not found locally`);\n    console.log(`üì• Starting automatic download...`);\n    console.log(`   This is a one-time download (~4.9GB total)`);\n    console.log(`   Model: microsoft/Phi-4-mini-instruct-onnx (INT4 quantized)`);\n    console.log(`   Files: model.onnx (~52MB) + model.onnx.data (~4.86GB)`);\n    console.log(``);\n\n    // Download main model file if missing\n    if (!mainFileExists) {\n      console.log(`üì¶ Downloading model.onnx...`);\n      await this.downloadModel(this.phi4Model, onProgress);\n      console.log(``);\n    }\n\n    // Download data file if missing\n    if (!dataFileExists) {\n      console.log(`üì¶ Downloading model.onnx.data (this is the large 4.86GB file)...`);\n      await this.downloadModel(this.phi4ModelData, onProgress);\n    }\n\n    return this.phi4Model.localPath;\n  }\n\n  /**\n   * Verify model file integrity (optional)\n   */\n  async verifyModel(modelPath: string, expectedSha256?: string): Promise<boolean> {\n    if (!expectedSha256) {\n      return true; // Skip verification if no hash provided\n    }\n\n    try {\n      const fileBuffer = readFileSync(modelPath);\n      const hash = createHash('sha256').update(fileBuffer).digest('hex');\n\n      if (hash !== expectedSha256) {\n        console.error(`‚ùå Model verification failed`);\n        console.error(`   Expected: ${expectedSha256}`);\n        console.error(`   Got:      ${hash}`);\n        return false;\n      }\n\n      console.log(`‚úÖ Model verification passed`);\n      return true;\n\n    } catch (error) {\n      console.error(`‚ùå Model verification error:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Get model info\n   */\n  getModelInfo(): ModelInfo {\n    return this.phi4Model;\n  }\n\n  /**\n   * Format download progress for display\n   */\n  static formatProgress(progress: DownloadProgress): string {\n    const mb = (bytes: number) => (bytes / (1024 * 1024)).toFixed(2);\n    return `${progress.percentage.toFixed(1)}% (${mb(progress.downloaded)}/${mb(progress.total)} MB)`;\n  }\n}\n\n/**\n * Global singleton instance\n */\nexport const modelDownloader = new ModelDownloader();\n\n/**\n * Convenience function for downloading Phi-4 model\n */\nexport async function ensurePhi4Model(\n  onProgress?: (progress: DownloadProgress) => void\n): Promise<string> {\n  return modelDownloader.ensurePhi4Model(onProgress);\n}\n"]}