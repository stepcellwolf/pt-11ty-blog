{"version":3,"file":"connection-pool.js","sourceRoot":"","sources":["../../src/utils/connection-pool.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Connection Pool for HTTP/2 and HTTP/3 Proxies\n * Provides connection reuse to reduce latency by 20-30%\n */\n\nimport http2 from 'http2';\nimport { logger } from './logger.js';\n\nexport interface PoolConfig {\n  maxSize: number;\n  maxIdleTime: number;\n  acquireTimeout: number;\n}\n\ninterface PooledConnection {\n  session: http2.ClientHttp2Session;\n  host: string;\n  busy: boolean;\n  createdAt: number;\n  lastUsed: number;\n}\n\nexport class ConnectionPool {\n  private pools: Map<string, PooledConnection[]> = new Map();\n  private config: PoolConfig;\n  private cleanupInterval: NodeJS.Timeout;\n\n  constructor(config: Partial<PoolConfig> = {}) {\n    this.config = {\n      maxSize: config.maxSize || 10,\n      maxIdleTime: config.maxIdleTime || 60000, // 60 seconds\n      acquireTimeout: config.acquireTimeout || 5000 // 5 seconds\n    };\n\n    // Cleanup expired connections every 30 seconds\n    this.cleanupInterval = setInterval(() => {\n      this.cleanup();\n    }, 30000);\n  }\n\n  async acquire(host: string): Promise<http2.ClientHttp2Session> {\n    const pool = this.pools.get(host) || [];\n    const now = Date.now();\n\n    // Find idle, non-expired connection\n    const idle = pool.find(c =>\n      !c.busy &&\n      !this.isExpired(c, now) &&\n      !c.session.closed &&\n      !c.session.destroyed\n    );\n\n    if (idle) {\n      idle.busy = true;\n      idle.lastUsed = now;\n      logger.debug('Reusing pooled connection', { host, poolSize: pool.length });\n      return idle.session;\n    }\n\n    // Create new if under limit\n    if (pool.length < this.config.maxSize) {\n      const session = await this.createConnection(host);\n      const conn: PooledConnection = {\n        session,\n        host,\n        busy: true,\n        createdAt: now,\n        lastUsed: now\n      };\n\n      pool.push(conn);\n      this.pools.set(host, pool);\n\n      logger.debug('Created new pooled connection', {\n        host,\n        poolSize: pool.length,\n        maxSize: this.config.maxSize\n      });\n\n      return session;\n    }\n\n    // Wait for available connection\n    logger.debug('Pool full, waiting for connection', { host, poolSize: pool.length });\n    return this.waitForConnection(host);\n  }\n\n  async release(session: http2.ClientHttp2Session, host: string): Promise<void> {\n    const pool = this.pools.get(host);\n    if (!pool) return;\n\n    const conn = pool.find(c => c.session === session);\n    if (conn) {\n      conn.busy = false;\n      conn.lastUsed = Date.now();\n      logger.debug('Released pooled connection', { host });\n    }\n  }\n\n  private async createConnection(host: string): Promise<http2.ClientHttp2Session> {\n    return new Promise((resolve, reject) => {\n      const session = http2.connect(host, {\n        maxSessionMemory: 10 // 10MB per session\n      });\n\n      session.once('connect', () => {\n        logger.info('HTTP/2 session connected', { host });\n        resolve(session);\n      });\n\n      session.once('error', (error) => {\n        logger.error('HTTP/2 session error', { host, error: error.message });\n        reject(error);\n      });\n\n      // Cleanup on session close\n      session.once('close', () => {\n        this.removeConnection(session, host);\n      });\n    });\n  }\n\n  private async waitForConnection(host: string): Promise<http2.ClientHttp2Session> {\n    const startTime = Date.now();\n\n    return new Promise((resolve, reject) => {\n      const checkInterval = setInterval(() => {\n        const pool = this.pools.get(host);\n        if (!pool) {\n          clearInterval(checkInterval);\n          reject(new Error('Pool disappeared'));\n          return;\n        }\n\n        const now = Date.now();\n        const available = pool.find(c =>\n          !c.busy &&\n          !this.isExpired(c, now) &&\n          !c.session.closed\n        );\n\n        if (available) {\n          clearInterval(checkInterval);\n          available.busy = true;\n          available.lastUsed = now;\n          resolve(available.session);\n          return;\n        }\n\n        if (now - startTime > this.config.acquireTimeout) {\n          clearInterval(checkInterval);\n          reject(new Error('Connection acquire timeout'));\n        }\n      }, 100); // Check every 100ms\n    });\n  }\n\n  private isExpired(conn: PooledConnection, now: number): boolean {\n    return (now - conn.lastUsed) > this.config.maxIdleTime;\n  }\n\n  private removeConnection(session: http2.ClientHttp2Session, host: string): void {\n    const pool = this.pools.get(host);\n    if (!pool) return;\n\n    const index = pool.findIndex(c => c.session === session);\n    if (index !== -1) {\n      pool.splice(index, 1);\n      logger.debug('Removed closed connection from pool', { host, poolSize: pool.length });\n    }\n\n    if (pool.length === 0) {\n      this.pools.delete(host);\n    }\n  }\n\n  private cleanup(): void {\n    const now = Date.now();\n    let removed = 0;\n\n    for (const [host, pool] of this.pools.entries()) {\n      const before = pool.length;\n\n      // Remove expired and closed connections\n      const active = pool.filter(c => {\n        if (this.isExpired(c, now) || c.session.closed || c.session.destroyed) {\n          if (!c.session.closed) {\n            c.session.close();\n          }\n          return false;\n        }\n        return true;\n      });\n\n      removed += before - active.length;\n\n      if (active.length === 0) {\n        this.pools.delete(host);\n      } else {\n        this.pools.set(host, active);\n      }\n    }\n\n    if (removed > 0) {\n      logger.debug('Cleaned up expired connections', { removed });\n    }\n  }\n\n  destroy(): void {\n    clearInterval(this.cleanupInterval);\n\n    for (const [host, pool] of this.pools.entries()) {\n      for (const conn of pool) {\n        if (!conn.session.closed) {\n          conn.session.close();\n        }\n      }\n    }\n\n    this.pools.clear();\n    logger.info('Connection pool destroyed');\n  }\n\n  getStats(): Record<string, { total: number; busy: number; idle: number }> {\n    const stats: Record<string, { total: number; busy: number; idle: number }> = {};\n\n    for (const [host, pool] of this.pools.entries()) {\n      const busy = pool.filter(c => c.busy).length;\n      stats[host] = {\n        total: pool.length,\n        busy,\n        idle: pool.length - busy\n      };\n    }\n\n    return stats;\n  }\n}\n"]}