{"version":3,"file":"agentBoosterPreprocessor.js","sourceRoot":"","sources":["../../src/utils/agentBoosterPreprocessor.ts"],"names":[],"mappings":"AAAA;;;;;GAKG;AAEH,OAAO,EAAE,QAAQ,EAAE,MAAM,eAAe,CAAC;AACzC,OAAO,EAAE,UAAU,EAAE,YAAY,EAAE,aAAa,EAAE,MAAM,IAAI,CAAC;AAC7D,OAAO,EAAE,OAAO,EAAE,MAAM,MAAM,CAAC;AAqB/B,MAAM,OAAO,wBAAwB;IAC3B,mBAAmB,CAAS;IAC5B,cAAc,CAAc;IAEpC,YAAY,UAGR,EAAE;QACJ,IAAI,CAAC,mBAAmB,GAAG,OAAO,CAAC,mBAAmB,IAAI,GAAG,CAAC;QAC9D,IAAI,CAAC,cAAc,GAAG,IAAI,GAAG,CAAC,OAAO,CAAC,cAAc,IAAI;YACtD,cAAc;YACd,WAAW;YACX,oBAAoB;YACpB,aAAa;YACb,aAAa;YACb,gBAAgB;YAChB,aAAa;SACd,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACI,YAAY,CAAC,IAAY;QAC9B,MAAM,QAAQ,GAAG;YACf;gBACE,KAAK,EAAE,sCAAsC;gBAC7C,IAAI,EAAE,cAAc;gBACpB,SAAS,EAAE,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC;aAC7C;YACD;gBACE,KAAK,EAAE,qCAAqC;gBAC5C,IAAI,EAAE,WAAW;gBACjB,SAAS,EAAE,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,IAAI,CAAC;aAC3C;YACD;gBACE,KAAK,EAAE,yBAAyB;gBAChC,IAAI,EAAE,oBAAoB;gBAC1B,SAAS,EAAE,IAAI,CAAC,uBAAuB,CAAC,IAAI,CAAC,IAAI,CAAC;aACnD;YACD;gBACE,KAAK,EAAE,qCAAqC;gBAC5C,IAAI,EAAE,aAAa;gBACnB,SAAS,EAAE,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC;aAC7C;YACD;gBACE,KAAK,EAAE,+BAA+B;gBACtC,IAAI,EAAE,aAAa;gBACnB,SAAS,EAAE,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC;aAC7C;YACD;gBACE,KAAK,EAAE,8CAA8C;gBACrD,IAAI,EAAE,gBAAgB;gBACtB,SAAS,EAAE,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,IAAI,CAAC;aAChD;SACF,CAAC;QAEF,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE,CAAC;YAC/B,IAAI,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;gBACtE,MAAM,QAAQ,GAAG,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;gBAC5C,IAAI,QAAQ,IAAI,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC;oBACrC,MAAM,YAAY,GAAG,YAAY,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;oBACrD,MAAM,UAAU,GAAG,OAAO,CAAC,SAAS,CAAC,YAAY,CAAC,CAAC;oBAEnD,IAAI,UAAU,EAAE,CAAC;wBACf,OAAO;4BACL,IAAI,EAAE,OAAO,CAAC,IAAI;4BAClB,IAAI;4BACJ,QAAQ;4BACR,YAAY;4BACZ,UAAU;4BACV,UAAU,EAAE,GAAG,CAAC,uCAAuC;yBACxD,CAAC;oBACJ,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,QAAQ,CAAC,MAAkB;QACtC,IAAI,CAAC,MAAM,CAAC,QAAQ,IAAI,CAAC,MAAM,CAAC,YAAY,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC;YACnE,OAAO;gBACL,OAAO,EAAE,KAAK;gBACd,MAAM,EAAE,cAAc;gBACtB,MAAM,EAAE,2BAA2B;aACpC,CAAC;QACJ,CAAC;QAED,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;YAEtD,MAAM,GAAG,GAAG,kDAAkD,QAAQ,EAAE,CAAC;YAEzE,IAAI,MAAc,CAAC;YACnB,IAAI,CAAC;gBACH,MAAM,GAAG,QAAQ,CAAC,GAAG,EAAE;oBACrB,QAAQ,EAAE,OAAO;oBACjB,KAAK,EAAE,IAAI,CAAC,SAAS,CAAC;wBACpB,IAAI,EAAE,MAAM,CAAC,YAAY;wBACzB,IAAI,EAAE,MAAM,CAAC,UAAU;qBACxB,CAAC;oBACF,SAAS,EAAE,EAAE,GAAG,IAAI,GAAG,IAAI;oBAC3B,OAAO,EAAE,KAAK;iBACf,CAAC,CAAC;YACL,CAAC;YAAC,OAAO,SAAc,EAAE,CAAC;gBACxB,kFAAkF;gBAClF,6BAA6B;gBAC7B,IAAI,SAAS,CAAC,MAAM,EAAE,CAAC;oBACrB,MAAM,GAAG,SAAS,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC;gBACvC,CAAC;qBAAM,CAAC;oBACN,MAAM,IAAI,KAAK,CAAC,oBAAoB,SAAS,CAAC,OAAO,EAAE,CAAC,CAAC;gBAC3D,CAAC;YACH,CAAC;YAED,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAElC,IAAI,MAAM,CAAC,OAAO,IAAI,MAAM,CAAC,UAAU,IAAI,IAAI,CAAC,mBAAmB,EAAE,CAAC;gBACpE,6CAA6C;gBAC7C,aAAa,CAAC,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;gBAE9C,OAAO;oBACL,OAAO,EAAE,IAAI;oBACb,MAAM,EAAE,eAAe;oBACvB,MAAM,EAAE,MAAM,CAAC,MAAM;oBACrB,OAAO,EAAE,MAAM,CAAC,OAAO;oBACvB,UAAU,EAAE,MAAM,CAAC,UAAU;oBAC7B,QAAQ,EAAE,MAAM,CAAC,QAAQ;iBAC1B,CAAC;YACJ,CAAC;iBAAM,CAAC;gBACN,+BAA+B;gBAC/B,OAAO;oBACL,OAAO,EAAE,KAAK;oBACd,MAAM,EAAE,cAAc;oBACtB,UAAU,EAAE,MAAM,CAAC,UAAU;oBAC7B,MAAM,EAAE,qCAAqC,CAAC,MAAM,CAAC,UAAU,GAAG,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,iCAAiC;iBACnH,CAAC;YACJ,CAAC;QACH,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACpB,OAAO;gBACL,OAAO,EAAE,KAAK;gBACd,MAAM,EAAE,cAAc;gBACtB,MAAM,EAAE,wBAAwB,KAAK,CAAC,OAAO,EAAE;aAChD,CAAC;QACJ,CAAC;IACH,CAAC;IAED;;OAEG;IACK,eAAe,CAAC,IAAY;QAClC,2DAA2D;QAC3D,MAAM,QAAQ,GAAG;YACf,oFAAoF;YACpF,wDAAwD;SACzD,CAAC;QAEF,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE,CAAC;YAC/B,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YAClC,IAAI,KAAK,EAAE,CAAC;gBACV,OAAO,KAAK,CAAC,CAAC,CAAC,CAAC;YAClB,CAAC;QACH,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,cAAc,CAAC,QAAgB;QACrC,MAAM,GAAG,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QACvC,MAAM,OAAO,GAA8B;YACzC,IAAI,EAAE,YAAY;YAClB,KAAK,EAAE,YAAY;YACnB,IAAI,EAAE,YAAY;YAClB,KAAK,EAAE,YAAY;YACnB,IAAI,EAAE,QAAQ;YACd,IAAI,EAAE,MAAM;YACZ,IAAI,EAAE,IAAI;YACV,MAAM,EAAE,MAAM;YACd,GAAG,EAAE,GAAG;YACR,KAAK,EAAE,KAAK;YACZ,GAAG,EAAE,GAAG;YACR,KAAK,EAAE,KAAK;SACb,CAAC;QACF,OAAO,OAAO,CAAC,GAAG,CAAC,IAAI,YAAY,CAAC;IACtC,CAAC;IAED;;OAEG;IACK,iBAAiB,CAAC,IAAY;QACpC,gDAAgD;QAChD,IAAI,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC;YAC1B,OAAO,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;QAC3C,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,eAAe,CAAC,IAAY;QAClC,2DAA2D;QAC3D,MAAM,eAAe,GAAG,sCAAsC,CAAC;QAE/D,IAAI,mBAAmB,GAAG,KAAK,CAAC;QAChC,IAAI,WAAW,GAAG,IAAI,CAAC;QAEvB,IAAI,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC,KAAK,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;YACpD,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;gBAC1B,mBAAmB,GAAG,IAAI,CAAC;gBAC3B,uBAAuB;gBACvB,MAAM,WAAW,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,CAAS,EAAE,EAAE;oBACtD,MAAM,OAAO,GAAG,CAAC,CAAC,IAAI,EAAE,CAAC;oBACzB,IAAI,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;wBACtC,OAAO,GAAG,OAAO,OAAO,CAAC;oBAC3B,CAAC;oBACD,OAAO,CAAC,CAAC;gBACX,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBAEd,WAAW,GAAG,WAAW,CAAC,OAAO,CAC/B,KAAK,EACL,YAAY,IAAI,IAAI,WAAW,UAAU,CAC1C,CAAC;YACJ,CAAC;YACD,OAAO,KAAK,CAAC;QACf,CAAC,CAAC,CAAC;QAEH,OAAO,mBAAmB,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC;IAClD,CAAC;IAED;;OAEG;IACK,uBAAuB,CAAC,IAAY;QAC1C,qCAAqC;QACrC,MAAM,aAAa,GAAG;YACpB,eAAe;YACf,SAAS;YACT,YAAY;SACb,CAAC;QAEF,KAAK,MAAM,OAAO,IAAI,aAAa,EAAE,CAAC;YACpC,IAAI,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC;gBACvB,0CAA0C;gBAC1C,OAAO,IAAI,CAAC;YACd,CAAC;QACH,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,iBAAiB,CAAC,IAAY;QACpC,wCAAwC;QACxC,IAAI,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC;YAC5B,0CAA0C;YAC1C,OAAO,IAAI,CAAC;QACd,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,iBAAiB,CAAC,IAAY;QACpC,0CAA0C;QAC1C,0CAA0C;QAC1C,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,oBAAoB,CAAC,IAAY;QACvC,IAAI,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE,CAAC;YAC9B,wDAAwD;YACxD,mFAAmF;YACnF,OAAO,IAAI,CAAC,OAAO,CAAC,8DAA8D,EAAE,EAAE,CAAC,CAAC;QAC1F,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;CACF","sourcesContent":["/**\n * Agent Booster Pre-Processor\n *\n * Detects code editing intents in agent tasks and attempts Agent Booster\n * pattern matching before falling back to LLM.\n */\n\nimport { execSync } from 'child_process';\nimport { existsSync, readFileSync, writeFileSync } from 'fs';\nimport { extname } from 'path';\n\nexport interface EditIntent {\n  type: string;\n  task: string;\n  filePath?: string;\n  originalCode?: string;\n  targetCode?: string;\n  confidence: number;\n}\n\nexport interface PreprocessorResult {\n  success: boolean;\n  method: 'agent_booster' | 'llm_required';\n  output?: string;\n  latency?: number;\n  confidence?: number;\n  strategy?: string;\n  reason?: string;\n}\n\nexport class AgentBoosterPreprocessor {\n  private confidenceThreshold: number;\n  private enabledIntents: Set<string>;\n\n  constructor(options: {\n    confidenceThreshold?: number;\n    enabledIntents?: string[];\n  } = {}) {\n    this.confidenceThreshold = options.confidenceThreshold || 0.7;\n    this.enabledIntents = new Set(options.enabledIntents || [\n      'var_to_const',\n      'add_types',\n      'add_error_handling',\n      'async_await',\n      'add_logging',\n      'remove_console',\n      'format_code'\n    ]);\n  }\n\n  /**\n   * Detect if a task is a code editing intent that Agent Booster can handle\n   */\n  public detectIntent(task: string): EditIntent | null {\n    const patterns = [\n      {\n        regex: /convert\\s+(all\\s+)?var\\s+to\\s+const/i,\n        type: 'var_to_const',\n        extractor: this.extractVarToConst.bind(this)\n      },\n      {\n        regex: /add\\s+type\\s+(annotations?|hints?)/i,\n        type: 'add_types',\n        extractor: this.extractAddTypes.bind(this)\n      },\n      {\n        regex: /add\\s+error\\s+handling/i,\n        type: 'add_error_handling',\n        extractor: this.extractAddErrorHandling.bind(this)\n      },\n      {\n        regex: /convert\\s+to\\s+async\\s*\\/?\\s*await/i,\n        type: 'async_await',\n        extractor: this.extractAsyncAwait.bind(this)\n      },\n      {\n        regex: /add\\s+(logging|console\\.log)/i,\n        type: 'add_logging',\n        extractor: this.extractAddLogging.bind(this)\n      },\n      {\n        regex: /remove\\s+(all\\s+)?console\\.(log|debug|warn)/i,\n        type: 'remove_console',\n        extractor: this.extractRemoveConsole.bind(this)\n      }\n    ];\n\n    for (const pattern of patterns) {\n      if (pattern.regex.test(task) && this.enabledIntents.has(pattern.type)) {\n        const filePath = this.extractFilePath(task);\n        if (filePath && existsSync(filePath)) {\n          const originalCode = readFileSync(filePath, 'utf-8');\n          const targetCode = pattern.extractor(originalCode);\n\n          if (targetCode) {\n            return {\n              type: pattern.type,\n              task,\n              filePath,\n              originalCode,\n              targetCode,\n              confidence: 0.8 // Initial confidence for pattern match\n            };\n          }\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Try to apply edit using Agent Booster\n   */\n  public async tryApply(intent: EditIntent): Promise<PreprocessorResult> {\n    if (!intent.filePath || !intent.originalCode || !intent.targetCode) {\n      return {\n        success: false,\n        method: 'llm_required',\n        reason: 'Missing file path or code'\n      };\n    }\n\n    try {\n      const language = this.detectLanguage(intent.filePath);\n\n      const cmd = `npx --yes agent-booster@0.2.2 apply --language ${language}`;\n\n      let result: string;\n      try {\n        result = execSync(cmd, {\n          encoding: 'utf-8',\n          input: JSON.stringify({\n            code: intent.originalCode,\n            edit: intent.targetCode\n          }),\n          maxBuffer: 10 * 1024 * 1024,\n          timeout: 10000\n        });\n      } catch (execError: any) {\n        // execSync throws on non-zero exit, but agent-booster returns JSON even on stderr\n        // Try to parse stdout anyway\n        if (execError.stdout) {\n          result = execError.stdout.toString();\n        } else {\n          throw new Error(`execSync failed: ${execError.message}`);\n        }\n      }\n\n      const parsed = JSON.parse(result);\n\n      if (parsed.success && parsed.confidence >= this.confidenceThreshold) {\n        // High confidence - use Agent Booster result\n        writeFileSync(intent.filePath, parsed.output);\n\n        return {\n          success: true,\n          method: 'agent_booster',\n          output: parsed.output,\n          latency: parsed.latency,\n          confidence: parsed.confidence,\n          strategy: parsed.strategy\n        };\n      } else {\n        // Low confidence - require LLM\n        return {\n          success: false,\n          method: 'llm_required',\n          confidence: parsed.confidence,\n          reason: `Agent Booster confidence too low (${(parsed.confidence * 100).toFixed(1)}%). Using LLM for complex edit.`\n        };\n      }\n    } catch (error: any) {\n      return {\n        success: false,\n        method: 'llm_required',\n        reason: `Agent Booster error: ${error.message}`\n      };\n    }\n  }\n\n  /**\n   * Extract file path from task description\n   */\n  private extractFilePath(task: string): string | null {\n    // Pattern: \"in <file>\" or \"to <file>\" or just \"<file.ext>\"\n    const patterns = [\n      /(?:in|to|from|for|file:?)\\s+([^\\s]+\\.(?:js|ts|tsx|jsx|py|rs|go|java|c|cpp|h|hpp))/i,\n      /([^\\s]+\\.(?:js|ts|tsx|jsx|py|rs|go|java|c|cpp|h|hpp))/i\n    ];\n\n    for (const pattern of patterns) {\n      const match = task.match(pattern);\n      if (match) {\n        return match[1];\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Detect programming language from file extension\n   */\n  private detectLanguage(filePath: string): string {\n    const ext = extname(filePath).slice(1);\n    const langMap: { [key: string]: string } = {\n      'ts': 'typescript',\n      'tsx': 'typescript',\n      'js': 'javascript',\n      'jsx': 'javascript',\n      'py': 'python',\n      'rs': 'rust',\n      'go': 'go',\n      'java': 'java',\n      'c': 'c',\n      'cpp': 'cpp',\n      'h': 'c',\n      'hpp': 'cpp'\n    };\n    return langMap[ext] || 'javascript';\n  }\n\n  /**\n   * Extract var to const transformation\n   */\n  private extractVarToConst(code: string): string | null {\n    // Simple transformation: replace var with const\n    if (code.includes('var ')) {\n      return code.replace(/\\bvar\\b/g, 'const');\n    }\n    return null;\n  }\n\n  /**\n   * Extract add types transformation (TypeScript)\n   */\n  private extractAddTypes(code: string): string | null {\n    // Simple type annotation: function params and return types\n    const functionPattern = /function\\s+(\\w+)\\s*\\(([^)]*)\\)\\s*\\{/g;\n\n    let hasUntypedFunctions = false;\n    let transformed = code;\n\n    code.replace(functionPattern, (match, name, params) => {\n      if (!params.includes(':')) {\n        hasUntypedFunctions = true;\n        // Add basic type hints\n        const typedParams = params.split(',').map((p: string) => {\n          const trimmed = p.trim();\n          if (trimmed && !trimmed.includes(':')) {\n            return `${trimmed}: any`;\n          }\n          return p;\n        }).join(', ');\n\n        transformed = transformed.replace(\n          match,\n          `function ${name}(${typedParams}): any {`\n        );\n      }\n      return match;\n    });\n\n    return hasUntypedFunctions ? transformed : null;\n  }\n\n  /**\n   * Extract add error handling transformation\n   */\n  private extractAddErrorHandling(code: string): string | null {\n    // Wrap risky operations in try-catch\n    const riskyPatterns = [\n      /JSON\\.parse\\(/,\n      /fetch\\(/,\n      /\\bawait\\s+/\n    ];\n\n    for (const pattern of riskyPatterns) {\n      if (pattern.test(code)) {\n        // This is complex - better handled by LLM\n        return null;\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Extract async/await transformation\n   */\n  private extractAsyncAwait(code: string): string | null {\n    // Convert .then() chains to async/await\n    if (code.includes('.then(')) {\n      // This is complex - better handled by LLM\n      return null;\n    }\n    return null;\n  }\n\n  /**\n   * Extract add logging transformation\n   */\n  private extractAddLogging(code: string): string | null {\n    // Add console.log before function returns\n    // This is complex - better handled by LLM\n    return null;\n  }\n\n  /**\n   * Extract remove console transformation\n   */\n  private extractRemoveConsole(code: string): string | null {\n    if (code.includes('console.')) {\n      // Remove console statements but preserve line structure\n      // Match optional leading whitespace, console call, and keep one newline if present\n      return code.replace(/^[ \\t]*console\\.(log|debug|warn|info|error)\\([^)]*\\);?\\s*$/gm, '');\n    }\n    return null;\n  }\n}\n"]}