{"version":3,"file":"compression-middleware.js","sourceRoot":"","sources":["../../src/utils/compression-middleware.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Compression Middleware for Proxy Responses\n * Provides 30-70% bandwidth reduction with Brotli/Gzip\n */\n\nimport { brotliCompress, gzip, constants } from 'zlib';\nimport { promisify } from 'util';\nimport { logger } from './logger.js';\n\nconst brotliCompressAsync = promisify(brotliCompress);\nconst gzipAsync = promisify(gzip);\n\nexport type CompressionEncoding = 'br' | 'gzip' | 'identity';\n\nexport interface CompressionConfig {\n  minSize: number; // Minimum size to compress (bytes)\n  level?: number; // Compression level (0-11 for Brotli, 0-9 for Gzip)\n  preferredEncoding: CompressionEncoding;\n  enableBrotli: boolean;\n  enableGzip: boolean;\n}\n\nexport interface CompressionResult {\n  compressed: Buffer;\n  encoding: CompressionEncoding;\n  originalSize: number;\n  compressedSize: number;\n  ratio: number;\n  duration: number;\n}\n\nexport class CompressionMiddleware {\n  private config: Required<CompressionConfig>;\n\n  constructor(config: Partial<CompressionConfig> = {}) {\n    this.config = {\n      minSize: config.minSize || 1024, // 1KB minimum\n      level: config.level ?? constants.BROTLI_DEFAULT_QUALITY,\n      preferredEncoding: config.preferredEncoding || 'br',\n      enableBrotli: config.enableBrotli ?? true,\n      enableGzip: config.enableGzip ?? true\n    };\n  }\n\n  /**\n   * Compress data using best available algorithm\n   */\n  async compress(\n    data: Buffer,\n    acceptedEncodings?: string\n  ): Promise<CompressionResult> {\n    const startTime = Date.now();\n    const originalSize = data.length;\n\n    // Skip compression for small payloads\n    if (originalSize < this.config.minSize) {\n      return {\n        compressed: data,\n        encoding: 'identity',\n        originalSize,\n        compressedSize: originalSize,\n        ratio: 1.0,\n        duration: 0\n      };\n    }\n\n    // Determine encoding based on accept-encoding header\n    const encoding = this.selectEncoding(acceptedEncodings);\n\n    let compressed: Buffer;\n    try {\n      switch (encoding) {\n        case 'br':\n          compressed = await this.compressBrotli(data);\n          break;\n        case 'gzip':\n          compressed = await this.compressGzip(data);\n          break;\n        default:\n          compressed = data;\n      }\n    } catch (error) {\n      logger.error('Compression failed, using uncompressed', {\n        error: (error as Error).message\n      });\n      compressed = data;\n    }\n\n    const duration = Date.now() - startTime;\n    const compressedSize = compressed.length;\n    const ratio = compressedSize / originalSize;\n\n    logger.debug('Compression complete', {\n      encoding,\n      originalSize,\n      compressedSize,\n      ratio: `${(ratio * 100).toFixed(2)}%`,\n      savings: `${((1 - ratio) * 100).toFixed(2)}%`,\n      duration\n    });\n\n    return {\n      compressed,\n      encoding,\n      originalSize,\n      compressedSize,\n      ratio,\n      duration\n    };\n  }\n\n  /**\n   * Compress using Brotli (best compression ratio)\n   */\n  private async compressBrotli(data: Buffer): Promise<Buffer> {\n    return brotliCompressAsync(data, {\n      params: {\n        [constants.BROTLI_PARAM_QUALITY]: this.config.level,\n        [constants.BROTLI_PARAM_MODE]: constants.BROTLI_MODE_TEXT\n      }\n    });\n  }\n\n  /**\n   * Compress using Gzip (faster, broader support)\n   */\n  private async compressGzip(data: Buffer): Promise<Buffer> {\n    return gzipAsync(data, {\n      level: Math.min(this.config.level, 9) // Gzip max level is 9\n    });\n  }\n\n  /**\n   * Select best encoding based on client support\n   */\n  private selectEncoding(acceptedEncodings?: string): CompressionEncoding {\n    if (!acceptedEncodings) {\n      return this.config.preferredEncoding === 'br' && this.config.enableBrotli\n        ? 'br'\n        : this.config.enableGzip\n        ? 'gzip'\n        : 'identity';\n    }\n\n    const encodings = acceptedEncodings.toLowerCase().split(',').map(e => e.trim());\n\n    // Prefer Brotli if supported and enabled\n    if (encodings.includes('br') && this.config.enableBrotli) {\n      return 'br';\n    }\n\n    // Fall back to Gzip if supported and enabled\n    if (encodings.includes('gzip') && this.config.enableGzip) {\n      return 'gzip';\n    }\n\n    return 'identity';\n  }\n\n  /**\n   * Check if compression is recommended for content type\n   */\n  shouldCompress(contentType?: string): boolean {\n    if (!contentType) return true;\n\n    const type = contentType.toLowerCase();\n\n    // Compressible types\n    const compressible = [\n      'text/',\n      'application/json',\n      'application/javascript',\n      'application/xml',\n      'application/x-www-form-urlencoded'\n    ];\n\n    return compressible.some(prefix => type.includes(prefix));\n  }\n\n  /**\n   * Get compression statistics\n   */\n  getStats(): {\n    config: Required<CompressionConfig>;\n    capabilities: {\n      brotli: boolean;\n      gzip: boolean;\n    };\n  } {\n    return {\n      config: this.config,\n      capabilities: {\n        brotli: this.config.enableBrotli,\n        gzip: this.config.enableGzip\n      }\n    };\n  }\n}\n"]}