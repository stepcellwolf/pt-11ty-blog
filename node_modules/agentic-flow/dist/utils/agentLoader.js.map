{"version":3,"file":"agentLoader.js","sourceRoot":"","sources":["../../src/utils/agentLoader.ts"],"names":[],"mappings":"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","sourcesContent":["// Agent loader for .claude/agents integration\nimport { readFileSync, readdirSync, statSync, existsSync } from 'fs';\nimport { join, extname, dirname } from 'path';\nimport { fileURLToPath } from 'url';\nimport { logger } from './logger.js';\n\n// Get the package root directory\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst packageRoot = join(__dirname, '../..');\nconst defaultAgentsDir = join(packageRoot, '.claude/agents');\n\nexport interface AgentDefinition {\n  name: string;\n  description: string;\n  systemPrompt: string;\n  color?: string;\n  tools?: string[];\n  filePath: string;\n}\n\ninterface AgentFrontmatter {\n  name: string;\n  description: string;\n  color?: string;\n  tools?: string[];\n}\n\n/**\n * Parse agent markdown file with frontmatter\n */\nfunction parseAgentFile(filePath: string): AgentDefinition | null {\n  try {\n    const content = readFileSync(filePath, 'utf-8');\n\n    // Check for frontmatter\n    const frontmatterMatch = content.match(/^---\\n([\\s\\S]*?)\\n---\\n([\\s\\S]*)$/);\n    if (!frontmatterMatch) {\n      logger.warn('Agent file missing frontmatter', { filePath });\n      return null;\n    }\n\n    const [, frontmatter, systemPrompt] = frontmatterMatch;\n\n    // Parse YAML-like frontmatter\n    const meta: Partial<AgentFrontmatter> = {};\n    frontmatter.split('\\n').forEach(line => {\n      const match = line.match(/^(\\w+):\\s*(.+)$/);\n      if (match) {\n        const [, key, value] = match;\n        // Remove quotes if present\n        const cleanValue = value.replace(/^[\"']|[\"']$/g, '');\n        if (key === 'tools') {\n          meta[key] = cleanValue.split(',').map(t => t.trim());\n        } else {\n          (meta as any)[key] = cleanValue;\n        }\n      }\n    });\n\n    if (!meta.name || !meta.description) {\n      logger.warn('Agent file missing required metadata', { filePath });\n      return null;\n    }\n\n    return {\n      name: meta.name,\n      description: meta.description,\n      systemPrompt: systemPrompt.trim(),\n      color: meta.color,\n      tools: meta.tools,\n      filePath\n    };\n  } catch (error) {\n    logger.error('Failed to parse agent file', { filePath, error });\n    return null;\n  }\n}\n\n/**\n * Recursively find all agent definition files\n */\nfunction findAgentFiles(dir: string): string[] {\n  const files: string[] = [];\n\n  try {\n    const entries = readdirSync(dir);\n\n    for (const entry of entries) {\n      const fullPath = join(dir, entry);\n      const stat = statSync(fullPath);\n\n      if (stat.isDirectory()) {\n        files.push(...findAgentFiles(fullPath));\n      } else if (extname(entry) === '.md' && entry !== 'README.md') {\n        files.push(fullPath);\n      }\n    }\n  } catch (error) {\n    logger.warn('Failed to read directory', { dir, error });\n  }\n\n  return files;\n}\n\n/**\n * Load all agents from .claude/agents directory with deduplication\n * Local agents (.claude/agents in CWD) override package agents\n */\nexport function loadAgents(agentsDir?: string): Map<string, AgentDefinition> {\n  const agents = new Map<string, AgentDefinition>();\n  const agentsByRelativePath = new Map<string, AgentDefinition>();\n\n  // If explicit directory is provided, use only that\n  if (agentsDir) {\n    logger.info('Loading agents from explicit directory', { agentsDir });\n    const agentFiles = findAgentFiles(agentsDir);\n    for (const filePath of agentFiles) {\n      const agent = parseAgentFile(filePath);\n      if (agent) {\n        agents.set(agent.name, agent);\n      }\n    }\n    return agents;\n  }\n\n  // Otherwise, load from both package and local with deduplication\n  const localAgentsDir = join(process.cwd(), '.claude/agents');\n\n  // 1. Load package agents first (if they exist)\n  if (existsSync(defaultAgentsDir)) {\n    logger.info('Loading package agents', { agentsDir: defaultAgentsDir });\n    const packageFiles = findAgentFiles(defaultAgentsDir);\n    logger.debug('Found package agent files', { count: packageFiles.length });\n\n    for (const filePath of packageFiles) {\n      const agent = parseAgentFile(filePath);\n      if (agent) {\n        const relativePath = filePath.substring(defaultAgentsDir.length + 1);\n        agentsByRelativePath.set(relativePath, agent);\n        agents.set(agent.name, agent);\n        logger.debug('Loaded package agent', { name: agent.name, path: relativePath });\n      }\n    }\n  }\n\n  // 2. Load local agents (override package agents with same relative path)\n  if (existsSync(localAgentsDir) && localAgentsDir !== defaultAgentsDir) {\n    logger.info('Loading local agents', { agentsDir: localAgentsDir });\n    const localFiles = findAgentFiles(localAgentsDir);\n    logger.debug('Found local agent files', { count: localFiles.length });\n\n    for (const filePath of localFiles) {\n      const agent = parseAgentFile(filePath);\n      if (agent) {\n        const relativePath = filePath.substring(localAgentsDir.length + 1);\n        const existingAgent = agentsByRelativePath.get(relativePath);\n\n        if (existingAgent) {\n          logger.info('Local agent overrides package agent', {\n            name: agent.name,\n            path: relativePath\n          });\n          // Remove old agent\n          agents.delete(existingAgent.name);\n        }\n\n        agentsByRelativePath.set(relativePath, agent);\n        agents.set(agent.name, agent);\n        logger.debug('Loaded local agent', { name: agent.name, path: relativePath });\n      }\n    }\n  }\n\n  logger.info('Agents loaded successfully', {\n    total: agents.size,\n    package: existsSync(defaultAgentsDir) ? findAgentFiles(defaultAgentsDir).length : 0,\n    local: existsSync(localAgentsDir) ? findAgentFiles(localAgentsDir).length : 0\n  });\n\n  return agents;\n}\n\n/**\n * Get a specific agent by name\n */\nexport function getAgent(name: string, agentsDir?: string): AgentDefinition | undefined {\n  const agents = loadAgents(agentsDir);\n  return agents.get(name);\n}\n\n/**\n * List all available agents\n */\nexport function listAgents(agentsDir?: string): AgentDefinition[] {\n  const agents = loadAgents(agentsDir);\n  return Array.from(agents.values());\n}\n"]}