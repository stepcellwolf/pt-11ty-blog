{"version":3,"file":"distill.js","sourceRoot":"","sources":["../../../src/reasoningbank/core/distill.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Memory Distillation from trajectories\n * Algorithm 3 from ReasoningBank paper\n */\n\nimport { readFileSync } from 'fs';\nimport { join, dirname } from 'path';\nimport { fileURLToPath } from 'url';\nimport { ulid } from 'ulid';\nimport { loadConfig } from '../utils/config.js';\nimport { scrubMemory } from '../utils/pii-scrubber.js';\nimport { computeEmbedding } from '../utils/embeddings.js';\nimport { ModelRouter } from '../../router/router.js';\nimport * as db from '../db/queries.js';\nimport type { Trajectory } from '../db/schema.js';\nimport type { Verdict } from './judge.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n// Initialize ModelRouter once\nlet routerInstance: ModelRouter | null = null;\nfunction getRouter(): ModelRouter {\n  if (!routerInstance) {\n    routerInstance = new ModelRouter();\n  }\n  return routerInstance;\n}\n\nexport interface DistilledMemory {\n  title: string;\n  description: string;\n  content: string;\n  tags: string[];\n  domain?: string;\n}\n\n/**\n * Distill memories from a trajectory\n */\nexport async function distillMemories(\n  trajectory: Trajectory,\n  verdict: Verdict,\n  query: string,\n  options: { taskId?: string; agentId?: string; domain?: string } = {}\n): Promise<string[]> {\n  const config = loadConfig();\n  const startTime = Date.now();\n\n  console.log(`[INFO] Distilling memories from ${verdict.label} trajectory`);\n\n  // Select appropriate prompt template\n  const templateName = verdict.label === 'Success' ? 'distill-success.json' : 'distill-failure.json';\n  const promptPath = join(__dirname, '../prompts', templateName);\n  const promptTemplate = JSON.parse(readFileSync(promptPath, 'utf-8'));\n\n  const maxItems = verdict.label === 'Success'\n    ? config.distill.max_items_success\n    : config.distill.max_items_failure;\n\n  const confidencePrior = verdict.label === 'Success'\n    ? config.distill.confidence_prior_success\n    : config.distill.confidence_prior_failure;\n\n  // Check if we have any API key configured\n  const hasApiKey = process.env.OPENROUTER_API_KEY ||\n                    process.env.ANTHROPIC_API_KEY ||\n                    process.env.GOOGLE_GEMINI_API_KEY;\n\n  if (!hasApiKey) {\n    console.warn('[WARN] No API key set (OPENROUTER_API_KEY, ANTHROPIC_API_KEY, or GOOGLE_GEMINI_API_KEY), using template-based distillation');\n    return templateBasedDistill(trajectory, verdict, query, options);\n  }\n\n  try {\n    // Format trajectory\n    const trajectoryText = JSON.stringify(trajectory.steps || [], null, 2);\n\n    // Build prompt\n    const prompt = promptTemplate.template\n      .replace('{{task_query}}', query)\n      .replace('{{trajectory}}', trajectoryText)\n      .replace('{{max_items}}', String(maxItems));\n\n    // Use ModelRouter for multi-provider support\n    const router = getRouter();\n    const response = await router.chat({\n      model: config.distill.model || config.judge.model,\n      messages: [\n        { role: 'system', content: promptTemplate.system },\n        { role: 'user', content: prompt }\n      ],\n      temperature: config.distill.temperature || 0.3,\n      maxTokens: config.distill.max_tokens || 2048\n    }, 'reasoningbank-distill');\n\n    // Extract content from router response\n    const content = response.content\n      .filter(block => block.type === 'text')\n      .map(block => block.text)\n      .join('\\n');\n\n    // Parse memories from response\n    const distilled = parseDistilledMemories(content);\n\n    // Store memories in database\n    const memoryIds = await storeMemories(\n      distilled,\n      confidencePrior,\n      verdict,\n      options\n    );\n\n    const duration = Date.now() - startTime;\n    console.log(`[INFO] Distilled ${memoryIds.length} memories in ${duration}ms`);\n    db.logMetric('rb.distill.latency_ms', duration);\n    db.logMetric('rb.distill.yield', memoryIds.length);\n\n    return memoryIds;\n  } catch (error) {\n    console.error('[ERROR] Distillation failed:', error);\n    return templateBasedDistill(trajectory, verdict, query, options);\n  }\n}\n\n/**\n * Parse distilled memories from LLM response\n */\nfunction parseDistilledMemories(content: string): DistilledMemory[] {\n  try {\n    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      const parsed = JSON.parse(jsonMatch[0]);\n      return parsed.memories || [];\n    }\n  } catch (error) {\n    console.warn('[WARN] Failed to parse distilled memories JSON');\n  }\n\n  return [];\n}\n\n/**\n * Store memories in database\n */\nasync function storeMemories(\n  memories: DistilledMemory[],\n  confidencePrior: number,\n  verdict: Verdict,\n  options: { taskId?: string; agentId?: string; domain?: string }\n): Promise<string[]> {\n  const memoryIds: string[] = [];\n\n  for (const mem of memories) {\n    // Scrub PII\n    const scrubbed = scrubMemory(mem);\n\n    // Generate embedding\n    const embedding = await computeEmbedding(\n      `${scrubbed.title} ${scrubbed.description} ${scrubbed.content}`\n    );\n\n    // Create memory ID\n    const id = ulid();\n\n    // Store memory\n    db.upsertMemory({\n      id,\n      type: 'reasoning_memory',\n      pattern_data: {\n        title: scrubbed.title,\n        description: scrubbed.description,\n        content: scrubbed.content,\n        source: {\n          task_id: options.taskId || 'unknown',\n          agent_id: options.agentId || 'unknown',\n          outcome: verdict.label,\n          evidence: []\n        },\n        tags: scrubbed.tags,\n        domain: options.domain || scrubbed.domain,\n        created_at: new Date().toISOString(),\n        confidence: confidencePrior,\n        n_uses: 0\n      },\n      confidence: confidencePrior,\n      usage_count: 0\n    });\n\n    // Store embedding\n    db.upsertEmbedding({\n      id,\n      model: 'distill-' + verdict.label.toLowerCase(),\n      dims: embedding.length,\n      vector: embedding,\n      created_at: new Date().toISOString()\n    });\n\n    memoryIds.push(id);\n    console.log(`[INFO] Stored memory: ${scrubbed.title}`);\n  }\n\n  return memoryIds;\n}\n\n/**\n * Template-based distillation (fallback)\n * Simple extraction without LLM\n */\nfunction templateBasedDistill(\n  trajectory: Trajectory,\n  verdict: Verdict,\n  query: string,\n  options: any\n): string[] {\n  console.log('[INFO] Using template-based distillation (no API key)');\n\n  // Create a single generic memory from the trajectory\n  const memory: DistilledMemory = {\n    title: `${verdict.label}: ${query.substring(0, 50)}`,\n    description: `Task outcome: ${verdict.label}`,\n    content: `Query: ${query}\\n\\nSteps: ${trajectory.steps?.length || 0}\\n\\nOutcome: ${verdict.label}`,\n    tags: [verdict.label.toLowerCase(), 'template'],\n    domain: options.domain\n  };\n\n  // Store synchronously (no async needed for template)\n  return []; // Skip storage for template-based (would need to make this async)\n}\n"]}