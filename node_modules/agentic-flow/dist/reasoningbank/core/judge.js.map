{"version":3,"file":"judge.js","sourceRoot":"","sources":["../../../src/reasoningbank/core/judge.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * LLM-as-Judge for trajectory evaluation\n * Algorithm 2 from ReasoningBank paper\n */\n\nimport { readFileSync } from 'fs';\nimport { join, dirname } from 'path';\nimport { fileURLToPath } from 'url';\nimport { loadConfig } from '../utils/config.js';\nimport { ModelRouter } from '../../router/router.js';\nimport type { Trajectory } from '../db/schema.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n// Initialize ModelRouter once\nlet routerInstance: ModelRouter | null = null;\nfunction getRouter(): ModelRouter {\n  if (!routerInstance) {\n    routerInstance = new ModelRouter();\n  }\n  return routerInstance;\n}\n\nexport interface Verdict {\n  label: 'Success' | 'Failure';\n  confidence: number;\n  reasons: string[];\n}\n\n/**\n * Judge a task trajectory using LLM evaluation\n */\nexport async function judgeTrajectory(\n  trajectory: Trajectory,\n  query: string,\n  options: { useCache?: boolean } = {}\n): Promise<Verdict> {\n  const config = loadConfig();\n  const startTime = Date.now();\n\n  console.log(`[INFO] Judging trajectory for query: ${query.substring(0, 100)}...`);\n\n  // Load judge prompt template (relative to this file)\n  const promptPath = join(__dirname, '../prompts/judge.json');\n  const promptTemplate = JSON.parse(readFileSync(promptPath, 'utf-8'));\n\n  // Format trajectory for judgment\n  const trajectoryText = formatTrajectory(trajectory);\n\n  // Check if we have any API key configured\n  const hasApiKey = process.env.OPENROUTER_API_KEY ||\n                    process.env.ANTHROPIC_API_KEY ||\n                    process.env.GOOGLE_GEMINI_API_KEY;\n\n  if (!hasApiKey) {\n    console.warn('[WARN] No API key set (OPENROUTER_API_KEY, ANTHROPIC_API_KEY, or GOOGLE_GEMINI_API_KEY), using heuristic judgment');\n    return heuristicJudge(trajectory, query);\n  }\n\n  try {\n    // Call LLM API with judge prompt using ModelRouter\n    const prompt = promptTemplate.template\n      .replace('{{task_query}}', query)\n      .replace('{{trajectory}}', trajectoryText);\n\n    const router = getRouter();\n    const response = await router.chat({\n      model: config.judge.model,\n      messages: [\n        { role: 'system', content: promptTemplate.system },\n        { role: 'user', content: prompt }\n      ],\n      temperature: config.judge.temperature,\n      maxTokens: config.judge.max_tokens\n    }, 'reasoningbank-judge');\n\n    // Extract content from router response\n    const content = response.content\n      .filter(block => block.type === 'text')\n      .map(block => block.text)\n      .join('\\n');\n\n    // Parse JSON response\n    const verdict = parseVerdict(content);\n\n    const duration = Date.now() - startTime;\n    console.log(`[INFO] Judgment complete: ${verdict.label} (${verdict.confidence}) in ${duration}ms`);\n    db.logMetric('rb.judge.latency_ms', duration);\n    db.logMetric('rb.judge.success_rate', verdict.label === 'Success' ? 1 : 0);\n\n    return verdict;\n  } catch (error) {\n    console.error('[ERROR] Judge failed:', error);\n    console.warn('[WARN] Falling back to heuristic judgment');\n    return heuristicJudge(trajectory, query);\n  }\n}\n\n/**\n * Format trajectory for LLM consumption\n */\nfunction formatTrajectory(trajectory: Trajectory): string {\n  const steps = trajectory.steps || [];\n  let formatted = '';\n\n  for (let i = 0; i < steps.length; i++) {\n    formatted += `Step ${i + 1}: ${JSON.stringify(steps[i], null, 2)}\\n\\n`;\n  }\n\n  return formatted || 'No steps recorded';\n}\n\n/**\n * Parse verdict from LLM response\n */\nfunction parseVerdict(content: string): Verdict {\n  try {\n    // Try to extract JSON from response\n    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      const parsed = JSON.parse(jsonMatch[0]);\n      return {\n        label: parsed.verdict?.label || parsed.label || 'Failure',\n        confidence: parsed.verdict?.confidence || parsed.confidence || 0.5,\n        reasons: parsed.verdict?.reasons || parsed.reasons || []\n      };\n    }\n  } catch (error) {\n    console.warn('[WARN] Failed to parse verdict JSON, using text analysis');\n  }\n\n  // Fallback: text-based detection\n  const lower = content.toLowerCase();\n  const isSuccess = lower.includes('success') && !lower.includes('failure');\n\n  return {\n    label: isSuccess ? 'Success' : 'Failure',\n    confidence: 0.6,\n    reasons: ['Parsed from text (JSON parse failed)']\n  };\n}\n\n/**\n * Heuristic judgment when LLM is unavailable\n * Simple rule-based classification\n */\nfunction heuristicJudge(trajectory: Trajectory, query: string): Verdict {\n  const steps = trajectory.steps || [];\n\n  // Check for error indicators\n  const hasErrors = steps.some(step =>\n    JSON.stringify(step).toLowerCase().includes('error')\n  );\n\n  // Check for completion indicators\n  const hasCompletion = steps.some(step =>\n    JSON.stringify(step).toLowerCase().includes('complete')\n  );\n\n  // Simple heuristic: success if no errors and has completion markers\n  const isSuccess = !hasErrors && hasCompletion && steps.length > 0;\n\n  return {\n    label: isSuccess ? 'Success' : 'Failure',\n    confidence: 0.5, // Low confidence for heuristic\n    reasons: [\n      `Heuristic judgment (no API key)`,\n      `Steps: ${steps.length}`,\n      `Errors: ${hasErrors}`,\n      `Completion markers: ${hasCompletion}`\n    ]\n  };\n}\n\n// Import db late to avoid circular dependency\nimport * as db from '../db/queries.js';\n"]}