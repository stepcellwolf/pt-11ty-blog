{"version":3,"file":"retrieve.js","sourceRoot":"","sources":["../../../src/reasoningbank/core/retrieve.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Memory Retrieval with MMR diversity\n * Algorithm 1 from ReasoningBank paper\n */\n\nimport { computeEmbedding } from '../utils/embeddings.js';\nimport { mmrSelection, cosineSimilarity } from '../utils/mmr.js';\nimport * as db from '../db/queries.js';\nimport { loadConfig } from '../utils/config.js';\n\nexport interface RetrievedMemory {\n  id: string;\n  title: string;\n  description: string;\n  content: string;\n  score: number;\n  components: {\n    similarity: number;\n    recency: number;\n    reliability: number;\n  };\n}\n\n/**\n * Retrieve top-k memories with MMR diversity\n *\n * Scoring formula: score = α·sim + β·recency + γ·reliability\n * Where:\n * - sim: cosine similarity to query\n * - recency: exp(-age_days / half_life)\n * - reliability: min(confidence, 1.0)\n */\nexport async function retrieveMemories(\n  query: string,\n  options: { k?: number; domain?: string; agent?: string } = {}\n): Promise<RetrievedMemory[]> {\n  const config = loadConfig();\n  const k = options.k || config.retrieve.k;\n  const startTime = Date.now();\n\n  console.log(`[INFO] Retrieving memories for query: ${query.substring(0, 100)}...`);\n\n  // 1. Embed query\n  const queryEmbed = await computeEmbedding(query);\n\n  // 2. Fetch candidates from database\n  const candidates = db.fetchMemoryCandidates({\n    domain: options.domain,\n    agent: options.agent,\n    minConfidence: config.retrieve.min_score\n  });\n\n  if (candidates.length === 0) {\n    console.log('[INFO] No memory candidates found');\n    return [];\n  }\n\n  console.log(`[INFO] Found ${candidates.length} candidates`);\n\n  // 3. Score each candidate with 4-factor model\n  const scored = candidates.map(item => {\n    const similarity = cosineSimilarity(queryEmbed, item.embedding);\n    const recency = Math.exp(-item.age_days / config.retrieve.recency_half_life_days);\n    const reliability = Math.min(item.confidence, 1.0);\n\n    const baseScore =\n      config.retrieve.alpha * similarity +\n      config.retrieve.beta * recency +\n      config.retrieve.gamma * reliability;\n\n    return {\n      ...item,\n      score: baseScore,\n      components: { similarity, recency, reliability }\n    };\n  });\n\n  // 4. MMR selection for diversity\n  const selected = mmrSelection(scored, queryEmbed, k, config.retrieve.delta);\n\n  // 5. Record usage for selected memories\n  for (const mem of selected) {\n    db.incrementUsage(mem.id);\n  }\n\n  const duration = Date.now() - startTime;\n  console.log(`[INFO] Retrieval complete: ${selected.length} memories in ${duration}ms`);\n  db.logMetric('rb.retrieve.latency_ms', duration);\n\n  return selected.map(item => ({\n    id: item.id,\n    title: item.pattern_data.title,\n    description: item.pattern_data.description,\n    content: item.pattern_data.content,\n    score: item.score,\n    components: item.components\n  }));\n}\n\n/**\n * Format memories for injection into system prompt\n */\nexport function formatMemoriesForPrompt(memories: RetrievedMemory[]): string {\n  if (memories.length === 0) {\n    return '';\n  }\n\n  let formatted = '\\n## Relevant Memories from Past Experience\\n\\n';\n\n  for (let i = 0; i < memories.length; i++) {\n    const mem = memories[i];\n    formatted += `### Memory ${i + 1}: ${mem.title}\\n\\n`;\n    formatted += `${mem.description}\\n\\n`;\n    formatted += `**Strategy:**\\n${mem.content}\\n\\n`;\n    formatted += `*Confidence: ${(mem.score * 100).toFixed(1)}% | `;\n    formatted += `Similarity: ${(mem.components.similarity * 100).toFixed(1)}%*\\n\\n`;\n    formatted += '---\\n\\n';\n  }\n\n  return formatted;\n}\n"]}