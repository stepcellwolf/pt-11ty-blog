{"version":3,"file":"mmr.js","sourceRoot":"","sources":["../../../src/reasoningbank/utils/mmr.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Maximal Marginal Relevance (MMR) for diversity in retrieval\n * Balances relevance and diversity in top-k selection\n */\n\n/**\n * Cosine similarity between two vectors\n */\nfunction cosineSimilarity(a: Float32Array, b: Float32Array): number {\n  if (a.length !== b.length) {\n    throw new Error(`Vector dimension mismatch: ${a.length} vs ${b.length}`);\n  }\n\n  let dot = 0, magA = 0, magB = 0;\n  for (let i = 0; i < a.length; i++) {\n    dot += a[i] * b[i];\n    magA += a[i] * a[i];\n    magB += b[i] * b[i];\n  }\n\n  const denominator = Math.sqrt(magA) * Math.sqrt(magB);\n  if (denominator === 0) return 0;\n\n  return dot / denominator;\n}\n\n/**\n * MMR selection for diversity-aware top-k retrieval\n *\n * @param candidates - Scored candidates with embeddings\n * @param queryEmbed - Query embedding for relevance scoring\n * @param k - Number of items to select\n * @param lambda - Balance between relevance (1.0) and diversity (0.0)\n * @returns Selected items with maximum marginal relevance\n */\nexport function mmrSelection<T extends { score: number; embedding: Float32Array }>(\n  candidates: T[],\n  queryEmbed: Float32Array,\n  k: number,\n  lambda: number = 0.5\n): T[] {\n  if (candidates.length === 0) return [];\n  if (k <= 0) return [];\n  if (k >= candidates.length) return [...candidates];\n\n  const selected: T[] = [];\n  const remaining = [...candidates].sort((a, b) => b.score - a.score);\n\n  while (selected.length < k && remaining.length > 0) {\n    let bestIdx = 0;\n    let bestScore = -Infinity;\n\n    for (let i = 0; i < remaining.length; i++) {\n      const item = remaining[i];\n\n      // Calculate max similarity to already selected items\n      let maxSimilarity = 0;\n      for (const sel of selected) {\n        const sim = cosineSimilarity(item.embedding, sel.embedding);\n        maxSimilarity = Math.max(maxSimilarity, sim);\n      }\n\n      // MMR score balances relevance and diversity\n      const mmrScore = lambda * item.score - (1 - lambda) * maxSimilarity;\n\n      if (mmrScore > bestScore) {\n        bestScore = mmrScore;\n        bestIdx = i;\n      }\n    }\n\n    selected.push(remaining[bestIdx]);\n    remaining.splice(bestIdx, 1);\n  }\n\n  return selected;\n}\n\nexport { cosineSimilarity };\n"]}