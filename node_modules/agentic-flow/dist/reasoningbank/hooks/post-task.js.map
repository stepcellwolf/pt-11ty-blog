{"version":3,"file":"post-task.js","sourceRoot":"","sources":["../../../src/reasoningbank/hooks/post-task.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env node\n/**\n * Post-Task Hook for ReasoningBank\n * Judges trajectory, distills memories, and runs consolidation\n *\n * Usage: tsx hooks/post-task.ts --task-id <id> [--trajectory-file <file>]\n */\n\nimport { readFileSync } from 'fs';\nimport { judgeTrajectory } from '../core/judge.js';\nimport { distillMemories } from '../core/distill.js';\nimport { consolidate, shouldConsolidate } from '../core/consolidate.js';\nimport { loadConfig } from '../utils/config.js';\nimport type { Trajectory } from '../db/schema.js';\n\n// Parse command line arguments\nfunction parseArgs(): { taskId: string; trajectoryFile?: string } {\n  const args = process.argv.slice(2);\n  const parsed: any = {};\n\n  for (let i = 0; i < args.length; i += 2) {\n    const key = args[i].replace(/^--/, '');\n    const value = args[i + 1];\n    if (key === 'task-id') parsed.taskId = value;\n    else if (key === 'trajectory-file') parsed.trajectoryFile = value;\n  }\n\n  if (!parsed.taskId) {\n    console.error('Usage: post-task.ts --task-id <id> [--trajectory-file <file>]');\n    process.exit(1);\n  }\n\n  return parsed;\n}\n\n// Load trajectory from file or stdin\nfunction loadTrajectory(filePath?: string): { trajectory: Trajectory; query: string } {\n  let content: string;\n\n  if (filePath) {\n    content = readFileSync(filePath, 'utf-8');\n  } else {\n    // Read from stdin (for piped input)\n    content = readFileSync(0, 'utf-8');\n  }\n\n  try {\n    const data = JSON.parse(content);\n    return {\n      trajectory: {\n        steps: data.steps || data.trajectory?.steps || [],\n        metadata: data.metadata || {}\n      },\n      query: data.query || data.task_query || 'Unknown task'\n    };\n  } catch (error) {\n    console.error('[POST-TASK ERROR] Failed to parse trajectory JSON:', error);\n    process.exit(1);\n  }\n}\n\nasync function main() {\n  const config = loadConfig();\n\n  // Check if ReasoningBank is enabled\n  if (!config.features?.enable_post_task_hook) {\n    console.log('[INFO] ReasoningBank post-task hook is disabled');\n    process.exit(0);\n  }\n\n  const args = parseArgs();\n\n  console.log(`[POST-TASK] Task ID: ${args.taskId}`);\n\n  try {\n    // Load trajectory\n    const { trajectory, query } = loadTrajectory(args.trajectoryFile);\n\n    console.log(`[POST-TASK] Query: ${query}`);\n    console.log(`[POST-TASK] Trajectory steps: ${trajectory.steps.length}`);\n\n    // Step 1: Judge trajectory\n    console.log('[POST-TASK] Judging trajectory...');\n    const verdict = await judgeTrajectory(trajectory, query);\n\n    console.log(`[POST-TASK] Verdict: ${verdict.label} (confidence: ${verdict.confidence})`);\n    console.log(`[POST-TASK] Reasons: ${verdict.reasons.join(', ')}`);\n\n    // Step 2: Distill memories\n    console.log('[POST-TASK] Distilling memories...');\n    const memoryIds = await distillMemories(trajectory, verdict, query, {\n      taskId: args.taskId,\n      agentId: 'unknown', // Could be passed as argument\n      domain: undefined   // Could be extracted from query/trajectory\n    });\n\n    console.log(`[POST-TASK] Distilled ${memoryIds.length} memories`);\n\n    // Step 3: Check if consolidation should run\n    if (shouldConsolidate()) {\n      console.log('[POST-TASK] Consolidation threshold reached, running consolidation...');\n      const result = await consolidate();\n\n      console.log(`[POST-TASK] Consolidation complete:`);\n      console.log(`  - Processed: ${result.itemsProcessed} memories`);\n      console.log(`  - Duplicates: ${result.duplicatesFound}`);\n      console.log(`  - Contradictions: ${result.contradictionsFound}`);\n      console.log(`  - Pruned: ${result.itemsPruned}`);\n      console.log(`  - Duration: ${result.durationMs}ms`);\n    } else {\n      console.log('[POST-TASK] Consolidation threshold not reached, skipping');\n    }\n\n    // Output summary\n    console.log('\\n=== POST-TASK SUMMARY ===');\n    console.log(`Verdict: ${verdict.label}`);\n    console.log(`Memories distilled: ${memoryIds.length}`);\n    console.log('=== END SUMMARY ===\\n');\n\n    process.exit(0);\n  } catch (error) {\n    console.error('[POST-TASK ERROR]', error);\n    process.exit(1);\n  }\n}\n\nmain();\n"]}