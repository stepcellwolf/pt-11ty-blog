{"version":3,"file":"test-validation.js","sourceRoot":"","sources":["../../src/reasoningbank/test-validation.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env node\n/**\n * ReasoningBank Validation Test\n * Tests database queries, core algorithms, and integration\n */\n\nimport { getDb, fetchMemoryCandidates, upsertMemory, upsertEmbedding, incrementUsage, logMetric } from './db/queries.js';\nimport type { ReasoningMemory } from './db/schema.js';\nimport { ulid } from 'ulid';\n\nconsole.log('üß™ ReasoningBank Validation Test\\n');\n\n// Test 1: Database Connection\nconsole.log('1Ô∏è‚É£ Testing database connection...');\ntry {\n  const db = getDb();\n  console.log('   ‚úÖ Database connected successfully');\n} catch (error) {\n  console.error('   ‚ùå Database connection failed:', error);\n  process.exit(1);\n}\n\n// Test 2: Schema Verification\nconsole.log('\\n2Ô∏è‚É£ Verifying database schema...');\ntry {\n  const db = getDb();\n  const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\").all() as { name: string }[];\n  const views = db.prepare(\"SELECT name FROM sqlite_master WHERE type='view' ORDER BY name\").all() as { name: string }[];\n\n  console.log('   Tables:', tables.map(t => t.name).join(', '));\n  console.log('   Views:', views.map(v => v.name).join(', '));\n\n  const requiredTables = ['patterns', 'pattern_embeddings', 'pattern_links', 'task_trajectories', 'matts_runs', 'consolidation_runs'];\n  const missingTables = requiredTables.filter(t => !tables.some(table => table.name === t));\n\n  if (missingTables.length > 0) {\n    console.error('   ‚ùå Missing tables:', missingTables);\n    process.exit(1);\n  }\n\n  console.log('   ‚úÖ All required tables present');\n} catch (error) {\n  console.error('   ‚ùå Schema verification failed:', error);\n  process.exit(1);\n}\n\n// Test 3: Insert Mock Memory\nconsole.log('\\n3Ô∏è‚É£ Testing memory insertion...');\ntry {\n  const memoryId = ulid();\n  const mockMemory: Omit<ReasoningMemory, 'created_at' | 'last_used'> = {\n    id: memoryId,\n    type: 'reasoning_memory',\n    pattern_data: {\n      title: 'Test CSRF Token Handling',\n      description: 'Always extract CSRF tokens before form submission',\n      content: '1) Check for CSRF token in meta tags, form inputs, or cookies. 2) Include token in request headers or form data. 3) Verify token extraction succeeded before submission.',\n      source: {\n        task_id: 'test_task_001',\n        agent_id: 'test_agent',\n        outcome: 'Success',\n        evidence: ['step_1', 'step_2']\n      },\n      tags: ['csrf', 'web', 'security', 'test'],\n      domain: 'test.domain',\n      created_at: new Date().toISOString(),\n      confidence: 0.85,\n      n_uses: 0\n    },\n    confidence: 0.85,\n    usage_count: 0\n  };\n\n  upsertMemory(mockMemory);\n  console.log('   ‚úÖ Memory inserted successfully:', memoryId);\n\n  // Insert embedding\n  const mockEmbedding = new Float32Array(1024);\n  for (let i = 0; i < 1024; i++) {\n    mockEmbedding[i] = Math.sin(i * 0.01) * 0.1;\n  }\n\n  upsertEmbedding({\n    id: memoryId,\n    model: 'test-model',\n    dims: 1024,\n    vector: mockEmbedding,\n    created_at: new Date().toISOString()\n  });\n\n  console.log('   ‚úÖ Embedding inserted successfully');\n} catch (error) {\n  console.error('   ‚ùå Memory insertion failed:', error);\n  process.exit(1);\n}\n\n// Test 4: Fetch Memory Candidates\nconsole.log('\\n4Ô∏è‚É£ Testing memory retrieval...');\ntry {\n  const candidates = fetchMemoryCandidates({\n    domain: 'test.domain',\n    minConfidence: 0.5\n  });\n\n  console.log(`   ‚úÖ Retrieved ${candidates.length} candidate(s)`);\n\n  if (candidates.length > 0) {\n    const first = candidates[0];\n    console.log('   Sample memory:');\n    console.log('     - Title:', first.pattern_data.title);\n    console.log('     - Confidence:', first.confidence);\n    console.log('     - Age (days):', first.age_days);\n    console.log('     - Embedding dims:', first.embedding.length);\n  }\n} catch (error) {\n  console.error('   ‚ùå Memory retrieval failed:', error);\n  process.exit(1);\n}\n\n// Test 5: Usage Tracking\nconsole.log('\\n5Ô∏è‚É£ Testing usage tracking...');\ntry {\n  const candidates = fetchMemoryCandidates({ minConfidence: 0.5 });\n  if (candidates.length > 0) {\n    const memoryId = candidates[0].id;\n    const beforeCount = candidates[0].usage_count;\n\n    incrementUsage(memoryId);\n\n    const afterCandidates = fetchMemoryCandidates({ minConfidence: 0.5 });\n    const afterCount = afterCandidates.find(c => c.id === memoryId)?.usage_count || 0;\n\n    console.log(`   ‚úÖ Usage count: ${beforeCount} ‚Üí ${afterCount}`);\n  } else {\n    console.log('   ‚ö†Ô∏è  No candidates to test usage tracking');\n  }\n} catch (error) {\n  console.error('   ‚ùå Usage tracking failed:', error);\n  process.exit(1);\n}\n\n// Test 6: Metrics Logging\nconsole.log('\\n6Ô∏è‚É£ Testing metrics logging...');\ntry {\n  logMetric('rb.test.validation', 1.0);\n  logMetric('rb.retrieve.latency_ms', 42);\n\n  const db = getDb();\n  const metrics = db.prepare(`\n    SELECT metric_name, value\n    FROM performance_metrics\n    WHERE metric_name LIKE 'rb.%'\n    ORDER BY timestamp DESC\n    LIMIT 5\n  `).all();\n\n  console.log(`   ‚úÖ Logged ${metrics.length} metric(s)`);\n  metrics.forEach((m: any) => {\n    console.log(`     - ${m.metric_name}: ${m.value}`);\n  });\n} catch (error) {\n  console.error('   ‚ùå Metrics logging failed:', error);\n  process.exit(1);\n}\n\n// Test 7: Views\nconsole.log('\\n7Ô∏è‚É£ Testing database views...');\ntry {\n  const db = getDb();\n\n  const activeMemories = db.prepare('SELECT COUNT(*) as count FROM v_active_memories').get() as { count: number };\n  console.log('   ‚úÖ v_active_memories:', activeMemories.count, 'memories');\n\n  const contradictions = db.prepare('SELECT COUNT(*) as count FROM v_memory_contradictions').get() as { count: number };\n  console.log('   ‚úÖ v_memory_contradictions:', contradictions.count, 'contradictions');\n\n  const agentPerf = db.prepare('SELECT COUNT(*) as count FROM v_agent_performance').get() as { count: number };\n  console.log('   ‚úÖ v_agent_performance:', agentPerf.count, 'agents');\n} catch (error) {\n  console.error('   ‚ùå Views test failed:', error);\n  process.exit(1);\n}\n\nconsole.log('\\n‚úÖ All validation tests passed!\\n');\nconsole.log('üìä Summary:');\nconsole.log('   ‚úì Database connection');\nconsole.log('   ‚úì Schema verification');\nconsole.log('   ‚úì Memory insertion');\nconsole.log('   ‚úì Memory retrieval');\nconsole.log('   ‚úì Usage tracking');\nconsole.log('   ‚úì Metrics logging');\nconsole.log('   ‚úì Database views');\nconsole.log('\\nüöÄ ReasoningBank is production-ready!\\n');\n"]}