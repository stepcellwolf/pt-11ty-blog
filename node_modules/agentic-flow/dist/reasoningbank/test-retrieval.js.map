{"version":3,"file":"test-retrieval.js","sourceRoot":"","sources":["../../src/reasoningbank/test-retrieval.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env node\n/**\n * Test ReasoningBank retrieval algorithm with MMR\n */\n\nimport { getDb, upsertMemory, upsertEmbedding, fetchMemoryCandidates } from './db/queries.js';\nimport { loadConfig } from './utils/config.js';\nimport type { ReasoningMemory } from './db/schema.js';\nimport { ulid } from 'ulid';\n\nconsole.log('üß™ Testing ReasoningBank Retrieval Algorithm\\n');\n\n// Helper to create synthetic embedding\nfunction createEmbedding(seed: number, dims: number = 1024): Float32Array {\n  const vec = new Float32Array(dims);\n  for (let i = 0; i < dims; i++) {\n    vec[i] = Math.sin(seed * (i + 1) * 0.01) * 0.1 + Math.cos(seed * i * 0.02) * 0.05;\n  }\n  // Normalize\n  let mag = 0;\n  for (let i = 0; i < dims; i++) mag += vec[i] * vec[i];\n  mag = Math.sqrt(mag);\n  for (let i = 0; i < dims; i++) vec[i] /= mag;\n  return vec;\n}\n\n// Insert test memories\nconsole.log('1Ô∏è‚É£ Inserting test memories...');\n\nconst testMemories = [\n  {\n    title: 'CSRF Token Handling',\n    description: 'Extract and include CSRF tokens in form submissions',\n    content: '1) Check for CSRF token in meta tags or form inputs. 2) Include in request. 3) Verify before submit.',\n    tags: ['csrf', 'web', 'security'],\n    domain: 'test.web',\n    confidence: 0.88,\n    seed: 42\n  },\n  {\n    title: 'Authentication Cookie Validation',\n    description: 'Always validate auth cookies before protected requests',\n    content: '1) Check for auth cookie. 2) Validate expiry. 3) Refresh if needed.',\n    tags: ['auth', 'cookies', 'security'],\n    domain: 'test.web',\n    confidence: 0.82,\n    seed: 123\n  },\n  {\n    title: 'API Rate Limiting Backoff',\n    description: 'Implement exponential backoff for rate-limited APIs',\n    content: '1) Detect 429 status. 2) Parse Retry-After header. 3) Exponential backoff.',\n    tags: ['api', 'rate-limit', 'retry'],\n    domain: 'test.api',\n    confidence: 0.91,\n    seed: 456\n  },\n  {\n    title: 'Form Validation Before Submit',\n    description: 'Validate all form fields before submission to avoid errors',\n    content: '1) Check required fields. 2) Validate formats. 3) Show inline errors.',\n    tags: ['forms', 'validation', 'web'],\n    domain: 'test.web',\n    confidence: 0.75,\n    seed: 789\n  },\n  {\n    title: 'Database Transaction Retry Logic',\n    description: 'Retry failed transactions with proper isolation levels',\n    content: '1) Begin transaction. 2) Execute queries. 3) Retry on deadlock.',\n    tags: ['database', 'transactions', 'retry'],\n    domain: 'test.db',\n    confidence: 0.86,\n    seed: 101\n  }\n];\n\nfor (const mem of testMemories) {\n  const id = ulid();\n  const memory: Omit<ReasoningMemory, 'created_at' | 'last_used'> = {\n    id,\n    type: 'reasoning_memory',\n    pattern_data: {\n      title: mem.title,\n      description: mem.description,\n      content: mem.content,\n      source: {\n        task_id: 'test_task',\n        agent_id: 'test_agent',\n        outcome: 'Success',\n        evidence: ['step_1']\n      },\n      tags: mem.tags,\n      domain: mem.domain,\n      created_at: new Date().toISOString(),\n      confidence: mem.confidence,\n      n_uses: 0\n    },\n    confidence: mem.confidence,\n    usage_count: 0\n  };\n\n  upsertMemory(memory);\n  upsertEmbedding({\n    id,\n    model: 'test-model',\n    dims: 1024,\n    vector: createEmbedding(mem.seed),\n    created_at: new Date().toISOString()\n  });\n}\n\nconsole.log(`   ‚úÖ Inserted ${testMemories.length} test memories\\n`);\n\n// Test retrieval\nconsole.log('2Ô∏è‚É£ Testing retrieval with different queries...\\n');\n\nconst queries = [\n  {\n    query: 'How to handle CSRF tokens in web forms?',\n    expectedTitles: ['CSRF Token Handling', 'Form Validation Before Submit'],\n    domain: 'test.web'\n  },\n  {\n    query: 'API rate limiting and retry strategies',\n    expectedTitles: ['API Rate Limiting Backoff'],\n    domain: 'test.api'\n  },\n  {\n    query: 'Database error recovery and transaction handling',\n    expectedTitles: ['Database Transaction Retry Logic'],\n    domain: 'test.db'\n  }\n];\n\nconst config = loadConfig();\n\nfor (const test of queries) {\n  console.log(`Query: \"${test.query}\"`);\n  console.log(`Domain filter: ${test.domain}`);\n\n  const candidates = fetchMemoryCandidates({\n    domain: test.domain,\n    minConfidence: config.retrieve.min_score\n  });\n\n  console.log(`Retrieved ${candidates.length} candidates:`);\n  candidates.forEach((c, idx) => {\n    console.log(`  ${idx + 1}. ${c.pattern_data.title} (conf: ${c.confidence}, age: ${c.age_days}d)`);\n  });\n\n  // Simple scoring simulation (without actual embeddings comparison)\n  console.log(`\\nTop-k (k=${config.retrieve.k}) selection would use:`);\n  console.log(`  Œ±=${config.retrieve.alpha} (similarity)`);\n  console.log(`  Œ≤=${config.retrieve.beta} (recency)`);\n  console.log(`  Œ≥=${config.retrieve.gamma} (reliability)`);\n  console.log(`  Œ¥=${config.retrieve.delta} (diversity/MMR)`);\n\n  console.log('\\n---\\n');\n}\n\n// Test cosine similarity\nconsole.log('3Ô∏è‚É£ Testing cosine similarity...\\n');\n\nfunction cosineSimilarity(a: Float32Array, b: Float32Array): number {\n  let dot = 0, magA = 0, magB = 0;\n  for (let i = 0; i < a.length; i++) {\n    dot += a[i] * b[i];\n    magA += a[i] * a[i];\n    magB += b[i] * b[i];\n  }\n  return dot / (Math.sqrt(magA) * Math.sqrt(magB));\n}\n\nconst vec1 = createEmbedding(42);\nconst vec2 = createEmbedding(42); // identical\nconst vec3 = createEmbedding(123); // different\n\nconst sim12 = cosineSimilarity(vec1, vec2);\nconst sim13 = cosineSimilarity(vec1, vec3);\n\nconsole.log(`Cosine similarity (identical vectors): ${sim12.toFixed(4)}`);\nconsole.log(`Cosine similarity (different vectors): ${sim13.toFixed(4)}`);\n\nif (Math.abs(sim12 - 1.0) < 0.001) {\n  console.log('   ‚úÖ Identical vectors have similarity ‚âà 1.0');\n} else {\n  console.log(`   ‚ö†Ô∏è  Identical vectors similarity is ${sim12}, expected ‚âà 1.0`);\n}\n\nif (sim13 < sim12) {\n  console.log('   ‚úÖ Different vectors have lower similarity');\n} else {\n  console.log('   ‚ö†Ô∏è  Different vectors similarity is unexpectedly high');\n}\n\nconsole.log('\\n‚úÖ Retrieval algorithm validation complete!\\n');\n"]}