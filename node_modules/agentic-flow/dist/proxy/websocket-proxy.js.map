{"version":3,"file":"websocket-proxy.js","sourceRoot":"","sources":["../../src/proxy/websocket-proxy.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * WebSocket Proxy for LLM Streaming\n *\n * Features:\n * - Bidirectional: Full-duplex communication\n * - Mobile-friendly: Better for unstable connections\n * - Lower overhead: No HTTP headers per message\n * - Reconnection: Automatic retry on disconnect\n * - Universal support: Works everywhere (browsers, mobile, desktop)\n *\n * Use Case: Fallback for unreliable connections (mobile, poor WiFi)\n */\n\nimport { WebSocketServer, WebSocket } from 'ws';\nimport { createServer, IncomingMessage } from 'http';\nimport { logger } from '../utils/logger.js';\n\nexport interface WebSocketProxyConfig {\n  port: number;\n  geminiApiKey?: string;\n  geminiBaseUrl?: string;\n  pingInterval?: number; // ms\n  pingTimeout?: number; // ms\n  maxConnections?: number; // Maximum concurrent connections\n  connectionTimeout?: number; // Connection idle timeout (ms)\n}\n\ninterface ClientState {\n  ws: WebSocket;\n  isAlive: boolean;\n  lastPing: Date;\n  requests: number;\n}\n\nexport class WebSocketProxy {\n  private wss: WebSocketServer;\n  private server: any;\n  private config: WebSocketProxyConfig;\n  private clients: Map<WebSocket, ClientState> = new Map();\n  private pingInterval?: NodeJS.Timeout;\n  private activeConnections: number = 0;\n\n  constructor(config: WebSocketProxyConfig) {\n    this.config = config;\n    this.server = createServer();\n    this.wss = new WebSocketServer({ server: this.server });\n\n    this.setupHandlers();\n    this.setupHeartbeat();\n\n    logger.info('WebSocket proxy created', {\n      port: config.port,\n      pingInterval: config.pingInterval || 30000\n    });\n  }\n\n  private setupHandlers(): void {\n    this.wss.on('connection', (ws: WebSocket, req: IncomingMessage) => {\n      const clientIp = req.socket.remoteAddress;\n\n      // Check connection limit (DoS protection)\n      const maxConnections = this.config.maxConnections || 1000;\n      if (this.activeConnections >= maxConnections) {\n        logger.warn('Connection limit reached', {\n          activeConnections: this.activeConnections,\n          maxConnections\n        });\n        ws.close(1008, 'Server at capacity');\n        return;\n      }\n\n      this.activeConnections++;\n      logger.info('WebSocket client connected', {\n        clientIp,\n        activeConnections: this.activeConnections\n      });\n\n      // Initialize client state\n      this.clients.set(ws, {\n        ws,\n        isAlive: true,\n        lastPing: new Date(),\n        requests: 0\n      });\n\n      // Handle incoming messages\n      ws.on('message', async (data: Buffer) => {\n        const client = this.clients.get(ws);\n        if (!client) return;\n\n        client.requests++;\n\n        try {\n          const message = JSON.parse(data.toString());\n          logger.debug('WebSocket message received', { type: message.type });\n\n          if (message.type === 'ping') {\n            // Respond to ping\n            ws.send(JSON.stringify({ type: 'pong', timestamp: Date.now() }));\n            client.isAlive = true;\n            client.lastPing = new Date();\n\n          } else if (message.type === 'streaming_request') {\n            // Handle LLM streaming request\n            await this.handleStreamingRequest(ws, message.data);\n\n          } else if (message.type === 'non_streaming_request') {\n            // Handle non-streaming request\n            await this.handleNonStreamingRequest(ws, message.data);\n\n          } else {\n            ws.send(JSON.stringify({\n              type: 'error',\n              error: `Unknown message type: ${message.type}`\n            }));\n          }\n\n        } catch (error) {\n          logger.error('WebSocket message error', { error: (error as Error).message });\n          ws.send(JSON.stringify({\n            type: 'error',\n            error: (error as Error).message\n          }));\n        }\n      });\n\n      // Handle pong responses\n      ws.on('pong', () => {\n        const client = this.clients.get(ws);\n        if (client) {\n          client.isAlive = true;\n          client.lastPing = new Date();\n        }\n      });\n\n      // Set connection timeout\n      const connectionTimeout = this.config.connectionTimeout || 300000; // 5 minutes\n      const timeoutHandle = setTimeout(() => {\n        logger.warn('Connection timeout', { clientIp });\n        ws.close(1000, 'Connection timeout');\n      }, connectionTimeout);\n\n      // Handle close\n      ws.on('close', () => {\n        logger.info('WebSocket client disconnected', { clientIp });\n        this.clients.delete(ws);\n        this.activeConnections--;\n        clearTimeout(timeoutHandle);\n      });\n\n      // Handle errors\n      ws.on('error', (error) => {\n        logger.error('WebSocket error', { clientIp, error: error.message });\n        this.clients.delete(ws);\n        this.activeConnections--;\n      });\n\n      // Send initial handshake\n      ws.send(JSON.stringify({\n        type: 'connected',\n        protocols: ['anthropic-messages-v1'],\n        features: ['streaming', 'non-streaming', 'ping-pong']\n      }));\n    });\n\n    this.wss.on('error', (error) => {\n      logger.error('WebSocket server error', { error: error.message });\n    });\n  }\n\n  private setupHeartbeat(): void {\n    const interval = this.config.pingInterval || 30000; // 30 seconds\n    const timeout = this.config.pingTimeout || 60000; // 60 seconds\n\n    this.pingInterval = setInterval(() => {\n      const now = Date.now();\n\n      this.clients.forEach((client, ws) => {\n        // Check if client responded to last ping\n        if (!client.isAlive) {\n          const timeSinceLastPing = now - client.lastPing.getTime();\n\n          if (timeSinceLastPing > timeout) {\n            logger.warn('Client did not respond to ping, terminating', {\n              timeSinceLastPing\n            });\n            ws.terminate();\n            this.clients.delete(ws);\n            return;\n          }\n        }\n\n        // Send ping\n        client.isAlive = false;\n        ws.ping();\n      });\n\n    }, interval);\n  }\n\n  private async handleStreamingRequest(\n    ws: WebSocket,\n    anthropicReq: any\n  ): Promise<void> {\n    try {\n      logger.info('WebSocket streaming request', {\n        model: anthropicReq.model,\n        messageCount: anthropicReq.messages?.length\n      });\n\n      // Convert to Gemini format\n      const geminiReq = this.convertAnthropicToGemini(anthropicReq);\n\n      // Send streaming start event\n      ws.send(JSON.stringify({\n        type: 'message_start',\n        message: {\n          id: `msg_${Date.now()}`,\n          role: 'assistant',\n          model: anthropicReq.model || 'gemini-2.0-flash-exp'\n        }\n      }));\n\n      // Forward to Gemini\n      const geminiBaseUrl = this.config.geminiBaseUrl || 'https://generativelanguage.googleapis.com/v1beta';\n      const url = `${geminiBaseUrl}/models/gemini-2.0-flash-exp:streamGenerateContent?key=${this.config.geminiApiKey}&alt=sse`;\n\n      const response = await fetch(url, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(geminiReq)\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(`Gemini API error: ${error}`);\n      }\n\n      const reader = response.body?.getReader();\n      if (!reader) {\n        throw new Error('No response body');\n      }\n\n      const decoder = new TextDecoder();\n      let chunkCount = 0;\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        const chunk = decoder.decode(value);\n        chunkCount++;\n\n        // Parse Gemini SSE and send as WebSocket messages\n        const lines = chunk.split('\\n').filter(line => line.trim());\n\n        for (const line of lines) {\n          if (line.startsWith('data: ')) {\n            try {\n              const jsonStr = line.substring(6);\n              const parsed = JSON.parse(jsonStr);\n              const candidate = parsed.candidates?.[0];\n              const text = candidate?.content?.parts?.[0]?.text;\n\n              if (text) {\n                // Send text delta\n                ws.send(JSON.stringify({\n                  type: 'content_block_delta',\n                  delta: { type: 'text_delta', text }\n                }));\n              }\n\n              if (candidate?.finishReason) {\n                // Send completion\n                ws.send(JSON.stringify({\n                  type: 'message_stop',\n                  stop_reason: 'end_turn'\n                }));\n              }\n            } catch (e) {\n              logger.debug('Failed to parse stream chunk', { line });\n            }\n          }\n        }\n      }\n\n      logger.info('WebSocket stream complete', { totalChunks: chunkCount });\n\n    } catch (error) {\n      logger.error('WebSocket streaming error', { error: (error as Error).message });\n      ws.send(JSON.stringify({\n        type: 'error',\n        error: (error as Error).message\n      }));\n    }\n  }\n\n  private async handleNonStreamingRequest(\n    ws: WebSocket,\n    anthropicReq: any\n  ): Promise<void> {\n    try {\n      logger.info('WebSocket non-streaming request', {\n        model: anthropicReq.model,\n        messageCount: anthropicReq.messages?.length\n      });\n\n      // Convert to Gemini format\n      const geminiReq = this.convertAnthropicToGemini(anthropicReq);\n\n      // Forward to Gemini\n      const geminiBaseUrl = this.config.geminiBaseUrl || 'https://generativelanguage.googleapis.com/v1beta';\n      const url = `${geminiBaseUrl}/models/gemini-2.0-flash-exp:generateContent?key=${this.config.geminiApiKey}`;\n\n      const response = await fetch(url, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(geminiReq)\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(`Gemini API error: ${error}`);\n      }\n\n      const geminiRes = await response.json();\n      const anthropicRes = this.convertGeminiToAnthropic(geminiRes);\n\n      // Send complete response\n      ws.send(JSON.stringify({\n        type: 'message_complete',\n        message: anthropicRes\n      }));\n\n    } catch (error) {\n      logger.error('WebSocket non-streaming error', { error: (error as Error).message });\n      ws.send(JSON.stringify({\n        type: 'error',\n        error: (error as Error).message\n      }));\n    }\n  }\n\n  private convertAnthropicToGemini(anthropicReq: any): any {\n    const contents = [];\n    let systemPrefix = '';\n\n    if (anthropicReq.system) {\n      systemPrefix = `System: ${anthropicReq.system}\\n\\n`;\n    }\n\n    for (let i = 0; i < anthropicReq.messages.length; i++) {\n      const msg = anthropicReq.messages[i];\n      let text: string;\n\n      if (typeof msg.content === 'string') {\n        text = msg.content;\n      } else if (Array.isArray(msg.content)) {\n        text = msg.content\n          .filter((block: any) => block.type === 'text')\n          .map((block: any) => block.text)\n          .join('\\n');\n      } else {\n        text = '';\n      }\n\n      if (i === 0 && msg.role === 'user' && systemPrefix) {\n        text = systemPrefix + text;\n      }\n\n      contents.push({\n        role: msg.role === 'assistant' ? 'model' : 'user',\n        parts: [{ text }]\n      });\n    }\n\n    const geminiReq: any = { contents };\n\n    if (anthropicReq.temperature !== undefined || anthropicReq.max_tokens !== undefined) {\n      geminiReq.generationConfig = {};\n      if (anthropicReq.temperature !== undefined) {\n        geminiReq.generationConfig.temperature = anthropicReq.temperature;\n      }\n      if (anthropicReq.max_tokens !== undefined) {\n        geminiReq.generationConfig.maxOutputTokens = anthropicReq.max_tokens;\n      }\n    }\n\n    return geminiReq;\n  }\n\n  private convertGeminiToAnthropic(geminiRes: any): any {\n    const candidate = geminiRes.candidates?.[0];\n    if (!candidate) {\n      throw new Error('No candidates in Gemini response');\n    }\n\n    const content = candidate.content;\n    const parts = content?.parts || [];\n    let rawText = '';\n\n    for (const part of parts) {\n      if (part.text) {\n        rawText += part.text;\n      }\n    }\n\n    return {\n      id: `msg_${Date.now()}`,\n      type: 'message',\n      role: 'assistant',\n      model: 'gemini-2.0-flash-exp',\n      content: [\n        {\n          type: 'text',\n          text: rawText\n        }\n      ],\n      stop_reason: 'end_turn',\n      usage: {\n        input_tokens: geminiRes.usageMetadata?.promptTokenCount || 0,\n        output_tokens: geminiRes.usageMetadata?.candidatesTokenCount || 0\n      }\n    };\n  }\n\n  start(): Promise<void> {\n    return new Promise((resolve) => {\n      this.server.listen(this.config.port, () => {\n        logger.info('WebSocket proxy started', {\n          port: this.config.port,\n          url: `ws://localhost:${this.config.port}`\n        });\n\n        console.log(`\\nâœ… WebSocket Proxy running at ws://localhost:${this.config.port}`);\n        console.log(`   Protocol: WebSocket (fallback for unreliable connections)`);\n        console.log(`   Features: Bidirectional, Mobile-friendly, Auto-reconnect\\n`);\n\n        resolve();\n      });\n    });\n  }\n\n  stop(): Promise<void> {\n    return new Promise((resolve) => {\n      // Clear ping interval\n      if (this.pingInterval) {\n        clearInterval(this.pingInterval);\n      }\n\n      // Close all client connections\n      this.clients.forEach((client, ws) => {\n        ws.close(1000, 'Server shutting down');\n      });\n      this.clients.clear();\n\n      // Close WebSocket server\n      this.wss.close(() => {\n        // Close HTTP server\n        this.server.close(() => {\n          logger.info('WebSocket proxy stopped');\n          resolve();\n        });\n      });\n    });\n  }\n}\n\n// CLI entry point\nif (import.meta.url === `file://${process.argv[1]}`) {\n  const port = parseInt(process.env.PORT || '8080');\n  const geminiApiKey = process.env.GOOGLE_GEMINI_API_KEY;\n\n  if (!geminiApiKey) {\n    console.error('âŒ Error: GOOGLE_GEMINI_API_KEY environment variable required');\n    process.exit(1);\n  }\n\n  const proxy = new WebSocketProxy({\n    port,\n    geminiApiKey,\n    geminiBaseUrl: process.env.GEMINI_BASE_URL,\n    pingInterval: 30000,\n    pingTimeout: 60000\n  });\n\n  proxy.start();\n\n  // Graceful shutdown\n  process.on('SIGINT', async () => {\n    console.log('\\nðŸ›‘ Shutting down WebSocket proxy...');\n    await proxy.stop();\n    process.exit(0);\n  });\n}\n"]}