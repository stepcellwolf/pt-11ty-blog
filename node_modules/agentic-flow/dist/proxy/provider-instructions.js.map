{"version":3,"file":"provider-instructions.js","sourceRoot":"","sources":["../../src/proxy/provider-instructions.ts"],"names":[],"mappings":"AAAA,yDAAyD;AACzD,4EAA4E;AAa5E,yDAAyD;AACzD,MAAM,CAAC,MAAM,iBAAiB,GAAqB;IACjD,MAAM,EAAE,KAAK;IACb,QAAQ,EAAE;QACR,KAAK,EAAE,+DAA+D;QACtE,IAAI,EAAE,kCAAkC;QACxC,IAAI,EAAE,+CAA+C;KACtD;IACD,QAAQ,EAAE;;;;;;;CAOX;IACC,QAAQ,EAAE,wGAAwG;CACnH,CAAC;AAEF,sEAAsE;AACtE,MAAM,CAAC,MAAM,sBAAsB,GAAqB;IACtD,MAAM,EAAE,QAAQ;IAChB,QAAQ,EAAE;QACR,KAAK,EAAE,sDAAsD;QAC7D,IAAI,EAAE,wCAAwC;QAC9C,IAAI,EAAE,sCAAsC;KAC7C;IACD,QAAQ,EAAE,iEAAiE;CAC5E,CAAC;AAEF,oDAAoD;AACpD,MAAM,CAAC,MAAM,mBAAmB,GAAqB;IACnD,MAAM,EAAE,KAAK;IACb,QAAQ,EAAE;QACR,KAAK,EAAE,+DAA+D;QACtE,IAAI,EAAE,kCAAkC;QACxC,IAAI,EAAE,+CAA+C;KACtD;IACD,QAAQ,EAAE;;;;;;;CAOX;IACC,QAAQ,EAAE,4GAA4G;CACvH,CAAC;AAEF,yDAAyD;AACzD,MAAM,CAAC,MAAM,mBAAmB,GAAqB;IACnD,MAAM,EAAE,KAAK;IACb,QAAQ,EAAE;QACR,KAAK,EAAE,+DAA+D;QACtE,IAAI,EAAE,kCAAkC;QACxC,IAAI,EAAE,+CAA+C;KACtD;IACD,QAAQ,EAAE;;;;;;;;;;;CAWX;IACC,QAAQ,EAAE,qHAAqH;CAChI,CAAC;AAEF,kDAAkD;AAClD,MAAM,CAAC,MAAM,iBAAiB,GAAqB;IACjD,MAAM,EAAE,KAAK;IACb,QAAQ,EAAE;QACR,KAAK,EAAE,+DAA+D;QACtE,IAAI,EAAE,kCAAkC;QACxC,IAAI,EAAE,+CAA+C;KACtD;IACD,QAAQ,EAAE;;;;;;;;;CASX;IACC,QAAQ,EAAE,4FAA4F;CACvG,CAAC;AAEF,oDAAoD;AACpD,MAAM,CAAC,MAAM,qBAAqB,GAAqB;IACrD,MAAM,EAAE,KAAK;IACb,QAAQ,EAAE;QACR,KAAK,EAAE,+DAA+D;QACtE,IAAI,EAAE,kCAAkC;QACxC,IAAI,EAAE,+CAA+C;KACtD;IACD,QAAQ,EAAE;;;;;;;;;CASX;IACC,QAAQ,EAAE,kFAAkF;CAC7F,CAAC;AAEF,2CAA2C;AAC3C,MAAM,CAAC,MAAM,oBAAoB,GAAqB;IACpD,MAAM,EAAE,KAAK;IACb,QAAQ,EAAE;QACR,KAAK,EAAE,+DAA+D;QACtE,IAAI,EAAE,kCAAkC;QACxC,IAAI,EAAE,+CAA+C;KACtD;IACD,QAAQ,EAAE;;;;;;;;CAQX;IACC,QAAQ,EAAE,8FAA8F;CACzG,CAAC;AAEF,kDAAkD;AAClD,MAAM,CAAC,MAAM,gBAAgB,GAAqB;IAChD,MAAM,EAAE,KAAK;IACb,QAAQ,EAAE;QACR,KAAK,EAAE,+DAA+D;QACtE,IAAI,EAAE,kCAAkC;QACxC,IAAI,EAAE,+CAA+C;KACtD;IACD,QAAQ,EAAE;;;;;CAKX;IACC,QAAQ,EAAE,2DAA2D;CACtE,CAAC;AAEF,kDAAkD;AAClD,MAAM,UAAU,uBAAuB,CAAC,OAAe,EAAE,QAAiB;IACxE,MAAM,eAAe,GAAG,OAAO,CAAC,WAAW,EAAE,CAAC;IAE9C,yCAAyC;IACzC,IAAI,eAAe,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,QAAQ,KAAK,WAAW,EAAE,CAAC;QACnE,OAAO,sBAAsB,CAAC;IAChC,CAAC;IAED,gBAAgB;IAChB,IAAI,eAAe,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,eAAe,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,QAAQ,KAAK,QAAQ,EAAE,CAAC;QACnG,OAAO,mBAAmB,CAAC;IAC7B,CAAC;IAED,uBAAuB;IACvB,IAAI,eAAe,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,eAAe,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,QAAQ,KAAK,QAAQ,EAAE,CAAC;QACrG,OAAO,mBAAmB,CAAC;IAC7B,CAAC;IAED,oBAAoB;IACpB,IAAI,eAAe,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,QAAQ,KAAK,YAAY,IAAI,QAAQ,KAAK,MAAM,EAAE,CAAC;QAC1F,OAAO,iBAAiB,CAAC;IAC3B,CAAC;IAED,kBAAkB;IAClB,IAAI,eAAe,CAAC,QAAQ,CAAC,UAAU,CAAC,IAAI,QAAQ,KAAK,UAAU,EAAE,CAAC;QACpE,OAAO,qBAAqB,CAAC;IAC/B,CAAC;IAED,iBAAiB;IACjB,IAAI,eAAe,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,QAAQ,KAAK,WAAW,EAAE,CAAC;QACpE,OAAO,oBAAoB,CAAC;IAC9B,CAAC;IAED,mBAAmB;IACnB,IAAI,eAAe,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,QAAQ,KAAK,MAAM,EAAE,CAAC;QAC5D,OAAO,gBAAgB,CAAC;IAC1B,CAAC;IAED,cAAc;IACd,IAAI,eAAe,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC;QACrC,OAAO,qBAAqB,CAAC,CAAC,sBAAsB;IACtD,CAAC;IAED,+BAA+B;IAC/B,OAAO,iBAAiB,CAAC;AAC3B,CAAC;AAED,sEAAsE;AACtE,MAAM,UAAU,mBAAmB,CAAC,YAAoB,EAAE,YAAmB;IAC3E,MAAM,QAAQ,GAAG,YAAY,GAAG,GAAG,GAAG,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,CAAC;IAEnE,yDAAyD;IACzD,MAAM,YAAY,GAAG;QACnB,mBAAmB,EAAY,oDAAoD;QACnF,kBAAkB,EAAa,kCAAkC;QACjE,iBAAiB,EAAc,iCAAiC;QAChE,eAAe,EAAgB,iCAAiC;QAChE,oBAAoB,EAAW,kBAAkB;QACjD,qBAAqB,EAAU,qCAAqC;QACpE,iBAAiB,EAAc,gBAAgB;QAC/C,qBAAqB,EAAU,oBAAoB;QACnD,wBAAwB,EAAO,uBAAuB;QACtD,0BAA0B,EAAK,oBAAoB;QACnD,aAAa,EAAkB,qBAAqB;QACpD,oBAAoB,EAAW,oBAAoB;QACnD,gBAAgB,EAAe,gBAAgB;QAC/C,kBAAkB,EAAa,kBAAkB;QACjD,aAAa,CAAkB,aAAa;KAC7C,CAAC;IAEF,OAAO,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;AAC9D,CAAC;AAED,sDAAsD;AACtD,0EAA0E;AAC1E,MAAM,UAAU,kBAAkB,CAChC,YAA8B,EAC9B,yBAAkC,IAAI;IAEtC,IAAI,YAAY,CAAC,MAAM,KAAK,QAAQ,EAAE,CAAC;QACrC,OAAO,GAAG,YAAY,CAAC,QAAQ,OAAO,YAAY,CAAC,QAAQ,CAAC,KAAK,KAAK,YAAY,CAAC,QAAQ,CAAC,IAAI,KAAK,YAAY,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;IACpI,CAAC;IAED,qEAAqE;IACrE,IAAI,CAAC,sBAAsB,EAAE,CAAC;QAC5B,OAAO,yFAAyF,CAAC;IACnG,CAAC;IAED,IAAI,SAAS,GAAG,GAAG,YAAY,CAAC,QAAQ,MAAM,CAAC;IAC/C,SAAS,IAAI,uBAAuB,CAAC;IACrC,SAAS,IAAI,GAAG,YAAY,CAAC,QAAQ,CAAC,KAAK,IAAI,CAAC;IAChD,SAAS,IAAI,GAAG,YAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC;IAC/C,SAAS,IAAI,GAAG,YAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC;IAE/C,IAAI,YAAY,CAAC,QAAQ,EAAE,CAAC;QAC1B,SAAS,IAAI,KAAK,YAAY,CAAC,QAAQ,EAAE,CAAC;IAC5C,CAAC;IAED,OAAO,SAAS,CAAC;AACnB,CAAC;AAED,oEAAoE;AACpE,MAAM,CAAC,MAAM,+BAA+B,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CA2C9C,CAAC;AAUF,uCAAuC;AACvC,MAAM,UAAU,oBAAoB,CAAC,OAAe,EAAE,kBAA2B;IAC/E,MAAM,eAAe,GAAG,OAAO,CAAC,WAAW,EAAE,CAAC;IAE9C,gDAAgD;IAChD,IAAI,kBAAkB,EAAE,CAAC;QACvB,OAAO,kBAAkB,CAAC;IAC5B,CAAC;IAED,mCAAmC;IACnC,IAAI,eAAe,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE,CAAC;QACzC,OAAO,IAAI,CAAC;IACd,CAAC;IAED,2BAA2B;IAC3B,IAAI,eAAe,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;QACtC,OAAO,IAAI,CAAC;IACd,CAAC;IAED,wBAAwB;IACxB,IAAI,eAAe,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE,CAAC;QACpC,OAAO,IAAI,CAAC;IACd,CAAC;IAED,UAAU;IACV,OAAO,IAAI,CAAC;AACd,CAAC;AAED,gDAAgD;AAChD,MAAM,UAAU,uBAAuB,CAAC,OAAe;IAMrD,MAAM,UAAU,GAAG,OAAO,CAAC,WAAW,EAAE,CAAC;IAEzC,yCAAyC;IACzC,IAAI,UAAU,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,UAAU,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;QAClE,OAAO;YACL,cAAc,EAAE,EAAE;YAClB,oBAAoB,EAAE,CAAC;YACvB,oBAAoB,EAAE,IAAI;YAC1B,qBAAqB,EAAE,IAAI;SAC5B,CAAC;IACJ,CAAC;IAED,wCAAwC;IACxC,IAAI,UAAU,CAAC,QAAQ,CAAC,UAAU,CAAC,IAAI,UAAU,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,CAAC;QACxE,OAAO;YACL,cAAc,EAAE,CAAC;YACjB,oBAAoB,EAAE,CAAC;YACvB,oBAAoB,EAAE,IAAI;YAC1B,qBAAqB,EAAE,IAAI;SAC5B,CAAC;IACJ,CAAC;IAED,oBAAoB;IACpB,OAAO;QACL,cAAc,EAAE,CAAC;QACjB,oBAAoB,EAAE,CAAC;QACvB,oBAAoB,EAAE,IAAI;QAC1B,qBAAqB,EAAE,KAAK;KAC7B,CAAC;AACJ,CAAC;AAED,+BAA+B;AAC/B,MAAM,UAAU,iBAAiB,CAC/B,OAAe,EACf,QAA4B,EAC5B,UAA8B,EAAE;IAEhC,MAAM,EACJ,cAAc,GAAG,KAAK,EACtB,SAAS,EACT,mBAAmB,GAAG,KAAK,EAC3B,sBAAsB,GAAG,IAAI,EAC9B,GAAG,OAAO,CAAC;IAEZ,MAAM,gBAAgB,GAAG,uBAAuB,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;IACpE,IAAI,SAAS,GAAG,kBAAkB,CAAC,gBAAgB,EAAE,sBAAsB,CAAC,CAAC;IAE7E,iDAAiD;IACjD,IAAI,cAAc,EAAE,CAAC;QACnB,MAAM,YAAY,GAAG,uBAAuB,CAAC,OAAO,CAAC,CAAC;QACtD,MAAM,kBAAkB,GAAG,SAAS,IAAI,YAAY,CAAC,oBAAoB,CAAC;QAE1E,SAAS,IAAI,MAAM,GAAG,+BAA+B,CAAC;QACtD,SAAS,IAAI,+BAA+B,kBAAkB,uBAAuB,CAAC;QACtF,SAAS,IAAI,sBAAsB,YAAY,CAAC,cAAc,SAAS,CAAC;IAC1E,CAAC;IAED,4CAA4C;IAC5C,IAAI,mBAAmB,EAAE,CAAC;QACxB,SAAS,IAAI;;;;;KAKZ,CAAC;IACJ,CAAC;IAED,OAAO,SAAS,CAAC;AACnB,CAAC","sourcesContent":["// Provider-specific and model-specific tool instructions\n// Optimized for different LLM families to improve tool calling success rate\n\nexport interface ToolInstructions {\n  format: string; // The instruction format style\n  commands: {\n    write: string;\n    read: string;\n    bash: string;\n  };\n  examples?: string; // Optional example usage\n  emphasis?: string; // Additional emphasis/notes\n}\n\n// Base structured command format (works for most models)\nexport const BASE_INSTRUCTIONS: ToolInstructions = {\n  format: 'xml',\n  commands: {\n    write: '<file_write path=\"filename.ext\">\\ncontent here\\n</file_write>',\n    read: '<file_read path=\"filename.ext\"/>',\n    bash: '<bash_command>\\ncommand here\\n</bash_command>'\n  },\n  examples: `\nExample: Create a file\n<file_write path=\"hello.js\">\nfunction hello() {\n  console.log(\"Hello!\");\n}\n</file_write>\n`,\n  emphasis: 'IMPORTANT: Use these structured commands in your response. The system will automatically execute them.'\n};\n\n// Anthropic models - Native tool calling, minimal instructions needed\nexport const ANTHROPIC_INSTRUCTIONS: ToolInstructions = {\n  format: 'native',\n  commands: {\n    write: 'Use Write tool with file_path and content parameters',\n    read: 'Use Read tool with file_path parameter',\n    bash: 'Use Bash tool with command parameter'\n  },\n  emphasis: 'You have native access to file system tools. Use them directly.'\n};\n\n// OpenAI/GPT models - Prefer function calling style\nexport const OPENAI_INSTRUCTIONS: ToolInstructions = {\n  format: 'xml',\n  commands: {\n    write: '<file_write path=\"filename.ext\">\\ncontent here\\n</file_write>',\n    read: '<file_read path=\"filename.ext\"/>',\n    bash: '<bash_command>\\ncommand here\\n</bash_command>'\n  },\n  examples: `\nWhen you need to create a file, respond with:\n<file_write path=\"example.txt\">\nFile content here\n</file_write>\n\nThe system will create the file for you.\n`,\n  emphasis: 'CRITICAL: You must use these exact XML tag formats. Do not just describe the file - actually use the tags.'\n};\n\n// Google/Gemini models - Detailed, explicit instructions\nexport const GOOGLE_INSTRUCTIONS: ToolInstructions = {\n  format: 'xml',\n  commands: {\n    write: '<file_write path=\"filename.ext\">\\ncontent here\\n</file_write>',\n    read: '<file_read path=\"filename.ext\"/>',\n    bash: '<bash_command>\\ncommand here\\n</bash_command>'\n  },\n  examples: `\nStep-by-step file creation:\n1. Determine the filename\n2. Write the content\n3. Use this exact format:\n\n<file_write path=\"your_file.txt\">\nYour content here\n</file_write>\n\nThe file will be automatically created.\n`,\n  emphasis: 'IMPORTANT: Always use the XML tags. Just writing code blocks will NOT create files. You MUST use <file_write> tags.'\n};\n\n// Meta/Llama models - Clear, concise instructions\nexport const META_INSTRUCTIONS: ToolInstructions = {\n  format: 'xml',\n  commands: {\n    write: '<file_write path=\"filename.ext\">\\ncontent here\\n</file_write>',\n    read: '<file_read path=\"filename.ext\"/>',\n    bash: '<bash_command>\\ncommand here\\n</bash_command>'\n  },\n  examples: `\nTo create files, use:\n<file_write path=\"file.txt\">content</file_write>\n\nTo read files, use:\n<file_read path=\"file.txt\"/>\n\nTo run commands, use:\n<bash_command>ls -la</bash_command>\n`,\n  emphasis: 'Use these tags to perform actual file operations. Code blocks alone will not create files.'\n};\n\n// DeepSeek models - Technical, precise instructions\nexport const DEEPSEEK_INSTRUCTIONS: ToolInstructions = {\n  format: 'xml',\n  commands: {\n    write: '<file_write path=\"filename.ext\">\\ncontent here\\n</file_write>',\n    read: '<file_read path=\"filename.ext\"/>',\n    bash: '<bash_command>\\ncommand here\\n</bash_command>'\n  },\n  examples: `\nFile system operations use XML-like structured commands:\n\n<file_write path=\"example.py\">\ndef main():\n    print(\"Hello\")\n</file_write>\n\nThese commands are parsed and executed by the system.\n`,\n  emphasis: 'Use structured commands for file I/O. Standard code blocks are for display only.'\n};\n\n// Mistral models - Direct, action-oriented\nexport const MISTRAL_INSTRUCTIONS: ToolInstructions = {\n  format: 'xml',\n  commands: {\n    write: '<file_write path=\"filename.ext\">\\ncontent here\\n</file_write>',\n    read: '<file_read path=\"filename.ext\"/>',\n    bash: '<bash_command>\\ncommand here\\n</bash_command>'\n  },\n  examples: `\nACTION REQUIRED: To create actual files, you must use these tags:\n\n<file_write path=\"file.txt\">\ncontent\n</file_write>\n\nDo not just show code - use the tags to create real files.\n`,\n  emphasis: 'CRITICAL: File operations require XML tags. Code blocks alone will not create files on disk.'\n};\n\n// X.AI/Grok models - Balanced, clear instructions\nexport const XAI_INSTRUCTIONS: ToolInstructions = {\n  format: 'xml',\n  commands: {\n    write: '<file_write path=\"filename.ext\">\\ncontent here\\n</file_write>',\n    read: '<file_read path=\"filename.ext\"/>',\n    bash: '<bash_command>\\ncommand here\\n</bash_command>'\n  },\n  examples: `\nFile system commands:\n- Create: <file_write path=\"file.txt\">content</file_write>\n- Read: <file_read path=\"file.txt\"/>\n- Execute: <bash_command>command</bash_command>\n`,\n  emphasis: 'Use structured commands to interact with the file system.'\n};\n\n// Map provider/model patterns to instruction sets\nexport function getInstructionsForModel(modelId: string, provider?: string): ToolInstructions {\n  const normalizedModel = modelId.toLowerCase();\n\n  // Anthropic models - native tool calling\n  if (normalizedModel.includes('claude') || provider === 'anthropic') {\n    return ANTHROPIC_INSTRUCTIONS;\n  }\n\n  // OpenAI models\n  if (normalizedModel.includes('gpt') || normalizedModel.includes('openai') || provider === 'openai') {\n    return OPENAI_INSTRUCTIONS;\n  }\n\n  // Google/Gemini models\n  if (normalizedModel.includes('gemini') || normalizedModel.includes('gemma') || provider === 'google') {\n    return GOOGLE_INSTRUCTIONS;\n  }\n\n  // Meta/Llama models\n  if (normalizedModel.includes('llama') || provider === 'meta-llama' || provider === 'meta') {\n    return META_INSTRUCTIONS;\n  }\n\n  // DeepSeek models\n  if (normalizedModel.includes('deepseek') || provider === 'deepseek') {\n    return DEEPSEEK_INSTRUCTIONS;\n  }\n\n  // Mistral models\n  if (normalizedModel.includes('mistral') || provider === 'mistralai') {\n    return MISTRAL_INSTRUCTIONS;\n  }\n\n  // X.AI/Grok models\n  if (normalizedModel.includes('grok') || provider === 'x-ai') {\n    return XAI_INSTRUCTIONS;\n  }\n\n  // Qwen models\n  if (normalizedModel.includes('qwen')) {\n    return DEEPSEEK_INSTRUCTIONS; // Similar to DeepSeek\n  }\n\n  // Default to base instructions\n  return BASE_INSTRUCTIONS;\n}\n\n// Check if task requires file/tool operations based on prompt content\nexport function taskRequiresFileOps(systemPrompt: string, userMessages: any[]): boolean {\n  const combined = systemPrompt + ' ' + JSON.stringify(userMessages);\n\n  // Regex patterns that suggest file operations are needed\n  const filePatterns = [\n    /create\\s+.*?file/i,           // \"create a file\", \"create file\", \"create the file\"\n    /write\\s+.*?file/i,            // \"write a file\", \"write to file\"\n    /save\\s+.*?file/i,             // \"save to file\", \"save as file\"\n    /save\\s+.*?to/i,               // \"save to disk\", \"save code to\"\n    /write\\s+to\\s+disk/i,          // \"write to disk\"\n    /create\\s+.*?script/i,         // \"create a script\", \"create script\"\n    /make\\s+.*?file/i,             // \"make a file\"\n    /generate\\s+.*?file/i,         // \"generate a file\"\n    /put\\s+.*?in\\s+.*?file/i,      // \"put code in a file\"\n    /store\\s+.*?in\\s+.*?file/i,    // \"store in a file\"\n    /run\\s+bash/i,                 // \"run bash command\"\n    /execute\\s+command/i,          // \"execute command\"\n    /run\\s+command/i,              // \"run command\"\n    /shell\\s+command/i,            // \"shell command\"\n    /use\\s+bash/i                  // \"use bash\"\n  ];\n\n  return filePatterns.some(pattern => pattern.test(combined));\n}\n\n// Generate formatted instruction string for injection\n// Only include XML instructions if task actually requires file operations\nexport function formatInstructions(\n  instructions: ToolInstructions,\n  includeXmlInstructions: boolean = true\n): string {\n  if (instructions.format === 'native') {\n    return `${instructions.emphasis}\\n\\n${instructions.commands.write}\\n${instructions.commands.read}\\n${instructions.commands.bash}`;\n  }\n\n  // For simple code generation without file ops, skip XML instructions\n  if (!includeXmlInstructions) {\n    return 'Provide clean, well-formatted code in your response. Use markdown code blocks for code.';\n  }\n\n  let formatted = `${instructions.emphasis}\\n\\n`;\n  formatted += `Available commands:\\n`;\n  formatted += `${instructions.commands.write}\\n`;\n  formatted += `${instructions.commands.read}\\n`;\n  formatted += `${instructions.commands.bash}\\n`;\n\n  if (instructions.examples) {\n    formatted += `\\n${instructions.examples}`;\n  }\n\n  return formatted;\n}\n\n// Parallel execution instructions for concurrent agent coordination\nexport const PARALLEL_EXECUTION_INSTRUCTIONS = `\n═══════════════════════════════════════════════════════════════\nCRITICAL: Concurrent Execution System\n═══════════════════════════════════════════════════════════════\n\nThis system supports parallel agent execution via CLI subprocesses and\nReasoningBank coordination. Follow these patterns for optimal performance:\n\n1. SUBPROCESS SPAWNING\n   When decomposing tasks, spawn subagents via CLI:\n\n   \\`\\`\\`typescript\n   const results = await Promise.all([\n     exec('npx agentic-flow --agent researcher --task \"analyze security\"'),\n     exec('npx agentic-flow --agent coder --task \"implement features\"'),\n     exec('npx agentic-flow --agent tester --task \"create tests\"')\n   ]);\n   \\`\\`\\`\n\n2. REASONINGBANK COORDINATION\n   Each subagent stores results in ReasoningBank:\n\n   \\`\\`\\`typescript\n   // Subagent stores results\n   await reasoningBank.storePattern({\n     sessionId: 'swarm/task-123/agent-1',\n     task: 'Research security patterns',\n     output: findings,\n     reward: 0.95,\n     success: true\n   });\n\n   // Parent retrieves all results\n   const allResults = await reasoningBank.searchPatterns('swarm/task-123');\n   \\`\\`\\`\n\n3. PERFORMANCE BENEFITS\n   - 2.8-4.4x speedup with parallel execution\n   - 50-70% time reduction with QUIC transport\n   - 32.3% token reduction via batching\n\nSee /agentic-flow/src/prompts/parallel-execution-guide.md for detailed examples.\n═══════════════════════════════════════════════════════════════\n`;\n\n// Enhanced instruction provider with parallel execution support\nexport interface InstructionOptions {\n  enableParallel?: boolean;\n  batchSize?: number;\n  enableReasoningBank?: boolean;\n  includeXmlInstructions?: boolean;\n}\n\n// Get appropriate max_tokens for model\nexport function getMaxTokensForModel(modelId: string, requestedMaxTokens?: number): number {\n  const normalizedModel = modelId.toLowerCase();\n\n  // If user requested specific max_tokens, use it\n  if (requestedMaxTokens) {\n    return requestedMaxTokens;\n  }\n\n  // DeepSeek needs higher max_tokens\n  if (normalizedModel.includes('deepseek')) {\n    return 8000;\n  }\n\n  // Llama 3.1/3.3 - moderate\n  if (normalizedModel.includes('llama')) {\n    return 4096;\n  }\n\n  // GPT models - standard\n  if (normalizedModel.includes('gpt')) {\n    return 4096;\n  }\n\n  // Default\n  return 4096;\n}\n\n// Get parallel execution capabilities for model\nexport function getParallelCapabilities(modelId: string): {\n  maxConcurrency: number;\n  recommendedBatchSize: number;\n  supportsSubprocesses: boolean;\n  supportsReasoningBank: boolean;\n} {\n  const normalized = modelId.toLowerCase();\n\n  // High-capability models (Claude, GPT-4)\n  if (normalized.includes('claude') || normalized.includes('gpt-4')) {\n    return {\n      maxConcurrency: 10,\n      recommendedBatchSize: 5,\n      supportsSubprocesses: true,\n      supportsReasoningBank: true\n    };\n  }\n\n  // Mid-tier models (DeepSeek, Llama 3.1)\n  if (normalized.includes('deepseek') || normalized.includes('llama-3.1')) {\n    return {\n      maxConcurrency: 5,\n      recommendedBatchSize: 3,\n      supportsSubprocesses: true,\n      supportsReasoningBank: true\n    };\n  }\n\n  // Lower-tier models\n  return {\n    maxConcurrency: 3,\n    recommendedBatchSize: 2,\n    supportsSubprocesses: true,\n    supportsReasoningBank: false\n  };\n}\n\n// Enhanced instruction builder\nexport function buildInstructions(\n  modelId: string,\n  provider: string | undefined,\n  options: InstructionOptions = {}\n): string {\n  const {\n    enableParallel = false,\n    batchSize,\n    enableReasoningBank = false,\n    includeXmlInstructions = true\n  } = options;\n\n  const baseInstructions = getInstructionsForModel(modelId, provider);\n  let formatted = formatInstructions(baseInstructions, includeXmlInstructions);\n\n  // Add parallel execution instructions if enabled\n  if (enableParallel) {\n    const capabilities = getParallelCapabilities(modelId);\n    const effectiveBatchSize = batchSize || capabilities.recommendedBatchSize;\n\n    formatted += '\\n\\n' + PARALLEL_EXECUTION_INSTRUCTIONS;\n    formatted += `\\n\\nRECOMMENDED BATCH SIZE: ${effectiveBatchSize} concurrent subagents`;\n    formatted += `\\nMAX CONCURRENCY: ${capabilities.maxConcurrency} agents`;\n  }\n\n  // Add ReasoningBank instructions if enabled\n  if (enableReasoningBank) {\n    formatted += `\\n\\n\nREASONINGBANK MEMORY COORDINATION:\n- Store: await reasoningBank.storePattern({ sessionId: 'swarm/TASK_ID/AGENT_ID', task, output, reward, success })\n- Retrieve: await reasoningBank.retrieve('swarm/TASK_ID/AGENT_ID')\n- Search: await reasoningBank.searchPatterns('swarm/TASK_ID', { k: 10 })\n    `;\n  }\n\n  return formatted;\n}\n"]}