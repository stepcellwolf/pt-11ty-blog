{"version":3,"file":"anthropic-to-gemini.js","sourceRoot":"","sources":["../../src/proxy/anthropic-to-gemini.ts"],"names":[],"mappings":"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","sourcesContent":["// Anthropic to Gemini Proxy Server\n// Converts Anthropic API format to Google Gemini format\nimport express, { Request, Response, NextFunction } from 'express';\nimport { logger } from '../utils/logger.js';\n\ninterface AnthropicMessage {\n  role: 'user' | 'assistant';\n  content: string | Array<{ type: string; text?: string; [key: string]: any }>;\n}\n\ninterface AnthropicTool {\n  name: string;\n  description?: string;\n  input_schema?: {\n    type: string;\n    properties?: Record<string, any>;\n    required?: string[];\n  };\n}\n\ninterface AnthropicRequest {\n  model?: string;\n  messages: AnthropicMessage[];\n  max_tokens?: number;\n  temperature?: number;\n  system?: string;\n  stream?: boolean;\n  tools?: AnthropicTool[];\n  [key: string]: any;\n}\n\ninterface GeminiPart {\n  text: string;\n}\n\ninterface GeminiContent {\n  role: 'user' | 'model';\n  parts: GeminiPart[];\n}\n\ninterface GeminiTool {\n  functionDeclarations: Array<{\n    name: string;\n    description?: string;\n    parameters?: any;\n  }>;\n}\n\ninterface GeminiRequest {\n  contents: GeminiContent[];\n  generationConfig?: {\n    temperature?: number;\n    maxOutputTokens?: number;\n    [key: string]: any;\n  };\n  tools?: GeminiTool[];\n}\n\nexport class AnthropicToGeminiProxy {\n  private app: express.Application;\n  private geminiApiKey: string;\n  private geminiBaseUrl: string;\n  private defaultModel: string;\n\n  constructor(config: {\n    geminiApiKey: string;\n    geminiBaseUrl?: string;\n    defaultModel?: string;\n  }) {\n    this.app = express();\n    this.geminiApiKey = config.geminiApiKey;\n    this.geminiBaseUrl = config.geminiBaseUrl || 'https://generativelanguage.googleapis.com/v1beta';\n    this.defaultModel = config.defaultModel || 'gemini-2.0-flash-exp';\n\n    this.setupMiddleware();\n    this.setupRoutes();\n  }\n\n  private setupMiddleware(): void {\n    // Parse JSON bodies\n    this.app.use(express.json({ limit: '50mb' }));\n\n    // Logging middleware\n    this.app.use((req: Request, res: Response, next: NextFunction) => {\n      logger.debug('Gemini proxy request', {\n        method: req.method,\n        path: req.path,\n        headers: Object.keys(req.headers)\n      });\n      next();\n    });\n  }\n\n  private setupRoutes(): void {\n    // Health check\n    this.app.get('/health', (req: Request, res: Response) => {\n      res.json({ status: 'ok', service: 'anthropic-to-gemini-proxy' });\n    });\n\n    // Anthropic Messages API → Gemini generateContent\n    this.app.post('/v1/messages', async (req: Request, res: Response) => {\n      try {\n        const anthropicReq: AnthropicRequest = req.body;\n\n        // Convert Anthropic format to Gemini format\n        const geminiReq = this.convertAnthropicToGemini(anthropicReq);\n\n        logger.info('Converting Anthropic request to Gemini', {\n          anthropicModel: anthropicReq.model,\n          geminiModel: this.defaultModel,\n          messageCount: geminiReq.contents.length,\n          stream: anthropicReq.stream,\n          apiKeyPresent: !!this.geminiApiKey,\n          apiKeyPrefix: this.geminiApiKey?.substring(0, 10)\n        });\n\n        // Determine endpoint based on streaming\n        const endpoint = anthropicReq.stream ? 'streamGenerateContent' : 'generateContent';\n        // BUG FIX: Add &alt=sse for streaming to get Server-Sent Events format\n        const streamParam = anthropicReq.stream ? '&alt=sse' : '';\n        const url = `${this.geminiBaseUrl}/models/${this.defaultModel}:${endpoint}?key=${this.geminiApiKey}${streamParam}`;\n\n        // Forward to Gemini\n        const response = await fetch(url, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify(geminiReq)\n        });\n\n        if (!response.ok) {\n          const error = await response.text();\n          logger.error('Gemini API error', { status: response.status, error });\n          return res.status(response.status).json({\n            error: {\n              type: 'api_error',\n              message: error\n            }\n          });\n        }\n\n        // Handle streaming vs non-streaming\n        if (anthropicReq.stream) {\n          // Stream response\n          res.setHeader('Content-Type', 'text/event-stream');\n          res.setHeader('Cache-Control', 'no-cache');\n          res.setHeader('Connection', 'keep-alive');\n\n          const reader = response.body?.getReader();\n          if (!reader) {\n            throw new Error('No response body');\n          }\n\n          const decoder = new TextDecoder();\n          let chunkCount = 0;\n          while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n\n            const chunk = decoder.decode(value);\n            chunkCount++;\n            logger.info('Gemini stream chunk received', { chunkCount, chunkLength: chunk.length, chunkPreview: chunk.substring(0, 200) });\n\n            const anthropicChunk = this.convertGeminiStreamToAnthropic(chunk);\n            logger.info('Anthropic stream chunk generated', { chunkCount, anthropicLength: anthropicChunk.length, anthropicPreview: anthropicChunk.substring(0, 200) });\n\n            res.write(anthropicChunk);\n          }\n\n          logger.info('Gemini stream complete', { totalChunks: chunkCount });\n          res.end();\n        } else {\n          // Non-streaming response\n          const geminiRes = await response.json();\n\n          // DEBUG: Log raw Gemini response\n          logger.info('Raw Gemini API response', {\n            hasResponse: !!geminiRes,\n            hasCandidates: !!geminiRes.candidates,\n            candidatesLength: geminiRes.candidates?.length,\n            firstCandidate: geminiRes.candidates?.[0],\n            fullResponse: JSON.stringify(geminiRes).substring(0, 500)\n          });\n\n          const anthropicRes = this.convertGeminiToAnthropic(geminiRes);\n\n          logger.info('Gemini proxy response sent', {\n            model: this.defaultModel,\n            usage: anthropicRes.usage,\n            contentBlocks: anthropicRes.content?.length,\n            hasText: anthropicRes.content?.some((c: any) => c.type === 'text'),\n            firstContent: anthropicRes.content?.[0]\n          });\n\n          res.json(anthropicRes);\n        }\n      } catch (error: any) {\n        logger.error('Gemini proxy error', { error: error.message, stack: error.stack });\n        res.status(500).json({\n          error: {\n            type: 'proxy_error',\n            message: error.message\n          }\n        });\n      }\n    });\n\n    // Fallback for other Anthropic API endpoints\n    this.app.use((req: Request, res: Response) => {\n      logger.warn('Unsupported endpoint', { path: req.path, method: req.method });\n      res.status(404).json({\n        error: {\n          type: 'not_found',\n          message: `Endpoint ${req.path} not supported by Gemini proxy`\n        }\n      });\n    });\n  }\n\n  private convertAnthropicToGemini(anthropicReq: AnthropicRequest): GeminiRequest {\n    const contents: GeminiContent[] = [];\n\n    // Add system message as first user message if present\n    // Gemini doesn't have a dedicated system role, so we prepend it to the first user message\n    let systemPrefix = '';\n    if (anthropicReq.system) {\n      systemPrefix = `System: ${anthropicReq.system}\\n\\n`;\n    }\n\n    // Add tool instructions for Gemini to understand file operations\n    // Since Gemini doesn't have native tool calling, we instruct it to use structured XML-like commands\n    const toolInstructions = `\nIMPORTANT: You have access to file system operations through structured commands. Use these exact formats:\n\n<file_write path=\"filename.ext\">\ncontent here\n</file_write>\n\n<file_read path=\"filename.ext\"/>\n\n<bash_command>\ncommand here\n</bash_command>\n\nWhen you need to create, edit, or read files, use these structured commands in your response.\nThe system will automatically execute these commands and provide results.\n\n`;\n\n    // Prepend tool instructions to system prompt\n    if (systemPrefix) {\n      systemPrefix = toolInstructions + systemPrefix;\n    } else {\n      systemPrefix = toolInstructions;\n    }\n\n    // Convert Anthropic messages to Gemini format\n    for (let i = 0; i < anthropicReq.messages.length; i++) {\n      const msg = anthropicReq.messages[i];\n      let text: string;\n\n      if (typeof msg.content === 'string') {\n        text = msg.content;\n      } else if (Array.isArray(msg.content)) {\n        // Extract text from content blocks\n        text = msg.content\n          .filter(block => block.type === 'text')\n          .map(block => block.text)\n          .join('\\n');\n      } else {\n        text = '';\n      }\n\n      // Add system prefix to first user message\n      if (i === 0 && msg.role === 'user' && systemPrefix) {\n        text = systemPrefix + text;\n      }\n\n      contents.push({\n        role: msg.role === 'assistant' ? 'model' : 'user',\n        parts: [{ text }]\n      });\n    }\n\n    const geminiReq: GeminiRequest = {\n      contents\n    };\n\n    // Add generation config if temperature or max_tokens specified\n    if (anthropicReq.temperature !== undefined || anthropicReq.max_tokens !== undefined) {\n      geminiReq.generationConfig = {};\n\n      if (anthropicReq.temperature !== undefined) {\n        geminiReq.generationConfig.temperature = anthropicReq.temperature;\n      }\n\n      if (anthropicReq.max_tokens !== undefined) {\n        geminiReq.generationConfig.maxOutputTokens = anthropicReq.max_tokens;\n      }\n    }\n\n    // Convert MCP/Anthropic tools to Gemini tools format\n    if (anthropicReq.tools && anthropicReq.tools.length > 0) {\n      geminiReq.tools = [{\n        functionDeclarations: anthropicReq.tools.map(tool => {\n          // Clean schema: Remove fields that Gemini doesn't support\n          const cleanSchema = (schema: any): any => {\n            if (!schema || typeof schema !== 'object') return schema;\n\n            const {\n              $schema,\n              additionalProperties,\n              exclusiveMinimum,\n              exclusiveMaximum,\n              ...rest\n            } = schema;\n            const cleaned: any = { ...rest };\n\n            // Recursively clean nested objects\n            if (cleaned.properties) {\n              cleaned.properties = Object.fromEntries(\n                Object.entries(cleaned.properties).map(([key, value]: [string, any]) => [\n                  key,\n                  cleanSchema(value)\n                ])\n              );\n            }\n\n            // Clean items if present\n            if (cleaned.items) {\n              cleaned.items = cleanSchema(cleaned.items);\n            }\n\n            return cleaned;\n          };\n\n          return {\n            name: tool.name,\n            description: tool.description || '',\n            parameters: cleanSchema(tool.input_schema) || {\n              type: 'object',\n              properties: {},\n              required: []\n            }\n          };\n        })\n      }];\n\n      logger.info('Forwarding MCP tools to Gemini', {\n        toolCount: anthropicReq.tools.length,\n        toolNames: anthropicReq.tools.map(t => t.name)\n      });\n    }\n\n    return geminiReq;\n  }\n\n  private parseStructuredCommands(text: string): {\n    cleanText: string;\n    toolUses: any[]\n  } {\n    const toolUses: any[] = [];\n    let cleanText = text;\n\n    // Parse file_write commands\n    const fileWriteRegex = /<file_write path=\"([^\"]+)\">([\\s\\S]*?)<\\/file_write>/g;\n    let match;\n    while ((match = fileWriteRegex.exec(text)) !== null) {\n      toolUses.push({\n        type: 'tool_use',\n        id: `tool_${Date.now()}_${toolUses.length}`,\n        name: 'Write',\n        input: {\n          file_path: match[1],\n          content: match[2].trim()\n        }\n      });\n      cleanText = cleanText.replace(match[0], `[File written: ${match[1]}]`);\n    }\n\n    // Parse file_read commands\n    const fileReadRegex = /<file_read path=\"([^\"]+)\"\\/>/g;\n    while ((match = fileReadRegex.exec(text)) !== null) {\n      toolUses.push({\n        type: 'tool_use',\n        id: `tool_${Date.now()}_${toolUses.length}`,\n        name: 'Read',\n        input: {\n          file_path: match[1]\n        }\n      });\n      cleanText = cleanText.replace(match[0], `[Reading file: ${match[1]}]`);\n    }\n\n    // Parse bash commands\n    const bashRegex = /<bash_command>([\\s\\S]*?)<\\/bash_command>/g;\n    while ((match = bashRegex.exec(text)) !== null) {\n      toolUses.push({\n        type: 'tool_use',\n        id: `tool_${Date.now()}_${toolUses.length}`,\n        name: 'Bash',\n        input: {\n          command: match[1].trim()\n        }\n      });\n      cleanText = cleanText.replace(match[0], `[Executing: ${match[1].trim()}]`);\n    }\n\n    return { cleanText: cleanText.trim(), toolUses };\n  }\n\n  private convertGeminiToAnthropic(geminiRes: any): any {\n    const candidate = geminiRes.candidates?.[0];\n    if (!candidate) {\n      logger.error('No candidates in Gemini response', { geminiRes });\n      throw new Error('No candidates in Gemini response');\n    }\n\n    const content = candidate.content;\n    const parts = content?.parts || [];\n\n    logger.info('Converting Gemini to Anthropic', {\n      hasParts: !!parts,\n      partsCount: parts.length,\n      partTypes: parts.map((p: any) => Object.keys(p))\n    });\n\n    // Extract text and function calls\n    let rawText = '';\n    const functionCalls: any[] = [];\n\n    for (const part of parts) {\n      if (part.text) {\n        rawText += part.text;\n        logger.info('Found text in part', { textLength: part.text.length, textPreview: part.text.substring(0, 100) });\n      }\n      if (part.functionCall) {\n        functionCalls.push(part.functionCall);\n      }\n    }\n\n    logger.info('Extracted content from Gemini', {\n      rawTextLength: rawText.length,\n      functionCallsCount: functionCalls.length,\n      rawTextPreview: rawText.substring(0, 200)\n    });\n\n    // Parse structured commands from Gemini's text response\n    const { cleanText, toolUses } = this.parseStructuredCommands(rawText);\n\n    // Build content array with text and tool uses\n    const contentBlocks: any[] = [];\n\n    if (cleanText) {\n      contentBlocks.push({\n        type: 'text',\n        text: cleanText\n      });\n    }\n\n    // Add tool uses from structured commands\n    contentBlocks.push(...toolUses);\n\n    // Add tool uses from Gemini function calls (MCP tools)\n    if (functionCalls.length > 0) {\n      for (const functionCall of functionCalls) {\n        contentBlocks.push({\n          type: 'tool_use',\n          id: `tool_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n          name: functionCall.name,\n          input: functionCall.args || {}\n        });\n      }\n\n      logger.info('Converted Gemini function calls to Anthropic format', {\n        functionCallCount: functionCalls.length,\n        functionNames: functionCalls.map((fc: any) => fc.name)\n      });\n    }\n\n    return {\n      id: `msg_${Date.now()}`,\n      type: 'message',\n      role: 'assistant',\n      model: this.defaultModel,\n      content: contentBlocks.length > 0 ? contentBlocks : [\n        {\n          type: 'text',\n          text: rawText\n        }\n      ],\n      stop_reason: this.mapFinishReason(candidate.finishReason),\n      usage: {\n        input_tokens: geminiRes.usageMetadata?.promptTokenCount || 0,\n        output_tokens: geminiRes.usageMetadata?.candidatesTokenCount || 0\n      }\n    };\n  }\n\n  private convertGeminiStreamToAnthropic(chunk: string): string {\n    // Gemini streaming returns Server-Sent Events format: \"data: {json}\"\n    const lines = chunk.split('\\n').filter(line => line.trim());\n    const anthropicChunks: string[] = [];\n\n    for (const line of lines) {\n      try {\n        // Parse SSE format: \"data: {json}\"\n        if (line.startsWith('data: ')) {\n          const jsonStr = line.substring(6); // Remove \"data: \" prefix\n          const parsed = JSON.parse(jsonStr);\n          const candidate = parsed.candidates?.[0];\n          const text = candidate?.content?.parts?.[0]?.text;\n\n          if (text) {\n            anthropicChunks.push(\n              `event: content_block_delta\\ndata: ${JSON.stringify({\n                type: 'content_block_delta',\n                delta: { type: 'text_delta', text }\n              })}\\n\\n`\n            );\n          }\n\n          // Check for finish\n          if (candidate?.finishReason) {\n            anthropicChunks.push('event: message_stop\\ndata: {}\\n\\n');\n          }\n        }\n      } catch (e) {\n        // Ignore parse errors\n        logger.debug('Failed to parse Gemini stream chunk', { line, error: (e as Error).message });\n      }\n    }\n\n    return anthropicChunks.join('');\n  }\n\n  private mapFinishReason(reason?: string): string {\n    const mapping: Record<string, string> = {\n      'STOP': 'end_turn',\n      'MAX_TOKENS': 'max_tokens',\n      'SAFETY': 'stop_sequence',\n      'RECITATION': 'stop_sequence',\n      'OTHER': 'end_turn'\n    };\n    return mapping[reason || 'STOP'] || 'end_turn';\n  }\n\n  public start(port: number): void {\n    this.app.listen(port, () => {\n      logger.info('Anthropic to Gemini proxy started', {\n        port,\n        geminiBaseUrl: this.geminiBaseUrl,\n        defaultModel: this.defaultModel\n      });\n      console.log(`\\n✅ Gemini Proxy running at http://localhost:${port}`);\n      console.log(`   Gemini Base URL: ${this.geminiBaseUrl}`);\n      console.log(`   Default Model: ${this.defaultModel}\\n`);\n    });\n  }\n}\n\n// CLI entry point\nif (import.meta.url === `file://${process.argv[1]}`) {\n  const port = parseInt(process.env.PORT || '3001');\n  const geminiApiKey = process.env.GOOGLE_GEMINI_API_KEY;\n\n  if (!geminiApiKey) {\n    console.error('❌ Error: GOOGLE_GEMINI_API_KEY environment variable required');\n    process.exit(1);\n  }\n\n  const proxy = new AnthropicToGeminiProxy({\n    geminiApiKey,\n    geminiBaseUrl: process.env.GEMINI_BASE_URL,\n    defaultModel: process.env.COMPLETION_MODEL || process.env.REASONING_MODEL\n  });\n\n  proxy.start(port);\n}\n"]}