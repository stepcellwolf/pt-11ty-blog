{"version":3,"file":"anthropic-to-onnx.js","sourceRoot":"","sources":["../../src/proxy/anthropic-to-onnx.ts"],"names":[],"mappings":"AAAA,uCAAuC;AACvC,gEAAgE;AAChE,OAAO,OAA4C,MAAM,SAAS,CAAC;AACnE,OAAO,EAAE,MAAM,EAAE,MAAM,oBAAoB,CAAC;AAC5C,OAAO,EAAE,iBAAiB,EAAE,MAAM,mCAAmC,CAAC;AA+BtE,MAAM,OAAO,oBAAoB;IACvB,GAAG,CAAsB;IACzB,YAAY,CAAoB;IAChC,IAAI,CAAS;IACb,MAAM,CAAM;IAEpB,YAAY,SAIR,EAAE;QACJ,IAAI,CAAC,GAAG,GAAG,OAAO,EAAE,CAAC;QACrB,IAAI,CAAC,IAAI,GAAG,MAAM,CAAC,IAAI,IAAI,IAAI,CAAC;QAEhC,8CAA8C;QAC9C,IAAI,CAAC,YAAY,GAAG,IAAI,iBAAiB,CAAC;YACxC,SAAS,EAAE,MAAM,CAAC,SAAS;YAC3B,kBAAkB,EAAE,MAAM,CAAC,kBAAkB,IAAI,CAAC,KAAK,CAAC;YACxD,SAAS,EAAE,GAAG;YACd,WAAW,EAAE,GAAG;SACjB,CAAC,CAAC;QAEH,IAAI,CAAC,eAAe,EAAE,CAAC;QACvB,IAAI,CAAC,WAAW,EAAE,CAAC;IACrB,CAAC;IAEO,eAAe;QACrB,oBAAoB;QACpB,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC,CAAC;QAE9C,qBAAqB;QACrB,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;YAC/D,MAAM,CAAC,KAAK,CAAC,oBAAoB,EAAE;gBACjC,MAAM,EAAE,GAAG,CAAC,MAAM;gBAClB,IAAI,EAAE,GAAG,CAAC,IAAI;gBACd,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC;aAClC,CAAC,CAAC;YACH,IAAI,EAAE,CAAC;QACT,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,WAAW;QACjB,eAAe;QACf,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,SAAS,EAAE,CAAC,GAAY,EAAE,GAAa,EAAE,EAAE;YACtD,MAAM,SAAS,GAAG,IAAI,CAAC,YAAY,CAAC,YAAY,EAAE,CAAC;YACnD,GAAG,CAAC,IAAI,CAAC;gBACP,MAAM,EAAE,IAAI;gBACZ,OAAO,EAAE,yBAAyB;gBAClC,IAAI,EAAE;oBACJ,WAAW,EAAE,SAAS,CAAC,WAAW;oBAClC,eAAe,EAAE,SAAS,CAAC,eAAe;oBAC1C,kBAAkB,EAAE,SAAS,CAAC,kBAAkB;iBACjD;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,gDAAgD;QAChD,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,cAAc,EAAE,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;YAClE,IAAI,CAAC;gBACH,MAAM,YAAY,GAAqB,GAAG,CAAC,IAAI,CAAC;gBAEhD,wBAAwB;gBACxB,IAAI,YAAY,GAAG,EAAE,CAAC;gBACtB,IAAI,OAAO,YAAY,CAAC,MAAM,KAAK,QAAQ,EAAE,CAAC;oBAC5C,YAAY,GAAG,YAAY,CAAC,MAAM,CAAC;gBACrC,CAAC;qBAAM,IAAI,KAAK,CAAC,OAAO,CAAC,YAAY,CAAC,MAAM,CAAC,EAAE,CAAC;oBAC9C,YAAY,GAAG,YAAY,CAAC,MAAM;yBAC/B,MAAM,CAAC,CAAC,KAAU,EAAE,EAAE,CAAC,KAAK,CAAC,IAAI,KAAK,MAAM,CAAC;yBAC7C,GAAG,CAAC,CAAC,KAAU,EAAE,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC;yBAC/B,IAAI,CAAC,IAAI,CAAC,CAAC;gBAChB,CAAC;gBAED,MAAM,CAAC,IAAI,CAAC,sCAAsC,EAAE;oBAClD,cAAc,EAAE,YAAY,CAAC,KAAK;oBAClC,SAAS,EAAE,qBAAqB;oBAChC,YAAY,EAAE,YAAY,CAAC,QAAQ,CAAC,MAAM;oBAC1C,kBAAkB,EAAE,YAAY,CAAC,MAAM;oBACvC,SAAS,EAAE,YAAY,CAAC,UAAU;oBAClC,WAAW,EAAE,YAAY,CAAC,WAAW;iBACtC,CAAC,CAAC;gBAEH,gDAAgD;gBAChD,MAAM,QAAQ,GAAc,EAAE,CAAC;gBAE/B,gCAAgC;gBAChC,IAAI,YAAY,EAAE,CAAC;oBACjB,QAAQ,CAAC,IAAI,CAAC;wBACZ,IAAI,EAAE,QAAQ;wBACd,OAAO,EAAE,YAAY;qBACtB,CAAC,CAAC;gBACL,CAAC;gBAED,8BAA8B;gBAC9B,KAAK,MAAM,GAAG,IAAI,YAAY,CAAC,QAAQ,EAAE,CAAC;oBACxC,IAAI,OAAe,CAAC;oBACpB,IAAI,OAAO,GAAG,CAAC,OAAO,KAAK,QAAQ,EAAE,CAAC;wBACpC,OAAO,GAAG,GAAG,CAAC,OAAO,CAAC;oBACxB,CAAC;yBAAM,CAAC;wBACN,OAAO,GAAG,GAAG,CAAC,OAAO;6BAClB,MAAM,CAAC,CAAC,KAAU,EAAE,EAAE,CAAC,KAAK,CAAC,IAAI,KAAK,MAAM,CAAC;6BAC7C,GAAG,CAAC,CAAC,KAAU,EAAE,EAAE,CAAC,KAAK,CAAC,IAAI,IAAI,EAAE,CAAC;6BACrC,IAAI,CAAC,IAAI,CAAC,CAAC;oBAChB,CAAC;oBAED,QAAQ,CAAC,IAAI,CAAC;wBACZ,IAAI,EAAE,GAAG,CAAC,IAAI;wBACd,OAAO;qBACR,CAAC,CAAC;gBACL,CAAC;gBAED,+CAA+C;gBAC/C,IAAI,YAAY,CAAC,MAAM,EAAE,CAAC;oBACxB,MAAM,CAAC,IAAI,CAAC,uFAAuF,CAAC,CAAC;gBACvG,CAAC;gBAED,qBAAqB;gBACrB,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC;oBAC1C,KAAK,EAAE,qBAAqB;oBAC5B,QAAQ;oBACR,SAAS,EAAE,YAAY,CAAC,UAAU,IAAI,GAAG;oBACzC,WAAW,EAAE,YAAY,CAAC,WAAW,IAAI,GAAG;iBAC7C,CAAC,CAAC;gBAEH,4CAA4C;gBAC5C,MAAM,iBAAiB,GAAsB;oBAC3C,EAAE,EAAE,MAAM,CAAC,EAAE;oBACb,IAAI,EAAE,SAAS;oBACf,IAAI,EAAE,WAAW;oBACjB,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;wBACpC,IAAI,EAAE,MAAM;wBACZ,IAAI,EAAE,KAAK,CAAC,IAAI,IAAI,EAAE;qBACvB,CAAC,CAAC;oBACH,KAAK,EAAE,gCAAgC;oBACvC,WAAW,EAAE,MAAM,CAAC,UAAU,IAAI,UAAU;oBAC5C,KAAK,EAAE;wBACL,YAAY,EAAE,MAAM,CAAC,KAAK,EAAE,WAAW,IAAI,CAAC;wBAC5C,aAAa,EAAE,MAAM,CAAC,KAAK,EAAE,YAAY,IAAI,CAAC;qBAC/C;iBACF,CAAC;gBAEF,MAAM,CAAC,IAAI,CAAC,0BAA0B,EAAE;oBACtC,WAAW,EAAE,MAAM,CAAC,KAAK,EAAE,WAAW,IAAI,CAAC;oBAC3C,YAAY,EAAE,MAAM,CAAC,KAAK,EAAE,YAAY,IAAI,CAAC;oBAC7C,OAAO,EAAE,MAAM,CAAC,QAAQ,EAAE,OAAO;oBACjC,eAAe,EAAE,MAAM,CAAC,QAAQ,EAAE,eAAe;iBAClD,CAAC,CAAC;gBAEH,GAAG,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;YAE9B,CAAC;YAAC,OAAO,KAAU,EAAE,CAAC;gBACpB,MAAM,CAAC,KAAK,CAAC,kBAAkB,EAAE;oBAC/B,KAAK,EAAE,KAAK,CAAC,OAAO;oBACpB,QAAQ,EAAE,KAAK,CAAC,QAAQ;oBACxB,SAAS,EAAE,KAAK,CAAC,SAAS;iBAC3B,CAAC,CAAC;gBAEH,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;oBACnB,KAAK,EAAE;wBACL,IAAI,EAAE,WAAW;wBACjB,OAAO,EAAE,0BAA0B,KAAK,CAAC,OAAO,EAAE;qBACnD;iBACF,CAAC,CAAC;YACL,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,cAAc;QACd,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,GAAY,EAAE,GAAa,EAAE,EAAE;YAC3C,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,KAAK,EAAE;oBACL,IAAI,EAAE,WAAW;oBACjB,OAAO,EAAE,oBAAoB,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,EAAE;iBACtD;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAED,KAAK;QACH,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAC7B,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,EAAE;gBAC5C,MAAM,CAAC,IAAI,CAAC,2BAA2B,EAAE;oBACvC,IAAI,EAAE,IAAI,CAAC,IAAI;oBACf,QAAQ,EAAE,oBAAoB,IAAI,CAAC,IAAI,EAAE;oBACzC,WAAW,EAAE,oBAAoB,IAAI,CAAC,IAAI,SAAS;oBACnD,gBAAgB,EAAE,oBAAoB,IAAI,CAAC,IAAI,cAAc;iBAC9D,CAAC,CAAC;gBACH,OAAO,CAAC,GAAG,CAAC,sDAAsD,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;gBAC/E,OAAO,CAAC,GAAG,CAAC,6CAA6C,IAAI,CAAC,IAAI,cAAc,CAAC,CAAC;gBAClF,OAAO,CAAC,GAAG,CAAC,6CAA6C,IAAI,CAAC,IAAI,WAAW,CAAC,CAAC;gBAC/E,OAAO,EAAE,CAAC;YACZ,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAED,IAAI;QACF,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAC7B,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;gBAChB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,EAAE;oBACrB,MAAM,CAAC,IAAI,CAAC,2BAA2B,CAAC,CAAC;oBACzC,OAAO,EAAE,CAAC;gBACZ,CAAC,CAAC,CAAC;YACL,CAAC;iBAAM,CAAC;gBACN,OAAO,EAAE,CAAC;YACZ,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,OAAO;QACX,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;QAClB,MAAM,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE,CAAC;IACpC,CAAC;CACF;AAED,kBAAkB;AAClB,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,KAAK,UAAU,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC;IACpD,MAAM,KAAK,GAAG,IAAI,oBAAoB,CAAC;QACrC,IAAI,EAAE,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,eAAe,IAAI,MAAM,CAAC;KACtD,CAAC,CAAC;IAEH,KAAK,CAAC,KAAK,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;QAC1B,OAAO,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;QACpD,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAClB,CAAC,CAAC,CAAC;IAEH,oBAAoB;IACpB,OAAO,CAAC,EAAE,CAAC,QAAQ,EAAE,KAAK,IAAI,EAAE;QAC9B,OAAO,CAAC,GAAG,CAAC,kCAAkC,CAAC,CAAC;QAChD,MAAM,KAAK,CAAC,OAAO,EAAE,CAAC;QACtB,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAClB,CAAC,CAAC,CAAC;IAEH,OAAO,CAAC,EAAE,CAAC,SAAS,EAAE,KAAK,IAAI,EAAE;QAC/B,OAAO,CAAC,GAAG,CAAC,kCAAkC,CAAC,CAAC;QAChD,MAAM,KAAK,CAAC,OAAO,EAAE,CAAC;QACtB,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAClB,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["// Anthropic to ONNX Local Proxy Server\n// Converts Anthropic API format to ONNX Runtime local inference\nimport express, { Request, Response, NextFunction } from 'express';\nimport { logger } from '../utils/logger.js';\nimport { ONNXLocalProvider } from '../router/providers/onnx-local.js';\nimport type { Message } from '../router/types.js';\n\ninterface AnthropicMessage {\n  role: 'user' | 'assistant';\n  content: string | Array<{ type: string; text?: string; [key: string]: any }>;\n}\n\ninterface AnthropicRequest {\n  model?: string;\n  messages: AnthropicMessage[];\n  max_tokens?: number;\n  temperature?: number;\n  system?: string | Array<{ type: string; text?: string; [key: string]: any }>;\n  stream?: boolean;\n  [key: string]: any;\n}\n\ninterface AnthropicResponse {\n  id: string;\n  type: 'message';\n  role: 'assistant';\n  content: Array<{ type: 'text'; text: string }>;\n  model: string;\n  stop_reason: string;\n  usage: {\n    input_tokens: number;\n    output_tokens: number;\n  };\n}\n\nexport class AnthropicToONNXProxy {\n  private app: express.Application;\n  private onnxProvider: ONNXLocalProvider;\n  private port: number;\n  private server: any;\n\n  constructor(config: {\n    port?: number;\n    modelPath?: string;\n    executionProviders?: string[];\n  } = {}) {\n    this.app = express();\n    this.port = config.port || 3001;\n\n    // Initialize ONNX provider with configuration\n    this.onnxProvider = new ONNXLocalProvider({\n      modelPath: config.modelPath,\n      executionProviders: config.executionProviders || ['cpu'],\n      maxTokens: 512,\n      temperature: 0.7\n    });\n\n    this.setupMiddleware();\n    this.setupRoutes();\n  }\n\n  private setupMiddleware(): void {\n    // Parse JSON bodies\n    this.app.use(express.json({ limit: '50mb' }));\n\n    // Logging middleware\n    this.app.use((req: Request, res: Response, next: NextFunction) => {\n      logger.debug('ONNX proxy request', {\n        method: req.method,\n        path: req.path,\n        headers: Object.keys(req.headers)\n      });\n      next();\n    });\n  }\n\n  private setupRoutes(): void {\n    // Health check\n    this.app.get('/health', (req: Request, res: Response) => {\n      const modelInfo = this.onnxProvider.getModelInfo();\n      res.json({\n        status: 'ok',\n        service: 'anthropic-to-onnx-proxy',\n        onnx: {\n          initialized: modelInfo.initialized,\n          tokenizerLoaded: modelInfo.tokenizerLoaded,\n          executionProviders: modelInfo.executionProviders\n        }\n      });\n    });\n\n    // Anthropic Messages API ‚Üí ONNX Local Inference\n    this.app.post('/v1/messages', async (req: Request, res: Response) => {\n      try {\n        const anthropicReq: AnthropicRequest = req.body;\n\n        // Extract system prompt\n        let systemPrompt = '';\n        if (typeof anthropicReq.system === 'string') {\n          systemPrompt = anthropicReq.system;\n        } else if (Array.isArray(anthropicReq.system)) {\n          systemPrompt = anthropicReq.system\n            .filter((block: any) => block.type === 'text')\n            .map((block: any) => block.text)\n            .join('\\n');\n        }\n\n        logger.info('Converting Anthropic request to ONNX', {\n          anthropicModel: anthropicReq.model,\n          onnxModel: 'Phi-4-mini-instruct',\n          messageCount: anthropicReq.messages.length,\n          systemPromptLength: systemPrompt.length,\n          maxTokens: anthropicReq.max_tokens,\n          temperature: anthropicReq.temperature\n        });\n\n        // Convert Anthropic messages to internal format\n        const messages: Message[] = [];\n\n        // Add system message if present\n        if (systemPrompt) {\n          messages.push({\n            role: 'system',\n            content: systemPrompt\n          });\n        }\n\n        // Add user/assistant messages\n        for (const msg of anthropicReq.messages) {\n          let content: string;\n          if (typeof msg.content === 'string') {\n            content = msg.content;\n          } else {\n            content = msg.content\n              .filter((block: any) => block.type === 'text')\n              .map((block: any) => block.text || '')\n              .join('\\n');\n          }\n\n          messages.push({\n            role: msg.role,\n            content\n          });\n        }\n\n        // Streaming not supported by ONNX provider yet\n        if (anthropicReq.stream) {\n          logger.warn('Streaming requested but not supported by ONNX provider, falling back to non-streaming');\n        }\n\n        // Run ONNX inference\n        const result = await this.onnxProvider.chat({\n          model: 'phi-4-mini-instruct',\n          messages,\n          maxTokens: anthropicReq.max_tokens || 512,\n          temperature: anthropicReq.temperature || 0.7\n        });\n\n        // Convert ONNX response to Anthropic format\n        const anthropicResponse: AnthropicResponse = {\n          id: result.id,\n          type: 'message',\n          role: 'assistant',\n          content: result.content.map(block => ({\n            type: 'text',\n            text: block.text || ''\n          })),\n          model: 'onnx-local/phi-4-mini-instruct',\n          stop_reason: result.stopReason || 'end_turn',\n          usage: {\n            input_tokens: result.usage?.inputTokens || 0,\n            output_tokens: result.usage?.outputTokens || 0\n          }\n        };\n\n        logger.info('ONNX inference completed', {\n          inputTokens: result.usage?.inputTokens || 0,\n          outputTokens: result.usage?.outputTokens || 0,\n          latency: result.metadata?.latency,\n          tokensPerSecond: result.metadata?.tokensPerSecond\n        });\n\n        res.json(anthropicResponse);\n\n      } catch (error: any) {\n        logger.error('ONNX proxy error', {\n          error: error.message,\n          provider: error.provider,\n          retryable: error.retryable\n        });\n\n        res.status(500).json({\n          error: {\n            type: 'api_error',\n            message: `ONNX inference failed: ${error.message}`\n          }\n        });\n      }\n    });\n\n    // 404 handler\n    this.app.use((req: Request, res: Response) => {\n      res.status(404).json({\n        error: {\n          type: 'not_found',\n          message: `Route not found: ${req.method} ${req.path}`\n        }\n      });\n    });\n  }\n\n  start(): Promise<void> {\n    return new Promise((resolve) => {\n      this.server = this.app.listen(this.port, () => {\n        logger.info('ONNX proxy server started', {\n          port: this.port,\n          endpoint: `http://localhost:${this.port}`,\n          healthCheck: `http://localhost:${this.port}/health`,\n          messagesEndpoint: `http://localhost:${this.port}/v1/messages`\n        });\n        console.log(`\\nüöÄ ONNX Proxy Server running on http://localhost:${this.port}`);\n        console.log(`   üìã Messages API: POST http://localhost:${this.port}/v1/messages`);\n        console.log(`   ‚ù§Ô∏è  Health check: GET http://localhost:${this.port}/health\\n`);\n        resolve();\n      });\n    });\n  }\n\n  stop(): Promise<void> {\n    return new Promise((resolve) => {\n      if (this.server) {\n        this.server.close(() => {\n          logger.info('ONNX proxy server stopped');\n          resolve();\n        });\n      } else {\n        resolve();\n      }\n    });\n  }\n\n  async dispose(): Promise<void> {\n    await this.stop();\n    await this.onnxProvider.dispose();\n  }\n}\n\n// CLI entry point\nif (import.meta.url === `file://${process.argv[1]}`) {\n  const proxy = new AnthropicToONNXProxy({\n    port: parseInt(process.env.ONNX_PROXY_PORT || '3001')\n  });\n\n  proxy.start().catch(error => {\n    console.error('Failed to start ONNX proxy:', error);\n    process.exit(1);\n  });\n\n  // Graceful shutdown\n  process.on('SIGINT', async () => {\n    console.log('\\nüõë Shutting down ONNX proxy...');\n    await proxy.dispose();\n    process.exit(0);\n  });\n\n  process.on('SIGTERM', async () => {\n    console.log('\\nüõë Shutting down ONNX proxy...');\n    await proxy.dispose();\n    process.exit(0);\n  });\n}\n"]}