{"version":3,"file":"FederationHubClient.js","sourceRoot":"","sources":["../../src/federation/FederationHubClient.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Federation Hub Client - WebSocket client for agent-to-hub communication\n */\n\nimport WebSocket from 'ws';\nimport { logger } from '../utils/logger.js';\n// AgentDB is optional - federation works with SQLite only\ntype AgentDB = any;\n\nexport interface HubClientConfig {\n  endpoint: string;\n  agentId: string;\n  tenantId: string;\n  token: string;\n}\n\nexport interface SyncMessage {\n  type: 'auth' | 'pull' | 'push' | 'ack' | 'error';\n  agentId?: string;\n  tenantId?: string;\n  token?: string;\n  vectorClock?: Record<string, number>;\n  data?: any[];\n  error?: string;\n  timestamp: number;\n}\n\nexport class FederationHubClient {\n  private config: HubClientConfig;\n  private ws?: WebSocket;\n  private connected: boolean = false;\n  private vectorClock: Record<string, number> = {};\n  private lastSyncTime: number = 0;\n  private messageHandlers: Map<string, (msg: SyncMessage) => void> = new Map();\n\n  constructor(config: HubClientConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Connect to hub with WebSocket\n   */\n  async connect(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      try {\n        // Convert quic:// to ws:// for WebSocket connection\n        const wsEndpoint = this.config.endpoint\n          .replace('quic://', 'ws://')\n          .replace(':4433', ':8443'); // Map QUIC port to WebSocket port\n\n        logger.info('Connecting to federation hub', {\n          endpoint: wsEndpoint,\n          agentId: this.config.agentId\n        });\n\n        this.ws = new WebSocket(wsEndpoint);\n\n        this.ws.on('open', async () => {\n          logger.info('WebSocket connected, authenticating...');\n\n          // Send authentication\n          await this.send({\n            type: 'auth',\n            agentId: this.config.agentId,\n            tenantId: this.config.tenantId,\n            token: this.config.token,\n            vectorClock: this.vectorClock,\n            timestamp: Date.now()\n          });\n\n          // Wait for auth acknowledgment\n          const authTimeout = setTimeout(() => {\n            reject(new Error('Authentication timeout'));\n          }, 5000);\n\n          const authHandler = (msg: SyncMessage) => {\n            if (msg.type === 'ack') {\n              clearTimeout(authTimeout);\n              this.connected = true;\n              this.lastSyncTime = Date.now();\n              logger.info('Authenticated with hub');\n              resolve();\n            } else if (msg.type === 'error') {\n              clearTimeout(authTimeout);\n              reject(new Error(msg.error || 'Authentication failed'));\n            }\n          };\n\n          this.messageHandlers.set('auth', authHandler);\n        });\n\n        this.ws.on('message', (data: Buffer) => {\n          try {\n            const message: SyncMessage = JSON.parse(data.toString());\n            this.handleMessage(message);\n          } catch (error: any) {\n            logger.error('Failed to parse message', { error: error.message });\n          }\n        });\n\n        this.ws.on('close', () => {\n          this.connected = false;\n          logger.info('Disconnected from hub');\n        });\n\n        this.ws.on('error', (error) => {\n          logger.error('WebSocket error', { error: error.message });\n          reject(error);\n        });\n\n      } catch (error: any) {\n        logger.error('Failed to connect to hub', { error: error.message });\n        reject(error);\n      }\n    });\n  }\n\n  /**\n   * Handle incoming message\n   */\n  private handleMessage(message: SyncMessage): void {\n    // Check for specific handlers first\n    const handler = this.messageHandlers.get('auth');\n    if (handler) {\n      handler(message);\n      this.messageHandlers.delete('auth');\n      return;\n    }\n\n    // Handle sync responses\n    if (message.type === 'ack' && message.data) {\n      logger.debug('Received sync data', { count: message.data.length });\n    } else if (message.type === 'error') {\n      logger.error('Hub error', { error: message.error });\n    }\n\n    // Update vector clock if provided\n    if (message.vectorClock) {\n      this.updateVectorClock(message.vectorClock);\n    }\n  }\n\n  /**\n   * Sync with hub\n   */\n  async sync(db: AgentDB): Promise<void> {\n    if (!this.connected) {\n      throw new Error('Not connected to hub');\n    }\n\n    const startTime = Date.now();\n\n    try {\n      // Increment vector clock\n      this.vectorClock[this.config.agentId] =\n        (this.vectorClock[this.config.agentId] || 0) + 1;\n\n      // PULL: Get updates from hub\n      await this.send({\n        type: 'pull',\n        agentId: this.config.agentId,\n        tenantId: this.config.tenantId,\n        vectorClock: this.vectorClock,\n        timestamp: Date.now()\n      });\n\n      // Wait for response (simplified for now)\n      await new Promise(resolve => setTimeout(resolve, 100));\n\n      // PUSH: Send local changes to hub\n      const localChanges = await this.getLocalChanges(db);\n\n      if (localChanges.length > 0) {\n        await this.send({\n          type: 'push',\n          agentId: this.config.agentId,\n          tenantId: this.config.tenantId,\n          vectorClock: this.vectorClock,\n          data: localChanges,\n          timestamp: Date.now()\n        });\n\n        logger.info('Sync completed', {\n          agentId: this.config.agentId,\n          pushCount: localChanges.length,\n          duration: Date.now() - startTime\n        });\n      }\n\n      this.lastSyncTime = Date.now();\n\n    } catch (error: any) {\n      logger.error('Sync failed', { error: error.message });\n      throw error;\n    }\n  }\n\n  /**\n   * Get local changes from database\n   */\n  private async getLocalChanges(db: AgentDB): Promise<any[]> {\n    // Query recent episodes from local database\n    // This is a simplified version - in production, track changes since last sync\n\n    try {\n      // Get recent patterns from AgentDB\n      // For now, return empty array as placeholder\n      return [];\n    } catch (error) {\n      logger.error('Failed to get local changes', { error });\n      return [];\n    }\n  }\n\n  /**\n   * Update vector clock\n   */\n  private updateVectorClock(remoteVectorClock: Record<string, number>): void {\n    for (const [agentId, ts] of Object.entries(remoteVectorClock)) {\n      this.vectorClock[agentId] = Math.max(\n        this.vectorClock[agentId] || 0,\n        ts\n      );\n    }\n  }\n\n  /**\n   * Send message to hub\n   */\n  private async send(message: SyncMessage): Promise<void> {\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\n      throw new Error('WebSocket not connected');\n    }\n\n    this.ws.send(JSON.stringify(message));\n  }\n\n  /**\n   * Disconnect from hub\n   */\n  async disconnect(): Promise<void> {\n    if (this.ws) {\n      this.ws.close();\n      this.ws = undefined;\n    }\n    this.connected = false;\n  }\n\n  /**\n   * Check connection status\n   */\n  isConnected(): boolean {\n    return this.connected;\n  }\n\n  /**\n   * Get sync stats\n   */\n  getSyncStats(): { lastSyncTime: number; vectorClock: Record<string, number> } {\n    return {\n      lastSyncTime: this.lastSyncTime,\n      vectorClock: { ...this.vectorClock }\n    };\n  }\n}\n"]}