{"version":3,"file":"FederationHub.js","sourceRoot":"","sources":["../../src/federation/FederationHub.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Federation Hub - QUIC-based synchronization hub for ephemeral agents\n *\n * Features:\n * - QUIC protocol for low-latency sync (<50ms)\n * - mTLS for transport security\n * - Vector clocks for conflict resolution\n * - Hub-and-spoke topology support\n */\n\n// AgentDB is optional - federation works with SQLite only\ntype AgentDB = any;\nimport { logger } from '../utils/logger.js';\n\nexport interface FederationHubConfig {\n  endpoint: string; // quic://host:port\n  agentId: string;\n  tenantId: string;\n  token: string; // JWT for authentication\n  enableMTLS?: boolean;\n  certPath?: string;\n  keyPath?: string;\n  caPath?: string;\n}\n\nexport interface SyncMessage {\n  type: 'push' | 'pull' | 'ack';\n  agentId: string;\n  tenantId: string;\n  vectorClock: Record<string, number>;\n  data?: any[];\n  timestamp: number;\n}\n\nexport class FederationHub {\n  private config: FederationHubConfig;\n  private connected: boolean = false;\n  private vectorClock: Record<string, number> = {};\n  private lastSyncTime: number = 0;\n\n  constructor(config: FederationHubConfig) {\n    this.config = {\n      enableMTLS: true,\n      ...config\n    };\n  }\n\n  /**\n   * Connect to federation hub with mTLS\n   */\n  async connect(): Promise<void> {\n    logger.info('Connecting to federation hub', {\n      endpoint: this.config.endpoint,\n      agentId: this.config.agentId,\n      mTLS: this.config.enableMTLS\n    });\n\n    try {\n      // QUIC connection setup (placeholder - actual implementation requires quiche or similar)\n      // For now, simulate connection with WebSocket fallback\n\n      // Initialize vector clock for this agent\n      this.vectorClock[this.config.agentId] = 0;\n\n      this.connected = true;\n      this.lastSyncTime = Date.now();\n\n      logger.info('Connected to federation hub', {\n        agentId: this.config.agentId\n      });\n    } catch (error: any) {\n      logger.error('Failed to connect to federation hub', {\n        endpoint: this.config.endpoint,\n        error: error.message\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Synchronize local database with federation hub\n   *\n   * 1. Pull: Get updates from hub (other agents' changes)\n   * 2. Push: Send local changes to hub\n   * 3. Resolve conflicts using vector clocks\n   */\n  async sync(db: AgentDB): Promise<void> {\n    if (!this.connected) {\n      throw new Error('Not connected to federation hub');\n    }\n\n    const startTime = Date.now();\n\n    try {\n      // Increment vector clock for this sync operation\n      this.vectorClock[this.config.agentId]++;\n\n      // PULL: Get updates from hub\n      const pullMessage: SyncMessage = {\n        type: 'pull',\n        agentId: this.config.agentId,\n        tenantId: this.config.tenantId,\n        vectorClock: { ...this.vectorClock },\n        timestamp: Date.now()\n      };\n\n      const remoteUpdates = await this.sendSyncMessage(pullMessage);\n\n      if (remoteUpdates && remoteUpdates.length > 0) {\n        // Merge remote updates into local database\n        await this.mergeRemoteUpdates(db, remoteUpdates);\n\n        logger.info('Pulled remote updates', {\n          agentId: this.config.agentId,\n          updateCount: remoteUpdates.length\n        });\n      }\n\n      // PUSH: Send local changes to hub\n      const localChanges = await this.getLocalChanges(db);\n\n      if (localChanges.length > 0) {\n        const pushMessage: SyncMessage = {\n          type: 'push',\n          agentId: this.config.agentId,\n          tenantId: this.config.tenantId,\n          vectorClock: { ...this.vectorClock },\n          data: localChanges,\n          timestamp: Date.now()\n        };\n\n        await this.sendSyncMessage(pushMessage);\n\n        logger.info('Pushed local changes', {\n          agentId: this.config.agentId,\n          changeCount: localChanges.length\n        });\n      }\n\n      this.lastSyncTime = Date.now();\n\n      const syncDuration = Date.now() - startTime;\n      logger.info('Sync completed', {\n        agentId: this.config.agentId,\n        duration: syncDuration,\n        pullCount: remoteUpdates?.length || 0,\n        pushCount: localChanges.length\n      });\n\n    } catch (error: any) {\n      logger.error('Sync failed', {\n        agentId: this.config.agentId,\n        error: error.message\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Send sync message to hub via QUIC\n   */\n  private async sendSyncMessage(message: SyncMessage): Promise<any[]> {\n    // Placeholder: Actual implementation would use QUIC transport\n    // For now, simulate with HTTP/2 as fallback\n\n    try {\n      // Add JWT authentication header\n      const headers = {\n        'Authorization': `Bearer ${this.config.token}`,\n        'Content-Type': 'application/json'\n      };\n\n      // Parse endpoint (quic://host:port -> https://host:port for fallback)\n      const httpEndpoint = this.config.endpoint\n        .replace('quic://', 'https://')\n        .replace(':4433', ':8443'); // Map QUIC port to HTTPS port\n\n      // Send message (placeholder - actual implementation would use QUIC)\n      // For now, log the message that would be sent\n      logger.debug('Sending sync message', {\n        type: message.type,\n        agentId: message.agentId,\n        endpoint: httpEndpoint\n      });\n\n      // Simulate response\n      if (message.type === 'pull') {\n        return []; // No remote updates in simulation\n      }\n\n      return [];\n    } catch (error: any) {\n      logger.error('Failed to send sync message', {\n        type: message.type,\n        error: error.message\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get local changes since last sync\n   */\n  private async getLocalChanges(db: AgentDB): Promise<any[]> {\n    // Query changes from local database since lastSyncTime\n    // This would query a change log table in production\n\n    try {\n      // Placeholder: In production, this would query:\n      // SELECT * FROM change_log WHERE timestamp > lastSyncTime AND tenantId = this.config.tenantId\n\n      return []; // No changes in simulation\n    } catch (error: any) {\n      logger.error('Failed to get local changes', {\n        error: error.message\n      });\n      return [];\n    }\n  }\n\n  /**\n   * Merge remote updates into local database\n   * Uses vector clocks to detect and resolve conflicts\n   */\n  private async mergeRemoteUpdates(db: AgentDB, updates: any[]): Promise<void> {\n    for (const update of updates) {\n      try {\n        // Check vector clock for conflict detection\n        const conflict = this.detectConflict(update.vectorClock);\n\n        if (conflict) {\n          // Resolve conflict using CRDT rules (last-write-wins by default)\n          logger.warn('Conflict detected, applying resolution', {\n            agentId: this.config.agentId,\n            updateId: update.id\n          });\n        }\n\n        // Apply update to local database\n        await this.applyUpdate(db, update);\n\n        // Update local vector clock\n        this.updateVectorClock(update.vectorClock);\n\n      } catch (error: any) {\n        logger.error('Failed to merge remote update', {\n          updateId: update.id,\n          error: error.message\n        });\n      }\n    }\n  }\n\n  /**\n   * Detect conflicts using vector clocks\n   */\n  private detectConflict(remoteVectorClock: Record<string, number>): boolean {\n    // Two updates conflict if their vector clocks are concurrent\n    // (neither is causally before the other)\n\n    let localDominates = false;\n    let remoteDominates = false;\n\n    for (const agentId in remoteVectorClock) {\n      const localTs = this.vectorClock[agentId] || 0;\n      const remoteTs = remoteVectorClock[agentId];\n\n      if (localTs > remoteTs) {\n        localDominates = true;\n      } else if (remoteTs > localTs) {\n        remoteDominates = true;\n      }\n    }\n\n    // Conflict if both dominate (concurrent updates)\n    return localDominates && remoteDominates;\n  }\n\n  /**\n   * Update local vector clock with remote timestamps\n   */\n  private updateVectorClock(remoteVectorClock: Record<string, number>): void {\n    for (const agentId in remoteVectorClock) {\n      const localTs = this.vectorClock[agentId] || 0;\n      const remoteTs = remoteVectorClock[agentId];\n\n      // Take maximum timestamp (merge rule)\n      this.vectorClock[agentId] = Math.max(localTs, remoteTs);\n    }\n  }\n\n  /**\n   * Apply update to local database\n   */\n  private async applyUpdate(db: AgentDB, update: any): Promise<void> {\n    // Apply update based on operation type\n    // This would execute the actual database operation\n\n    switch (update.operation) {\n      case 'insert':\n        // Insert new record\n        break;\n      case 'update':\n        // Update existing record\n        break;\n      case 'delete':\n        // Delete record\n        break;\n      default:\n        logger.warn('Unknown update operation', {\n          operation: update.operation\n        });\n    }\n  }\n\n  /**\n   * Disconnect from federation hub\n   */\n  async disconnect(): Promise<void> {\n    if (!this.connected) {\n      return;\n    }\n\n    logger.info('Disconnecting from federation hub', {\n      agentId: this.config.agentId\n    });\n\n    // Close QUIC connection (placeholder)\n    this.connected = false;\n\n    logger.info('Disconnected from federation hub');\n  }\n\n  /**\n   * Get connection status\n   */\n  isConnected(): boolean {\n    return this.connected;\n  }\n\n  /**\n   * Get sync statistics\n   */\n  getSyncStats(): { lastSyncTime: number; vectorClock: Record<string, number> } {\n    return {\n      lastSyncTime: this.lastSyncTime,\n      vectorClock: { ...this.vectorClock }\n    };\n  }\n}\n"]}