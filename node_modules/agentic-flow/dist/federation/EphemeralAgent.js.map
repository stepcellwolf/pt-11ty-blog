{"version":3,"file":"EphemeralAgent.js","sourceRoot":"","sources":["../../src/federation/EphemeralAgent.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Ephemeral Agent - Short-lived agent with federated memory access\n *\n * Features:\n * - Automatic lifecycle management (spawn → execute → learn → destroy)\n * - Federated memory sync via QUIC\n * - Tenant isolation with JWT authentication\n * - Memory persistence after agent destruction\n */\n\n// AgentDB is optional - use better-sqlite3 fallback\ntype AgentDB = any;\nimport Database from 'better-sqlite3';\nimport { FederationHub } from './FederationHub.js';\nimport { SecurityManager } from './SecurityManager.js';\nimport { logger } from '../utils/logger.js';\n\nexport interface EphemeralAgentConfig {\n  tenantId: string;\n  lifetime?: number; // seconds\n  hubEndpoint?: string;\n  memoryPath?: string;\n  enableEncryption?: boolean;\n  syncInterval?: number; // milliseconds\n}\n\nexport interface AgentContext {\n  agentId: string;\n  tenantId: string;\n  db: AgentDB;\n  spawnTime: number;\n  expiresAt: number;\n}\n\nexport class EphemeralAgent {\n  private config: EphemeralAgentConfig;\n  private context?: AgentContext;\n  private hub?: FederationHub;\n  private security: SecurityManager;\n  private cleanupTimer?: NodeJS.Timeout;\n  private syncTimer?: NodeJS.Timeout;\n\n  constructor(config: EphemeralAgentConfig) {\n    this.config = {\n      lifetime: 300, // 5 minutes default\n      syncInterval: 5000, // 5 seconds default\n      enableEncryption: true,\n      ...config\n    };\n    this.security = new SecurityManager();\n  }\n\n  /**\n   * Spawn a new ephemeral agent with federated memory access\n   */\n  static async spawn(config: EphemeralAgentConfig): Promise<EphemeralAgent> {\n    const agent = new EphemeralAgent(config);\n    await agent.initialize();\n    return agent;\n  }\n\n  /**\n   * Initialize agent: setup DB, connect to hub, start lifecycle timers\n   */\n  private async initialize(): Promise<void> {\n    const agentId = `eph-${this.config.tenantId}-${Date.now()}`;\n    const spawnTime = Date.now();\n    const expiresAt = spawnTime + ((this.config.lifetime || 300) * 1000);\n\n    logger.info('Spawning ephemeral agent', {\n      agentId,\n      tenantId: this.config.tenantId,\n      lifetime: this.config.lifetime,\n      expiresAt: new Date(expiresAt).toISOString()\n    });\n\n    // Initialize local database instance\n    const memoryPath = this.config.memoryPath || `:memory:`;\n    // Use better-sqlite3 for now (AgentDB integration planned)\n    const db = new Database(memoryPath) as any;\n\n    // Create JWT token for authentication\n    const token = await this.security.createAgentToken({\n      agentId,\n      tenantId: this.config.tenantId,\n      expiresAt\n    });\n\n    // Connect to federation hub if endpoint provided\n    if (this.config.hubEndpoint) {\n      this.hub = new FederationHub({\n        endpoint: this.config.hubEndpoint,\n        agentId,\n        tenantId: this.config.tenantId,\n        token\n      });\n\n      await this.hub.connect();\n\n      // Start periodic sync\n      if (this.config.syncInterval) {\n        this.syncTimer = setInterval(async () => {\n          await this.syncWithHub();\n        }, this.config.syncInterval);\n      }\n    }\n\n    // Store context\n    this.context = {\n      agentId,\n      tenantId: this.config.tenantId,\n      db,\n      spawnTime,\n      expiresAt\n    };\n\n    // Schedule automatic cleanup at expiration\n    const timeUntilExpiry = expiresAt - Date.now();\n    this.cleanupTimer = setTimeout(async () => {\n      logger.warn('Agent lifetime expired, auto-destroying', { agentId });\n      await this.destroy();\n    }, timeUntilExpiry);\n\n    logger.info('Ephemeral agent spawned successfully', {\n      agentId,\n      hubConnected: !!this.hub,\n      timeUntilExpiry\n    });\n  }\n\n  /**\n   * Execute a task within the agent context\n   * Automatically syncs memory before and after execution\n   */\n  async execute<T>(\n    task: (db: AgentDB, context: AgentContext) => Promise<T>\n  ): Promise<T> {\n    if (!this.context) {\n      throw new Error('Agent not initialized. Call spawn() first.');\n    }\n\n    const { agentId, db } = this.context;\n\n    // Check if agent has expired\n    if (Date.now() >= this.context.expiresAt) {\n      throw new Error(`Agent ${agentId} has expired and cannot execute tasks`);\n    }\n\n    logger.info('Executing task', { agentId });\n\n    try {\n      // Pre-execution sync: pull latest memories from hub\n      if (this.hub) {\n        await this.syncWithHub();\n      }\n\n      // Execute user task\n      const result = await task(db, this.context);\n\n      // Post-execution sync: push new memories to hub\n      if (this.hub) {\n        await this.syncWithHub();\n      }\n\n      logger.info('Task execution completed', { agentId });\n      return result;\n    } catch (error: any) {\n      logger.error('Task execution failed', {\n        agentId,\n        error: error.message\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Query memories from federated database\n   */\n  async queryMemories(task: string, k: number = 5): Promise<any[]> {\n    if (!this.context) {\n      throw new Error('Agent not initialized');\n    }\n\n    const { db, tenantId } = this.context;\n\n    // Query using ReasoningBank pattern search\n    const patterns = await (db as any).patternSearch({\n      task,\n      k,\n      tenantId // Apply tenant isolation\n    });\n\n    return patterns || [];\n  }\n\n  /**\n   * Store a learning episode to persistent memory\n   */\n  async storeEpisode(episode: {\n    task: string;\n    input: string;\n    output: string;\n    reward: number;\n    critique?: string;\n  }): Promise<void> {\n    if (!this.context) {\n      throw new Error('Agent not initialized');\n    }\n\n    const { db, agentId, tenantId } = this.context;\n\n    // Store episode with tenant isolation\n    await (db as any).patternStore({\n      sessionId: agentId,\n      task: episode.task,\n      input: episode.input,\n      output: episode.output,\n      reward: episode.reward,\n      critique: episode.critique || '',\n      success: episode.reward >= 0.7,\n      tokensUsed: 0,\n      latencyMs: 0,\n      tenantId // Ensure tenant isolation\n    });\n\n    logger.info('Episode stored', {\n      agentId,\n      task: episode.task,\n      reward: episode.reward\n    });\n  }\n\n  /**\n   * Sync local memory with federation hub\n   */\n  private async syncWithHub(): Promise<void> {\n    if (!this.hub || !this.context) {\n      return;\n    }\n\n    try {\n      await this.hub.sync(this.context.db);\n    } catch (error: any) {\n      logger.error('Federation sync failed', {\n        agentId: this.context.agentId,\n        error: error.message\n      });\n    }\n  }\n\n  /**\n   * Get remaining lifetime in seconds\n   */\n  getRemainingLifetime(): number {\n    if (!this.context) {\n      return 0;\n    }\n    return Math.max(0, Math.floor((this.context.expiresAt - Date.now()) / 1000));\n  }\n\n  /**\n   * Destroy agent and cleanup resources\n   * Memory persists in federation hub\n   */\n  async destroy(): Promise<void> {\n    if (!this.context) {\n      return;\n    }\n\n    const { agentId, db } = this.context;\n\n    logger.info('Destroying ephemeral agent', { agentId });\n\n    // Clear timers\n    if (this.cleanupTimer) {\n      clearTimeout(this.cleanupTimer);\n    }\n    if (this.syncTimer) {\n      clearInterval(this.syncTimer);\n    }\n\n    // Final sync to persist any pending changes\n    if (this.hub) {\n      try {\n        await this.syncWithHub();\n        await this.hub.disconnect();\n      } catch (error: any) {\n        logger.error('Final sync failed', {\n          agentId,\n          error: error.message\n        });\n      }\n    }\n\n    // Close local database\n    try {\n      await (db as any).close?.();\n    } catch (error) {\n      // Ignore close errors for in-memory databases\n    }\n\n    // Clear context\n    this.context = undefined;\n\n    logger.info('Ephemeral agent destroyed', { agentId });\n  }\n\n  /**\n   * Check if agent is still alive\n   */\n  isAlive(): boolean {\n    if (!this.context) {\n      return false;\n    }\n    return Date.now() < this.context.expiresAt;\n  }\n\n  /**\n   * Get agent info\n   */\n  getInfo(): AgentContext | null {\n    return this.context || null;\n  }\n}\n"]}