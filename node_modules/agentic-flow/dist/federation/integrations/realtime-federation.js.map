{"version":3,"file":"realtime-federation.js","sourceRoot":"","sources":["../../../src/federation/integrations/realtime-federation.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Real-Time Federation System using Supabase\n *\n * Leverages Supabase Real-Time for:\n * - Live agent coordination\n * - Instant memory synchronization\n * - Real-time presence tracking\n * - Collaborative multi-agent workflows\n * - Event-driven agent communication\n */\n\nimport { createClient, SupabaseClient, RealtimeChannel } from '@supabase/supabase-js';\n\nexport interface RealtimeConfig {\n  url: string;\n  anonKey: string;\n  serviceRoleKey?: string;\n  presenceHeartbeat?: number; // ms, default 30000\n  memorySync?: boolean; // Auto-sync memories\n  broadcastLatency?: 'low' | 'high'; // Trade-off: low = less batching\n}\n\nexport interface AgentPresence {\n  agent_id: string;\n  tenant_id: string;\n  status: 'online' | 'busy' | 'offline';\n  task?: string;\n  started_at: string;\n  last_heartbeat: string;\n  metadata?: Record<string, any>;\n}\n\nexport interface MemoryEvent {\n  type: 'memory_added' | 'memory_updated' | 'memory_retrieved';\n  tenant_id: string;\n  agent_id: string;\n  session_id: string;\n  content: string;\n  embedding?: number[];\n  metadata?: Record<string, any>;\n  timestamp: string;\n}\n\nexport interface CoordinationMessage {\n  from_agent: string;\n  to_agent?: string; // undefined = broadcast\n  type: 'task_assignment' | 'task_complete' | 'request_help' | 'share_knowledge' | 'status_update';\n  payload: any;\n  timestamp: string;\n}\n\nexport interface TaskAssignment {\n  task_id: string;\n  assigned_to: string;\n  description: string;\n  priority: 'low' | 'medium' | 'high' | 'critical';\n  deadline?: string;\n  dependencies?: string[];\n}\n\nexport class RealtimeFederationHub {\n  private client: SupabaseClient;\n  private config: RealtimeConfig;\n  private channels: Map<string, RealtimeChannel> = new Map();\n  private presenceChannel?: RealtimeChannel;\n  private agentId: string;\n  private tenantId: string;\n  private heartbeatInterval?: NodeJS.Timeout;\n  private eventHandlers: Map<string, Set<Function>> = new Map();\n\n  constructor(config: RealtimeConfig, agentId: string, tenantId: string = 'default') {\n    this.config = config;\n    this.agentId = agentId;\n    this.tenantId = tenantId;\n\n    const key = config.serviceRoleKey || config.anonKey;\n    this.client = createClient(config.url, key, {\n      realtime: {\n        params: {\n          eventsPerSecond: config.broadcastLatency === 'low' ? 10 : 2,\n        },\n      },\n    });\n  }\n\n  /**\n   * Initialize real-time federation\n   */\n  async initialize(): Promise<void> {\n    console.log('üåê Initializing Real-Time Federation Hub...');\n    console.log(`   Agent: ${this.agentId}`);\n    console.log(`   Tenant: ${this.tenantId}`);\n\n    // Set up presence tracking\n    await this.setupPresence();\n\n    // Set up memory sync channel\n    if (this.config.memorySync !== false) {\n      await this.setupMemorySync();\n    }\n\n    // Set up coordination channel\n    await this.setupCoordination();\n\n    // Start heartbeat\n    this.startHeartbeat();\n\n    console.log('‚úÖ Real-Time Federation Hub Active');\n  }\n\n  /**\n   * Set up presence tracking for all agents in tenant\n   */\n  private async setupPresence(): Promise<void> {\n    const channelName = `presence:${this.tenantId}`;\n    this.presenceChannel = this.client.channel(channelName, {\n      config: {\n        presence: {\n          key: this.agentId,\n        },\n      },\n    });\n\n    // Track agent join\n    this.presenceChannel.on('presence', { event: 'join' }, ({ key, newPresences }) => {\n      console.log(`üü¢ Agent joined: ${key}`);\n      this.emit('agent:join', { agent_id: key, presences: newPresences });\n    });\n\n    // Track agent leave\n    this.presenceChannel.on('presence', { event: 'leave' }, ({ key, leftPresences }) => {\n      console.log(`üî¥ Agent left: ${key}`);\n      this.emit('agent:leave', { agent_id: key, presences: leftPresences });\n    });\n\n    // Track agent sync (periodic updates)\n    this.presenceChannel.on('presence', { event: 'sync' }, () => {\n      const state = this.presenceChannel!.presenceState();\n      this.emit('agents:sync', { agents: this.getActiveAgents(state) });\n    });\n\n    // Subscribe and track presence\n    await this.presenceChannel.subscribe(async (status) => {\n      if (status === 'SUBSCRIBED') {\n        await this.presenceChannel!.track({\n          agent_id: this.agentId,\n          tenant_id: this.tenantId,\n          status: 'online',\n          started_at: new Date().toISOString(),\n          last_heartbeat: new Date().toISOString(),\n        });\n      }\n    });\n  }\n\n  /**\n   * Set up real-time memory synchronization\n   */\n  private async setupMemorySync(): Promise<void> {\n    const channelName = `memories:${this.tenantId}`;\n    const channel = this.client.channel(channelName);\n\n    // Listen for new memories from database\n    channel\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'agent_memories',\n          filter: `tenant_id=eq.${this.tenantId}`,\n        },\n        (payload) => {\n          const memory: MemoryEvent = {\n            type: 'memory_added',\n            tenant_id: payload.new.tenant_id,\n            agent_id: payload.new.agent_id,\n            session_id: payload.new.session_id,\n            content: payload.new.content,\n            embedding: payload.new.embedding,\n            metadata: payload.new.metadata,\n            timestamp: payload.new.created_at,\n          };\n          this.emit('memory:added', memory);\n        }\n      )\n      .on(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'agent_memories',\n          filter: `tenant_id=eq.${this.tenantId}`,\n        },\n        (payload) => {\n          const memory: MemoryEvent = {\n            type: 'memory_updated',\n            tenant_id: payload.new.tenant_id,\n            agent_id: payload.new.agent_id,\n            session_id: payload.new.session_id,\n            content: payload.new.content,\n            embedding: payload.new.embedding,\n            metadata: payload.new.metadata,\n            timestamp: new Date().toISOString(),\n          };\n          this.emit('memory:updated', memory);\n        }\n      );\n\n    await channel.subscribe();\n    this.channels.set('memory-sync', channel);\n\n    console.log('üíæ Real-time memory sync enabled');\n  }\n\n  /**\n   * Set up coordination channel for agent-to-agent communication\n   */\n  private async setupCoordination(): Promise<void> {\n    const channelName = `coordination:${this.tenantId}`;\n    const channel = this.client.channel(channelName);\n\n    // Listen for broadcast messages\n    channel.on('broadcast', { event: 'coordination' }, ({ payload }) => {\n      const message: CoordinationMessage = payload;\n\n      // Only process if message is for us or broadcast\n      if (!message.to_agent || message.to_agent === this.agentId) {\n        this.emit('message:received', message);\n\n        // Emit specific event types\n        this.emit(`message:${message.type}`, message);\n      }\n    });\n\n    await channel.subscribe();\n    this.channels.set('coordination', channel);\n\n    console.log('üì° Agent coordination channel active');\n  }\n\n  /**\n   * Broadcast message to all agents in tenant\n   */\n  async broadcast(\n    type: CoordinationMessage['type'],\n    payload: any\n  ): Promise<void> {\n    const channel = this.channels.get('coordination');\n    if (!channel) {\n      throw new Error('Coordination channel not initialized');\n    }\n\n    const message: CoordinationMessage = {\n      from_agent: this.agentId,\n      type,\n      payload,\n      timestamp: new Date().toISOString(),\n    };\n\n    await channel.send({\n      type: 'broadcast',\n      event: 'coordination',\n      payload: message,\n    });\n  }\n\n  /**\n   * Send direct message to specific agent\n   */\n  async sendMessage(\n    toAgent: string,\n    type: CoordinationMessage['type'],\n    payload: any\n  ): Promise<void> {\n    const channel = this.channels.get('coordination');\n    if (!channel) {\n      throw new Error('Coordination channel not initialized');\n    }\n\n    const message: CoordinationMessage = {\n      from_agent: this.agentId,\n      to_agent: toAgent,\n      type,\n      payload,\n      timestamp: new Date().toISOString(),\n    };\n\n    await channel.send({\n      type: 'broadcast',\n      event: 'coordination',\n      payload: message,\n    });\n  }\n\n  /**\n   * Assign task to another agent\n   */\n  async assignTask(task: TaskAssignment): Promise<void> {\n    await this.sendMessage(task.assigned_to, 'task_assignment', task);\n    console.log(`üìã Task assigned: ${task.task_id} ‚Üí ${task.assigned_to}`);\n  }\n\n  /**\n   * Report task completion\n   */\n  async reportTaskComplete(taskId: string, result: any): Promise<void> {\n    await this.broadcast('task_complete', {\n      task_id: taskId,\n      result,\n      completed_by: this.agentId,\n    });\n    console.log(`‚úÖ Task completed: ${taskId}`);\n  }\n\n  /**\n   * Request help from other agents\n   */\n  async requestHelp(problem: string, context?: any): Promise<void> {\n    await this.broadcast('request_help', {\n      problem,\n      context,\n      from: this.agentId,\n    });\n    console.log(`üÜò Help requested: ${problem}`);\n  }\n\n  /**\n   * Share knowledge with other agents\n   */\n  async shareKnowledge(knowledge: string, metadata?: any): Promise<void> {\n    await this.broadcast('share_knowledge', {\n      knowledge,\n      metadata,\n      from: this.agentId,\n    });\n    console.log(`üí° Knowledge shared: ${knowledge.substring(0, 50)}...`);\n  }\n\n  /**\n   * Update agent status\n   */\n  async updateStatus(\n    status: 'online' | 'busy' | 'offline',\n    task?: string\n  ): Promise<void> {\n    if (!this.presenceChannel) return;\n\n    await this.presenceChannel.track({\n      agent_id: this.agentId,\n      tenant_id: this.tenantId,\n      status,\n      task,\n      last_heartbeat: new Date().toISOString(),\n    });\n\n    await this.broadcast('status_update', {\n      agent_id: this.agentId,\n      status,\n      task,\n    });\n  }\n\n  /**\n   * Get list of active agents\n   */\n  getActiveAgents(presenceState?: any): AgentPresence[] {\n    if (!this.presenceChannel) return [];\n\n    const state = presenceState || this.presenceChannel.presenceState();\n    const agents: AgentPresence[] = [];\n\n    for (const [agentId, presences] of Object.entries(state)) {\n      const presence = (presences as any[])[0];\n      agents.push({\n        agent_id: agentId,\n        tenant_id: presence.tenant_id,\n        status: presence.status,\n        task: presence.task,\n        started_at: presence.started_at,\n        last_heartbeat: presence.last_heartbeat,\n        metadata: presence.metadata,\n      });\n    }\n\n    return agents;\n  }\n\n  /**\n   * Start heartbeat to maintain presence\n   */\n  private startHeartbeat(): void {\n    const interval = this.config.presenceHeartbeat || 30000;\n\n    this.heartbeatInterval = setInterval(async () => {\n      if (this.presenceChannel) {\n        await this.presenceChannel.track({\n          agent_id: this.agentId,\n          tenant_id: this.tenantId,\n          last_heartbeat: new Date().toISOString(),\n        });\n      }\n    }, interval);\n  }\n\n  /**\n   * Stop heartbeat\n   */\n  private stopHeartbeat(): void {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n      this.heartbeatInterval = undefined;\n    }\n  }\n\n  /**\n   * Subscribe to events\n   */\n  on(event: string, handler: Function): void {\n    if (!this.eventHandlers.has(event)) {\n      this.eventHandlers.set(event, new Set());\n    }\n    this.eventHandlers.get(event)!.add(handler);\n  }\n\n  /**\n   * Unsubscribe from events\n   */\n  off(event: string, handler: Function): void {\n    const handlers = this.eventHandlers.get(event);\n    if (handlers) {\n      handlers.delete(handler);\n    }\n  }\n\n  /**\n   * Emit event to handlers\n   */\n  private emit(event: string, data: any): void {\n    const handlers = this.eventHandlers.get(event);\n    if (handlers) {\n      handlers.forEach((handler) => {\n        try {\n          handler(data);\n        } catch (error) {\n          console.error(`Error in event handler for ${event}:`, error);\n        }\n      });\n    }\n  }\n\n  /**\n   * Get real-time statistics\n   */\n  async getStats(): Promise<any> {\n    const activeAgents = this.getActiveAgents();\n\n    return {\n      tenant_id: this.tenantId,\n      agent_id: this.agentId,\n      active_agents: activeAgents.length,\n      agents: activeAgents,\n      channels: Array.from(this.channels.keys()),\n      heartbeat_interval: this.config.presenceHeartbeat || 30000,\n      memory_sync: this.config.memorySync !== false,\n      timestamp: new Date().toISOString(),\n    };\n  }\n\n  /**\n   * Shutdown and cleanup\n   */\n  async shutdown(): Promise<void> {\n    console.log('üõë Shutting down Real-Time Federation Hub...');\n\n    // Stop heartbeat\n    this.stopHeartbeat();\n\n    // Update status to offline\n    if (this.presenceChannel) {\n      await this.presenceChannel.track({\n        agent_id: this.agentId,\n        tenant_id: this.tenantId,\n        status: 'offline',\n      });\n      await this.presenceChannel.untrack();\n    }\n\n    // Unsubscribe from all channels\n    for (const [name, channel] of this.channels) {\n      await channel.unsubscribe();\n      console.log(`   Unsubscribed from ${name}`);\n    }\n\n    if (this.presenceChannel) {\n      await this.presenceChannel.unsubscribe();\n    }\n\n    this.channels.clear();\n    this.eventHandlers.clear();\n\n    console.log('‚úÖ Real-Time Federation Hub shutdown complete');\n  }\n}\n\n/**\n * Create real-time federation hub from environment\n */\nexport function createRealtimeHub(\n  agentId: string,\n  tenantId: string = 'default'\n): RealtimeFederationHub {\n  const url = process.env.SUPABASE_URL;\n  const anonKey = process.env.SUPABASE_ANON_KEY;\n  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n  if (!url || !anonKey) {\n    throw new Error(\n      'Missing Supabase credentials. Set SUPABASE_URL and SUPABASE_ANON_KEY'\n    );\n  }\n\n  return new RealtimeFederationHub(\n    {\n      url,\n      anonKey,\n      serviceRoleKey,\n      presenceHeartbeat: parseInt(\n        process.env.FEDERATION_HEARTBEAT_INTERVAL || '30000'\n      ),\n      memorySync: process.env.FEDERATION_MEMORY_SYNC !== 'false',\n      broadcastLatency:\n        (process.env.FEDERATION_BROADCAST_LATENCY as 'low' | 'high') || 'low',\n    },\n    agentId,\n    tenantId\n  );\n}\n"]}