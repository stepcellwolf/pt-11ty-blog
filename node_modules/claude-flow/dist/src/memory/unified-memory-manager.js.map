{"version":3,"sources":["../../../src/memory/unified-memory-manager.js"],"sourcesContent":["/**\n * Unified Memory Manager\n * Provides a single interface for all memory operations across the system\n */\n\nimport { promises as fs } from 'fs';\nimport path from 'path';\nimport { existsSync } from '../cli/node-compat.js';\nimport { getProjectRoot, getClaudeFlowDir } from '../utils/project-root.js';\n\nexport class UnifiedMemoryManager {\n  constructor(options = {}) {\n    const claudeFlowDir = getClaudeFlowDir();\n    const projectRoot = getProjectRoot();\n    this.config = {\n      primaryStore: path.join(claudeFlowDir, 'memory', 'unified-memory.db'),\n      fallbackStore: path.join(projectRoot, 'memory', 'memory-store.json'),\n      configPath: path.join(claudeFlowDir, 'memory-config.json'),\n      ...options\n    };\n    \n    this.isInitialized = false;\n    this.useSqlite = false;\n    this.db = null;\n  }\n\n  /**\n   * Initialize the memory manager\n   */\n  async initialize() {\n    if (this.isInitialized) return;\n\n    // Check if we have a unified database\n    if (existsSync(this.config.primaryStore)) {\n      try {\n        // Try to load SQLite modules\n        const sqlite3Module = await import('sqlite3');\n        const sqliteModule = await import('sqlite');\n        \n        this.sqlite3 = sqlite3Module.default;\n        this.sqliteOpen = sqliteModule.open;\n        this.useSqlite = true;\n        \n        // Open database connection\n        this.db = await this.sqliteOpen({\n          filename: this.config.primaryStore,\n          driver: this.sqlite3.Database\n        });\n        \n        // Enable WAL mode for better performance\n        await this.db.exec('PRAGMA journal_mode = WAL');\n        \n      } catch (err) {\n        console.warn('SQLite not available, falling back to JSON store');\n        this.useSqlite = false;\n      }\n    }\n    \n    this.isInitialized = true;\n  }\n\n  /**\n   * Store a key-value pair\n   */\n  async store(key, value, namespace = 'default', metadata = {}) {\n    await this.initialize();\n    \n    if (this.useSqlite) {\n      return await this.storeSqlite(key, value, namespace, metadata);\n    } else {\n      return await this.storeJson(key, value, namespace, metadata);\n    }\n  }\n\n  /**\n   * Store in SQLite database\n   */\n  async storeSqlite(key, value, namespace, metadata) {\n    const timestamp = Date.now();\n    \n    await this.db.run(`\n      INSERT OR REPLACE INTO memory_entries (key, value, namespace, timestamp, source)\n      VALUES (?, ?, ?, ?, ?)\n    `, key, value, namespace, timestamp, 'unified-manager');\n    \n    return { key, value, namespace, timestamp };\n  }\n\n  /**\n   * Store in JSON file\n   */\n  async storeJson(key, value, namespace, metadata) {\n    const data = await this.loadJsonData();\n    \n    if (!data[namespace]) {\n      data[namespace] = [];\n    }\n    \n    // Remove existing entry with same key\n    data[namespace] = data[namespace].filter((e) => e.key !== key);\n    \n    // Add new entry\n    const entry = {\n      key,\n      value,\n      namespace,\n      timestamp: Date.now(),\n      ...metadata\n    };\n    \n    data[namespace].push(entry);\n    \n    await this.saveJsonData(data);\n    return entry;\n  }\n\n  /**\n   * Query memory entries\n   */\n  async query(search, options = {}) {\n    await this.initialize();\n    \n    if (this.useSqlite) {\n      return await this.querySqlite(search, options);\n    } else {\n      return await this.queryJson(search, options);\n    }\n  }\n\n  /**\n   * Query SQLite database\n   */\n  async querySqlite(search, options) {\n    const { namespace, limit = 100, offset = 0 } = options;\n    \n    let query = `\n      SELECT * FROM memory_entries \n      WHERE (key LIKE ? OR value LIKE ?)\n    `;\n    \n    const params = [`%${search}%`, `%${search}%`];\n    \n    if (namespace) {\n      query += ' AND namespace = ?';\n      params.push(namespace);\n    }\n    \n    query += ' ORDER BY timestamp DESC LIMIT ? OFFSET ?';\n    params.push(limit, offset);\n    \n    const results = await this.db.all(query, ...params);\n    return results;\n  }\n\n  /**\n   * Query JSON store\n   */\n  async queryJson(search, options) {\n    const data = await this.loadJsonData();\n    const { namespace, limit = 100, offset = 0 } = options;\n    \n    const results = [];\n    const namespaces = namespace ? [namespace] : Object.keys(data);\n    \n    for (const ns of namespaces) {\n      if (data[ns]) {\n        for (const entry of data[ns]) {\n          if (entry.key.includes(search) || entry.value.includes(search)) {\n            results.push(entry);\n          }\n        }\n      }\n    }\n    \n    // Sort by timestamp (newest first)\n    results.sort((a, b) => b.timestamp - a.timestamp);\n    \n    // Apply pagination\n    return results.slice(offset, offset + limit);\n  }\n\n  /**\n   * Get memory by exact key\n   */\n  async get(key, namespace = 'default') {\n    await this.initialize();\n    \n    if (this.useSqlite) {\n      const result = await this.db.get(`\n        SELECT * FROM memory_entries \n        WHERE key = ? AND namespace = ?\n        ORDER BY timestamp DESC\n        LIMIT 1\n      `, key, namespace);\n      \n      return result;\n    } else {\n      const data = await this.loadJsonData();\n      if (data[namespace]) {\n        const entry = data[namespace].find(e => e.key === key);\n        return entry;\n      }\n      return null;\n    }\n  }\n\n  /**\n   * Delete memory entry\n   */\n  async delete(key, namespace = 'default') {\n    await this.initialize();\n    \n    if (this.useSqlite) {\n      await this.db.run(`\n        DELETE FROM memory_entries \n        WHERE key = ? AND namespace = ?\n      `, key, namespace);\n    } else {\n      const data = await this.loadJsonData();\n      if (data[namespace]) {\n        data[namespace] = data[namespace].filter(e => e.key !== key);\n        await this.saveJsonData(data);\n      }\n    }\n  }\n\n  /**\n   * Clear namespace\n   */\n  async clearNamespace(namespace) {\n    await this.initialize();\n    \n    if (this.useSqlite) {\n      const result = await this.db.run(`\n        DELETE FROM memory_entries \n        WHERE namespace = ?\n      `, namespace);\n      \n      return result.changes;\n    } else {\n      const data = await this.loadJsonData();\n      const count = data[namespace] ? data[namespace].length : 0;\n      delete data[namespace];\n      await this.saveJsonData(data);\n      return count;\n    }\n  }\n\n  /**\n   * Get statistics\n   */\n  async getStats() {\n    await this.initialize();\n    \n    if (this.useSqlite) {\n      const stats = await this.db.get(`\n        SELECT \n          COUNT(*) as totalEntries,\n          COUNT(DISTINCT namespace) as namespaces\n        FROM memory_entries\n      `);\n      \n      const namespaceStats = await this.db.all(`\n        SELECT namespace, COUNT(*) as count \n        FROM memory_entries \n        GROUP BY namespace\n      `);\n      \n      // Get database size\n      const dbInfo = await this.db.get(`\n        SELECT page_count * page_size as sizeBytes \n        FROM pragma_page_count(), pragma_page_size()\n      `);\n      \n      return {\n        totalEntries: stats.totalEntries,\n        namespaces: stats.namespaces,\n        namespaceStats: namespaceStats.reduce((acc, ns) => {\n          acc[ns.namespace] = ns.count;\n          return acc;\n        }, {}),\n        sizeBytes: dbInfo.sizeBytes,\n        storageType: 'sqlite'\n      };\n    } else {\n      const data = await this.loadJsonData();\n      let totalEntries = 0;\n      const namespaceStats = {};\n      \n      for (const [namespace, entries] of Object.entries(data)) {\n        namespaceStats[namespace] = entries.length;\n        totalEntries += entries.length;\n      }\n      \n      return {\n        totalEntries,\n        namespaces: Object.keys(data).length,\n        namespaceStats,\n        sizeBytes: new TextEncoder().encode(JSON.stringify(data)).length,\n        storageType: 'json'\n      };\n    }\n  }\n\n  /**\n   * List all namespaces\n   */\n  async listNamespaces() {\n    await this.initialize();\n    \n    if (this.useSqlite) {\n      const namespaces = await this.db.all(`\n        SELECT DISTINCT namespace, COUNT(*) as count \n        FROM memory_entries \n        GROUP BY namespace\n        ORDER BY namespace\n      `);\n      \n      return namespaces;\n    } else {\n      const data = await this.loadJsonData();\n      return Object.keys(data).map(namespace => ({\n        namespace,\n        count: data[namespace].length\n      }));\n    }\n  }\n\n  /**\n   * Export data\n   */\n  async export(filePath, namespace = null) {\n    await this.initialize();\n    \n    let exportData;\n    \n    if (this.useSqlite) {\n      let query = 'SELECT * FROM memory_entries';\n      const params = [];\n      \n      if (namespace) {\n        query += ' WHERE namespace = ?';\n        params.push(namespace);\n      }\n      \n      const entries = await this.db.all(query, ...params);\n      \n      // Group by namespace\n      exportData = entries.reduce((acc, entry) => {\n        if (!acc[entry.namespace]) {\n          acc[entry.namespace] = [];\n        }\n        acc[entry.namespace].push(entry);\n        return acc;\n      }, {});\n    } else {\n      const data = await this.loadJsonData();\n      exportData = namespace ? { [namespace]: data[namespace] || [] } : data;\n    }\n    \n    await fs.writeFile(filePath, JSON.stringify(exportData, null, 2));\n    \n    let totalEntries = 0;\n    for (const entries of Object.values(exportData)) {\n      totalEntries += entries.length;\n    }\n    \n    return {\n      namespaces: Object.keys(exportData).length,\n      entries: totalEntries,\n      size: new TextEncoder().encode(JSON.stringify(exportData)).length\n    };\n  }\n\n  /**\n   * Import data\n   */\n  async import(filePath, options = {}) {\n    await this.initialize();\n    \n    const content = await fs.readFile(filePath, 'utf8');\n    const importData = JSON.parse(content);\n    \n    let imported = 0;\n    \n    for (const [namespace, entries] of Object.entries(importData)) {\n      for (const entry of entries) {\n        await this.store(\n          entry.key,\n          entry.value,\n          entry.namespace || namespace,\n          { timestamp: entry.timestamp, source: filePath }\n        );\n        imported++;\n      }\n    }\n    \n    return { imported };\n  }\n\n  /**\n   * Load JSON data\n   */\n  async loadJsonData() {\n    try {\n      const content = await fs.readFile(this.config.fallbackStore, 'utf8');\n      return JSON.parse(content);\n    } catch {\n      return {};\n    }\n  }\n\n  /**\n   * Save JSON data\n   */\n  async saveJsonData(data) {\n    await fs.mkdir(path.dirname(this.config.fallbackStore), { recursive: true });\n    await fs.writeFile(this.config.fallbackStore, JSON.stringify(data, null, 2));\n  }\n\n  /**\n   * Close database connection\n   */\n  async close() {\n    if (this.db) {\n      await this.db.close();\n      this.db = null;\n      this.isInitialized = false;\n    }\n  }\n\n  /**\n   * Check if using unified store\n   */\n  isUnified() {\n    return this.useSqlite;\n  }\n\n  /**\n   * Get storage info\n   */\n  getStorageInfo() {\n    return {\n      type: this.useSqlite ? 'sqlite' : 'json',\n      path: this.useSqlite ? this.config.primaryStore : this.config.fallbackStore,\n      unified: this.useSqlite\n    };\n  }\n}\n\n// Singleton instance\nlet instance = null;\n\n/**\n * Get unified memory manager instance\n */\nexport function getUnifiedMemory(options = {}) {\n  if (!instance) {\n    instance = new UnifiedMemoryManager(options);\n  }\n  return instance;\n}\n\nexport default UnifiedMemoryManager;"],"names":["promises","fs","path","existsSync","getProjectRoot","getClaudeFlowDir","UnifiedMemoryManager","options","claudeFlowDir","projectRoot","config","primaryStore","join","fallbackStore","configPath","isInitialized","useSqlite","db","initialize","sqlite3Module","sqliteModule","sqlite3","default","sqliteOpen","open","filename","driver","Database","exec","err","console","warn","store","key","value","namespace","metadata","storeSqlite","storeJson","timestamp","Date","now","run","data","loadJsonData","filter","e","entry","push","saveJsonData","query","search","querySqlite","queryJson","limit","offset","params","results","all","namespaces","Object","keys","ns","includes","sort","a","b","slice","get","result","find","delete","clearNamespace","changes","count","length","getStats","stats","namespaceStats","dbInfo","totalEntries","reduce","acc","sizeBytes","storageType","entries","TextEncoder","encode","JSON","stringify","listNamespaces","map","export","filePath","exportData","writeFile","values","size","import","content","readFile","importData","parse","imported","source","mkdir","dirname","recursive","close","isUnified","getStorageInfo","type","unified","instance","getUnifiedMemory"],"mappings":"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"}