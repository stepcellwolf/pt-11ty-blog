{"version":3,"sources":["../../../src/memory/migration.js"],"sourcesContent":["/**\n * Memory Migration Utility\n *\n * Helps migrate from old CollectiveMemory to new SharedMemory/SwarmMemory\n *\n * @module memory/migration\n */\n\nimport Database from 'better-sqlite3';\nimport path from 'path';\nimport fs from 'fs/promises';\nimport { SharedMemory } from './shared-memory.js';\nimport { SwarmMemory } from './swarm-memory.js';\nimport { getProjectRoot, getSwarmDir, getHiveMindDir } from '../utils/project-root.js';\n\nexport class MemoryMigration {\n  constructor(options = {}) {\n    this.options = {\n      oldDbPath: path.join(getHiveMindDir(), 'hive.db'),\n      newDbPath: path.join(getHiveMindDir(), 'memory.db'),\n      swarmDbPath: path.join(getSwarmDir(), 'swarm-memory.db'),\n      dryRun: options.dryRun || false,\n      verbose: options.verbose || false,\n      ...options,\n    };\n\n    this.stats = {\n      total: 0,\n      migrated: 0,\n      skipped: 0,\n      errors: 0,\n    };\n  }\n\n  /**\n   * Run the migration\n   */\n  async migrate() {\n    console.log('Starting memory migration...');\n\n    try {\n      // Check if old database exists\n      const oldDbExists = await this._fileExists(this.options.oldDbPath);\n      if (!oldDbExists) {\n        console.log('No old database found. Nothing to migrate.');\n        return { success: true, stats: this.stats };\n      }\n\n      // Initialize new memory systems\n      const sharedMemory = new SharedMemory({\n        directory: path.dirname(this.options.newDbPath),\n        filename: path.basename(this.options.newDbPath),\n      });\n\n      const swarmMemory = new SwarmMemory({\n        directory: path.dirname(this.options.swarmDbPath),\n        filename: path.basename(this.options.swarmDbPath),\n      });\n\n      if (!this.options.dryRun) {\n        await sharedMemory.initialize();\n        await swarmMemory.initialize();\n      }\n\n      // Open old database\n      const oldDb = new Database(this.options.oldDbPath, { readonly: true });\n\n      // Migrate collective_memory table\n      await this._migrateCollectiveMemory(oldDb, sharedMemory);\n\n      // Migrate memory table\n      await this._migrateMemoryTable(oldDb, sharedMemory);\n\n      // Migrate swarm-specific data\n      await this._migrateSwarmData(oldDb, swarmMemory);\n\n      // Close connections\n      oldDb.close();\n\n      if (!this.options.dryRun) {\n        await sharedMemory.close();\n        await swarmMemory.close();\n      }\n\n      console.log('\\nMigration completed!');\n      console.log(`Total entries: ${this.stats.total}`);\n      console.log(`Migrated: ${this.stats.migrated}`);\n      console.log(`Skipped: ${this.stats.skipped}`);\n      console.log(`Errors: ${this.stats.errors}`);\n\n      return {\n        success: true,\n        stats: this.stats,\n      };\n    } catch (error) {\n      console.error('Migration failed:', error);\n      return {\n        success: false,\n        error: error.message,\n        stats: this.stats,\n      };\n    }\n  }\n\n  /**\n   * Migrate collective_memory table\n   */\n  async _migrateCollectiveMemory(oldDb, sharedMemory) {\n    console.log('\\nMigrating collective_memory entries...');\n\n    try {\n      const rows = oldDb\n        .prepare(\n          `\n        SELECT * FROM collective_memory \n        ORDER BY created_at ASC\n      `,\n        )\n        .all();\n\n      for (const row of rows) {\n        this.stats.total++;\n\n        try {\n          // Parse the swarm_id from the key if needed\n          const keyParts = row.key.split(':');\n          const namespace = this._determineNamespace(row.type);\n\n          // Prepare value\n          let value = row.value;\n          if (row.compressed) {\n            // Handle compressed data if needed\n            value = JSON.parse(value);\n          }\n\n          if (this.options.dryRun) {\n            if (this.options.verbose) {\n              console.log(`Would migrate: ${row.key} -> ${namespace}`);\n            }\n          } else {\n            await sharedMemory.store(row.key, value, {\n              namespace,\n              ttl: this._calculateTTL(row.type),\n              metadata: {\n                originalId: row.id,\n                swarmId: row.swarm_id,\n                createdBy: row.created_by,\n                confidence: row.confidence,\n                migratedAt: new Date().toISOString(),\n              },\n            });\n          }\n\n          this.stats.migrated++;\n        } catch (error) {\n          console.error(`Error migrating ${row.key}:`, error.message);\n          this.stats.errors++;\n        }\n\n        // Progress indicator\n        if (this.stats.total % 100 === 0) {\n          process.stdout.write('.');\n        }\n      }\n    } catch (error) {\n      if (error.message.includes('no such table')) {\n        console.log('collective_memory table not found, skipping...');\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  /**\n   * Migrate memory table (from hive-mind schema)\n   */\n  async _migrateMemoryTable(oldDb, sharedMemory) {\n    console.log('\\n\\nMigrating memory table entries...');\n\n    try {\n      const rows = oldDb\n        .prepare(\n          `\n        SELECT * FROM memory \n        ORDER BY created_at ASC\n      `,\n        )\n        .all();\n\n      for (const row of rows) {\n        this.stats.total++;\n\n        try {\n          if (this.options.dryRun) {\n            if (this.options.verbose) {\n              console.log(`Would migrate: ${row.key} (${row.namespace})`);\n            }\n          } else {\n            await sharedMemory.store(row.key, row.value, {\n              namespace: row.namespace,\n              ttl: row.ttl,\n              metadata: row.metadata ? JSON.parse(row.metadata) : null,\n            });\n          }\n\n          this.stats.migrated++;\n        } catch (error) {\n          console.error(`Error migrating ${row.key}:`, error.message);\n          this.stats.errors++;\n        }\n\n        // Progress indicator\n        if (this.stats.total % 100 === 0) {\n          process.stdout.write('.');\n        }\n      }\n    } catch (error) {\n      if (error.message.includes('no such table')) {\n        console.log('memory table not found, skipping...');\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  /**\n   * Migrate swarm-specific data\n   */\n  async _migrateSwarmData(oldDb, swarmMemory) {\n    console.log('\\n\\nMigrating swarm-specific data...');\n\n    // Migrate agents\n    await this._migrateAgents(oldDb, swarmMemory);\n\n    // Migrate tasks\n    await this._migrateTasks(oldDb, swarmMemory);\n\n    // Migrate neural patterns\n    await this._migratePatterns(oldDb, swarmMemory);\n\n    // Migrate consensus data\n    await this._migrateConsensus(oldDb, swarmMemory);\n  }\n\n  /**\n   * Migrate agents table\n   */\n  async _migrateAgents(oldDb, swarmMemory) {\n    try {\n      const agents = oldDb\n        .prepare(\n          `\n        SELECT * FROM agents\n      `,\n        )\n        .all();\n\n      console.log(`\\nMigrating ${agents.length} agents...`);\n\n      for (const agent of agents) {\n        if (!this.options.dryRun) {\n          await swarmMemory.storeAgent(agent.id, {\n            id: agent.id,\n            name: agent.name,\n            type: agent.type,\n            status: agent.status,\n            capabilities: JSON.parse(agent.capabilities),\n            currentTaskId: agent.current_task_id,\n            messageCount: agent.message_count,\n            errorCount: agent.error_count,\n            successCount: agent.success_count,\n            createdAt: agent.created_at,\n            lastActiveAt: agent.last_active_at,\n            metadata: agent.metadata ? JSON.parse(agent.metadata) : {},\n          });\n        }\n        this.stats.migrated++;\n      }\n    } catch (error) {\n      if (!error.message.includes('no such table')) {\n        console.error('Error migrating agents:', error.message);\n      }\n    }\n  }\n\n  /**\n   * Migrate tasks table\n   */\n  async _migrateTasks(oldDb, swarmMemory) {\n    try {\n      const tasks = oldDb\n        .prepare(\n          `\n        SELECT * FROM tasks\n      `,\n        )\n        .all();\n\n      console.log(`\\nMigrating ${tasks.length} tasks...`);\n\n      for (const task of tasks) {\n        if (!this.options.dryRun) {\n          await swarmMemory.storeTask(task.id, {\n            id: task.id,\n            description: task.description,\n            priority: task.priority,\n            strategy: task.strategy,\n            status: task.status,\n            progress: task.progress,\n            result: task.result ? JSON.parse(task.result) : null,\n            error: task.error,\n            dependencies: task.dependencies ? JSON.parse(task.dependencies) : [],\n            assignedAgents: task.assigned_agents ? JSON.parse(task.assigned_agents) : [],\n            requireConsensus: !!task.require_consensus,\n            consensusAchieved: !!task.consensus_achieved,\n            maxAgents: task.max_agents,\n            requiredCapabilities: task.required_capabilities\n              ? JSON.parse(task.required_capabilities)\n              : [],\n            createdAt: task.created_at,\n            assignedAt: task.assigned_at,\n            startedAt: task.started_at,\n            completedAt: task.completed_at,\n            metadata: task.metadata ? JSON.parse(task.metadata) : {},\n          });\n        }\n        this.stats.migrated++;\n      }\n    } catch (error) {\n      if (!error.message.includes('no such table')) {\n        console.error('Error migrating tasks:', error.message);\n      }\n    }\n  }\n\n  /**\n   * Migrate neural patterns\n   */\n  async _migratePatterns(oldDb, swarmMemory) {\n    try {\n      const patterns = oldDb\n        .prepare(\n          `\n        SELECT * FROM neural_patterns\n      `,\n        )\n        .all();\n\n      console.log(`\\nMigrating ${patterns.length} neural patterns...`);\n\n      for (const pattern of patterns) {\n        if (!this.options.dryRun) {\n          await swarmMemory.storePattern(pattern.id, {\n            id: pattern.id,\n            type: pattern.pattern_type,\n            data: JSON.parse(pattern.pattern_data),\n            confidence: pattern.confidence,\n            usageCount: pattern.usage_count,\n            successRate: pattern.success_rate,\n            createdAt: pattern.created_at,\n            lastUsedAt: pattern.last_used_at,\n            metadata: pattern.metadata ? JSON.parse(pattern.metadata) : {},\n          });\n        }\n        this.stats.migrated++;\n      }\n    } catch (error) {\n      if (!error.message.includes('no such table')) {\n        console.error('Error migrating patterns:', error.message);\n      }\n    }\n  }\n\n  /**\n   * Migrate consensus data\n   */\n  async _migrateConsensus(oldDb, swarmMemory) {\n    try {\n      const consensus = oldDb\n        .prepare(\n          `\n        SELECT * FROM consensus\n      `,\n        )\n        .all();\n\n      console.log(`\\nMigrating ${consensus.length} consensus records...`);\n\n      for (const record of consensus) {\n        if (!this.options.dryRun) {\n          await swarmMemory.storeConsensus(record.id, {\n            id: record.id,\n            taskId: record.task_id,\n            proposal: JSON.parse(record.proposal),\n            threshold: record.required_threshold,\n            currentVotes: record.current_votes,\n            totalVoters: record.total_voters,\n            votes: JSON.parse(record.votes),\n            status: record.status,\n            createdAt: record.created_at,\n            deadlineAt: record.deadline_at,\n            completedAt: record.completed_at,\n          });\n        }\n        this.stats.migrated++;\n      }\n    } catch (error) {\n      if (!error.message.includes('no such table')) {\n        console.error('Error migrating consensus:', error.message);\n      }\n    }\n  }\n\n  /**\n   * Helper methods\n   */\n\n  _determineNamespace(type) {\n    const typeMap = {\n      knowledge: 'hive:knowledge',\n      context: 'hive:context',\n      task: 'hive:task',\n      result: 'hive:result',\n      error: 'hive:error',\n      metric: 'hive:metric',\n      consensus: 'hive:consensus',\n      system: 'hive:system',\n    };\n\n    return typeMap[type] || 'default';\n  }\n\n  _calculateTTL(type) {\n    const ttlMap = {\n      context: 3600, // 1 hour\n      task: 1800, // 30 minutes\n      error: 86400, // 24 hours\n      metric: 3600, // 1 hour\n    };\n\n    return ttlMap[type] || null;\n  }\n\n  async _fileExists(filepath) {\n    try {\n      await fs.access(filepath);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n}\n\n/**\n * CLI interface for migration\n */\nexport async function runMigration(options = {}) {\n  const migration = new MemoryMigration(options);\n  return await migration.migrate();\n}\n\n// Export default\nexport default MemoryMigration;\n"],"names":["Database","path","fs","SharedMemory","SwarmMemory","getSwarmDir","getHiveMindDir","MemoryMigration","options","oldDbPath","join","newDbPath","swarmDbPath","dryRun","verbose","stats","total","migrated","skipped","errors","migrate","console","log","oldDbExists","_fileExists","success","sharedMemory","directory","dirname","filename","basename","swarmMemory","initialize","oldDb","readonly","_migrateCollectiveMemory","_migrateMemoryTable","_migrateSwarmData","close","error","message","rows","prepare","all","row","keyParts","key","split","namespace","_determineNamespace","type","value","compressed","JSON","parse","store","ttl","_calculateTTL","metadata","originalId","id","swarmId","swarm_id","createdBy","created_by","confidence","migratedAt","Date","toISOString","process","stdout","write","includes","_migrateAgents","_migrateTasks","_migratePatterns","_migrateConsensus","agents","length","agent","storeAgent","name","status","capabilities","currentTaskId","current_task_id","messageCount","message_count","errorCount","error_count","successCount","success_count","createdAt","created_at","lastActiveAt","last_active_at","tasks","task","storeTask","description","priority","strategy","progress","result","dependencies","assignedAgents","assigned_agents","requireConsensus","require_consensus","consensusAchieved","consensus_achieved","maxAgents","max_agents","requiredCapabilities","required_capabilities","assignedAt","assigned_at","startedAt","started_at","completedAt","completed_at","patterns","pattern","storePattern","pattern_type","data","pattern_data","usageCount","usage_count","successRate","success_rate","lastUsedAt","last_used_at","consensus","record","storeConsensus","taskId","task_id","proposal","threshold","required_threshold","currentVotes","current_votes","totalVoters","total_voters","votes","deadlineAt","deadline_at","typeMap","knowledge","context","metric","system","ttlMap","filepath","access","runMigration","migration"],"mappings":"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"}