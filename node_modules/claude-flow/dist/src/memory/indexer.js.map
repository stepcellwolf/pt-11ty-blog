{"version":3,"sources":["../../../src/memory/indexer.ts"],"sourcesContent":["/**\n * Memory indexer for fast querying\n */\n\nimport type { MemoryEntry, MemoryQuery } from '../utils/types.js';\nimport type { ILogger } from '../core/logger.js';\n\ninterface Index<T> {\n  get(key: T): Set<string>;\n  add(key: T, entryId: string): void;\n  remove(key: T, entryId: string): void;\n  clear(): void;\n}\n\n/**\n * Simple index implementation\n */\nclass SimpleIndex<T> implements Index<T> {\n  private index = new Map<T, Set<string>>();\n\n  get(key: T): Set<string> {\n    return this.index.get(key) || new Set();\n  }\n\n  add(key: T, entryId: string): void {\n    if (!this.index.has(key)) {\n      this.index.set(key, new Set());\n    }\n    this.index.get(key)!.add(entryId);\n  }\n\n  remove(key: T, entryId: string): void {\n    const set = this.index.get(key);\n    if (set) {\n      set.delete(entryId);\n      if (set.size === 0) {\n        this.index.delete(key);\n      }\n    }\n  }\n\n  clear(): void {\n    this.index.clear();\n  }\n\n  keys(): T[] {\n    return Array.from(this.index.keys());\n  }\n}\n\n/**\n * Memory indexer for efficient querying\n */\nexport class MemoryIndexer {\n  private entries = new Map<string, MemoryEntry>();\n  private agentIndex = new SimpleIndex<string>();\n  private sessionIndex = new SimpleIndex<string>();\n  private typeIndex = new SimpleIndex<string>();\n  private tagIndex = new SimpleIndex<string>();\n  private timeIndex = new Map<string, number>(); // id -> timestamp\n\n  constructor(private logger: ILogger) {}\n\n  /**\n   * Builds index from a list of entries\n   */\n  async buildIndex(entries: MemoryEntry[]): Promise<void> {\n    this.logger.info('Building memory index', { entries: entries.length });\n\n    this.clear();\n\n    for (const entry of entries) {\n      this.addEntry(entry);\n    }\n\n    this.logger.info('Memory index built', {\n      totalEntries: this.entries.size,\n      agents: this.agentIndex.keys().length,\n      sessions: this.sessionIndex.keys().length,\n      types: this.typeIndex.keys().length,\n      tags: this.tagIndex.keys().length,\n    });\n  }\n\n  /**\n   * Adds an entry to the index\n   */\n  addEntry(entry: MemoryEntry): void {\n    // Store entry\n    this.entries.set(entry.id, entry);\n\n    // Update indexes\n    this.agentIndex.add(entry.agentId, entry.id);\n    this.sessionIndex.add(entry.sessionId, entry.id);\n    this.typeIndex.add(entry.type, entry.id);\n\n    for (const tag of entry.tags) {\n      this.tagIndex.add(tag, entry.id);\n    }\n\n    this.timeIndex.set(entry.id, entry.timestamp.getTime());\n  }\n\n  /**\n   * Updates an entry in the index\n   */\n  updateEntry(entry: MemoryEntry): void {\n    const existing = this.entries.get(entry.id);\n    if (existing) {\n      this.removeEntry(entry.id);\n    }\n    this.addEntry(entry);\n  }\n\n  /**\n   * Removes an entry from the index\n   */\n  removeEntry(id: string): void {\n    const entry = this.entries.get(id);\n    if (!entry) {\n      return;\n    }\n\n    // Remove from indexes\n    this.agentIndex.remove(entry.agentId, id);\n    this.sessionIndex.remove(entry.sessionId, id);\n    this.typeIndex.remove(entry.type, id);\n\n    for (const tag of entry.tags) {\n      this.tagIndex.remove(tag, id);\n    }\n\n    this.timeIndex.delete(id);\n    this.entries.delete(id);\n  }\n\n  /**\n   * Searches entries using the index\n   */\n  search(query: MemoryQuery): MemoryEntry[] {\n    let resultIds: Set<string> | undefined;\n\n    // Apply index-based filters\n    if (query.agentId) {\n      resultIds = this.intersectSets(resultIds, this.agentIndex.get(query.agentId));\n    }\n\n    if (query.sessionId) {\n      resultIds = this.intersectSets(resultIds, this.sessionIndex.get(query.sessionId));\n    }\n\n    if (query.type) {\n      resultIds = this.intersectSets(resultIds, this.typeIndex.get(query.type));\n    }\n\n    if (query.tags && query.tags.length > 0) {\n      const tagSets = query.tags.map((tag) => this.tagIndex.get(tag));\n      const unionSet = this.unionSets(...tagSets);\n      resultIds = this.intersectSets(resultIds, unionSet);\n    }\n\n    // If no filters applied, get all entries\n    if (!resultIds) {\n      resultIds = new Set(this.entries.keys());\n    }\n\n    // Convert IDs to entries\n    const results: MemoryEntry[] = [];\n    for (const id of resultIds) {\n      const entry = this.entries.get(id);\n      if (entry) {\n        results.push(entry);\n      }\n    }\n\n    // Sort by timestamp (newest first)\n    results.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\n\n    return results;\n  }\n\n  /**\n   * Gets index metrics\n   */\n  getMetrics(): {\n    totalEntries: number;\n    indexSizes: Record<string, number>;\n  } {\n    return {\n      totalEntries: this.entries.size,\n      indexSizes: {\n        agents: this.agentIndex.keys().length,\n        sessions: this.sessionIndex.keys().length,\n        types: this.typeIndex.keys().length,\n        tags: this.tagIndex.keys().length,\n      },\n    };\n  }\n\n  /**\n   * Clears all indexes\n   */\n  clear(): void {\n    this.entries.clear();\n    this.agentIndex.clear();\n    this.sessionIndex.clear();\n    this.typeIndex.clear();\n    this.tagIndex.clear();\n    this.timeIndex.clear();\n  }\n\n  private intersectSets(set1: Set<string> | undefined, set2: Set<string>): Set<string> {\n    if (!set1) {\n      return new Set(set2);\n    }\n\n    const result = new Set<string>();\n    for (const item of set1) {\n      if (set2.has(item)) {\n        result.add(item);\n      }\n    }\n    return result;\n  }\n\n  private unionSets(...sets: Set<string>[]): Set<string> {\n    const result = new Set<string>();\n    for (const set of sets) {\n      for (const item of set) {\n        result.add(item);\n      }\n    }\n    return result;\n  }\n}\n"],"names":["SimpleIndex","index","Map","get","key","Set","add","entryId","has","set","remove","delete","size","clear","keys","Array","from","MemoryIndexer","entries","agentIndex","sessionIndex","typeIndex","tagIndex","timeIndex","logger","buildIndex","info","length","entry","addEntry","totalEntries","agents","sessions","types","tags","id","agentId","sessionId","type","tag","timestamp","getTime","updateEntry","existing","removeEntry","search","query","resultIds","intersectSets","tagSets","map","unionSet","unionSets","results","push","sort","a","b","getMetrics","indexSizes","set1","set2","result","item","sets"],"mappings":"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"}