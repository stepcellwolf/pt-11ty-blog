{"version":3,"sources":["../../../../src/memory/backends/agentdb.js"],"sourcesContent":["/**\n * AgentDB Backend - Direct integration with AgentDB v1.3.9\n * Provides vector storage, HNSW search, and quantization\n */\n\nexport class AgentDBBackend {\n  constructor(options = {}) {\n    this.dbPath = options.dbPath || '.agentdb/claude-flow.db';\n    this.quantization = options.quantization || 'scalar'; // scalar, binary, product\n    this.enableHNSW = options.enableHNSW !== false;\n    this.db = null;\n    this.initialized = false;\n  }\n\n  async initialize() {\n    try {\n      // Dynamic import of AgentDB\n      const { default: AgentDB } = await import('agentdb');\n\n      // Initialize AgentDB instance\n      this.db = new AgentDB({\n        path: this.dbPath,\n        quantization: this.quantization,\n        indexType: this.enableHNSW ? 'hnsw' : 'flat',\n      });\n\n      await this.db.init();\n      this.initialized = true;\n\n      console.error(\n        `[${new Date().toISOString()}] INFO [agentdb-backend] AgentDB initialized at ${this.dbPath}`,\n      );\n      console.error(\n        `[${new Date().toISOString()}] INFO [agentdb-backend] Quantization: ${this.quantization}, HNSW: ${this.enableHNSW}`,\n      );\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Failed to initialize AgentDB: ${error.message}`,\n      );\n      throw new Error(`AgentDB initialization failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * Store a vector with metadata\n   * @param {string} key - Unique identifier\n   * @param {Array<number>} embedding - Vector embedding\n   * @param {Object} metadata - Associated metadata\n   * @returns {Promise<void>}\n   */\n  async storeVector(key, embedding, metadata = {}) {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      await this.db.add({\n        id: key,\n        vector: embedding,\n        metadata: {\n          ...metadata,\n          storedAt: Date.now(),\n        },\n      });\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Failed to store vector: ${error.message}`,\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Search for similar vectors\n   * @param {Array<number>|string} query - Query vector or text\n   * @param {Object} options - Search options\n   * @param {number} options.k - Number of results\n   * @param {string} options.namespace - Filter by namespace\n   * @param {Object} options.filter - Metadata filters\n   * @returns {Promise<Array>} Results with similarity scores\n   */\n  async search(query, options = {}) {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      const results = await this.db.search({\n        vector: query,\n        k: options.k || 10,\n        filter: this._buildFilter(options),\n      });\n\n      return results.map(result => ({\n        id: result.id,\n        similarity: result.score,\n        metadata: result.metadata,\n        value: result.metadata?.value,\n      }));\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Search failed: ${error.message}`,\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Get a specific vector by key\n   * @param {string} key - Vector identifier\n   * @returns {Promise<Object|null>} Vector data or null\n   */\n  async getVector(key) {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      return await this.db.get(key);\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-backend] Get vector failed: ${error.message}`,\n      );\n      return null;\n    }\n  }\n\n  /**\n   * Delete a vector by key\n   * @param {string} key - Vector identifier\n   * @returns {Promise<boolean>} Success status\n   */\n  async deleteVector(key) {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      await this.db.delete(key);\n      return true;\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-backend] Delete vector failed: ${error.message}`,\n      );\n      return false;\n    }\n  }\n\n  /**\n   * Build filter object from options\n   * @private\n   */\n  _buildFilter(options) {\n    const filter = {};\n\n    if (options.namespace) {\n      filter['metadata.namespace'] = options.namespace;\n    }\n\n    if (options.filter) {\n      Object.entries(options.filter).forEach(([key, value]) => {\n        filter[`metadata.${key}`] = value;\n      });\n    }\n\n    return Object.keys(filter).length > 0 ? filter : undefined;\n  }\n\n  /**\n   * Get database statistics\n   * @returns {Promise<Object>} Statistics\n   */\n  async getStats() {\n    if (!this.initialized) {\n      return {\n        initialized: false,\n        vectorCount: 0,\n      };\n    }\n\n    try {\n      const stats = await this.db.stats();\n      return {\n        initialized: true,\n        vectorCount: stats.count || 0,\n        indexType: this.enableHNSW ? 'hnsw' : 'flat',\n        quantization: this.quantization,\n        dbPath: this.dbPath,\n        ...stats,\n      };\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-backend] Stats failed: ${error.message}`,\n      );\n      return {\n        initialized: true,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * Optimize database indices\n   * @returns {Promise<Object>} Optimization results\n   */\n  async optimize() {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      const startTime = Date.now();\n\n      if (this.enableHNSW && this.db.optimize) {\n        await this.db.optimize();\n      }\n\n      return {\n        success: true,\n        duration: Date.now() - startTime,\n        timestamp: Date.now(),\n      };\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Optimization failed: ${error.message}`,\n      );\n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * Export all vectors\n   * @param {string} namespace - Optional namespace filter\n   * @returns {Promise<Array>} All vectors\n   */\n  async exportVectors(namespace = null) {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      const filter = namespace ? { 'metadata.namespace': namespace } : undefined;\n      const results = await this.db.list({ filter });\n\n      return results.map(result => ({\n        id: result.id,\n        vector: result.vector,\n        metadata: result.metadata,\n      }));\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Export failed: ${error.message}`,\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Import vectors in batch\n   * @param {Array} vectors - Array of {id, vector, metadata}\n   * @returns {Promise<Object>} Import results\n   */\n  async importVectors(vectors) {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      const startTime = Date.now();\n      let successCount = 0;\n      let errorCount = 0;\n\n      for (const vector of vectors) {\n        try {\n          await this.storeVector(vector.id, vector.vector, vector.metadata);\n          successCount++;\n        } catch (error) {\n          errorCount++;\n          console.error(\n            `[${new Date().toISOString()}] WARN [agentdb-backend] Import vector failed: ${error.message}`,\n          );\n        }\n      }\n\n      return {\n        success: true,\n        imported: successCount,\n        errors: errorCount,\n        total: vectors.length,\n        duration: Date.now() - startTime,\n      };\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Import failed: ${error.message}`,\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Cleanup expired or invalid vectors\n   * @returns {Promise<Object>} Cleanup results\n   */\n  async cleanup() {\n    if (!this.initialized) {\n      throw new Error('AgentDB not initialized');\n    }\n\n    try {\n      // AgentDB handles its own cleanup internally\n      // This is a placeholder for custom cleanup logic if needed\n      const stats = await this.getStats();\n\n      return {\n        success: true,\n        vectorCount: stats.vectorCount,\n        timestamp: Date.now(),\n      };\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Cleanup failed: ${error.message}`,\n      );\n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * Close database connection\n   * @returns {Promise<void>}\n   */\n  async close() {\n    if (!this.initialized) {\n      return;\n    }\n\n    try {\n      if (this.db && this.db.close) {\n        await this.db.close();\n      }\n      this.initialized = false;\n\n      console.error(\n        `[${new Date().toISOString()}] INFO [agentdb-backend] AgentDB closed`,\n      );\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-backend] Close failed: ${error.message}`,\n      );\n      throw error;\n    }\n  }\n}\n\nexport default AgentDBBackend;\n"],"names":["AgentDBBackend","options","dbPath","quantization","enableHNSW","db","initialized","initialize","default","AgentDB","path","indexType","init","console","error","Date","toISOString","message","Error","storeVector","key","embedding","metadata","add","id","vector","storedAt","now","search","query","results","k","filter","_buildFilter","map","result","similarity","score","value","getVector","get","deleteVector","delete","namespace","Object","entries","forEach","keys","length","undefined","getStats","vectorCount","stats","count","optimize","startTime","success","duration","timestamp","exportVectors","list","importVectors","vectors","successCount","errorCount","imported","errors","total","cleanup","close"],"mappings":"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"}