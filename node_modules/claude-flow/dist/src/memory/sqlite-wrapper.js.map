{"version":3,"sources":["../../../src/memory/sqlite-wrapper.js"],"sourcesContent":["/**\n * SQLite Wrapper with Windows Fallback Support\n * Provides graceful fallback when better-sqlite3 fails to load\n */\n\nimport { createRequire } from 'module';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nlet Database = null;\nlet sqliteAvailable = false;\nlet loadError = null;\n\n/**\n * Try to load better-sqlite3 with comprehensive error handling\n */\nasync function tryLoadSQLite() {\n  try {\n    // Try CommonJS require first (more reliable in Node.js)\n    const require = createRequire(import.meta.url);\n    Database = require('better-sqlite3');\n    sqliteAvailable = true;\n    return true;\n  } catch (requireErr) {\n    // Fallback to ES module import\n    try {\n      const module = await import('better-sqlite3');\n      Database = module.default;\n      sqliteAvailable = true;\n      return true;\n    } catch (importErr) {\n      loadError = importErr;\n\n      // Check for NODE_MODULE_VERSION mismatch (different Node.js ABI)\n      const isVersionMismatch =\n        requireErr.message?.includes('NODE_MODULE_VERSION') ||\n        importErr.message?.includes('NODE_MODULE_VERSION') ||\n        requireErr.message?.includes('was compiled against a different Node.js version') ||\n        importErr.message?.includes('was compiled against a different Node.js version');\n\n      if (isVersionMismatch) {\n        // Extract version info for helpful message\n        const errorMsg = requireErr.message || importErr.message || '';\n        const compiledMatch = errorMsg.match(/NODE_MODULE_VERSION (\\d+)/);\n        const requiredMatch = errorMsg.match(/requires\\s+NODE_MODULE_VERSION (\\d+)/);\n\n        const nodeVersionMap = {\n          '108': '18.x', '115': '20.x', '120': '21.x', '127': '22.x', '131': '23.x'\n        };\n\n        let versionInfo = '';\n        if (compiledMatch && requiredMatch) {\n          const compiled = nodeVersionMap[compiledMatch[1]] || `ABI ${compiledMatch[1]}`;\n          const required = nodeVersionMap[requiredMatch[1]] || `ABI ${requiredMatch[1]}`;\n          versionInfo = `\\n║  Module compiled for Node.js ${compiled}, running Node.js ${required}`.padEnd(79) + '║';\n        }\n\n        console.warn(`\n╔══════════════════════════════════════════════════════════════════════════════╗\n║              Native Module Version Mismatch (NODE_MODULE_VERSION)            ║\n╠══════════════════════════════════════════════════════════════════════════════╣\n║                                                                              ║\n║  The better-sqlite3 module was compiled for a different Node.js version.    ║${versionInfo}\n║                                                                              ║\n║  Claude Flow will continue with JSON fallback storage (still works fine).   ║\n║                                                                              ║\n║  To fix this and use SQLite:                                                 ║\n║                                                                              ║\n║  Option 1 - Rebuild the module:                                              ║\n║  > npm rebuild better-sqlite3                                                ║\n║                                                                              ║\n║  Option 2 - Clear npx cache (if using npx):                                  ║\n║  > rm -rf ~/.npm/_npx/ && npx claude-flow@alpha ...                         ║\n║                                                                              ║\n║  Option 3 - Reinstall dependencies:                                         ║\n║  > rm -rf node_modules && npm install                                        ║\n║                                                                              ║\n╚══════════════════════════════════════════════════════════════════════════════╝\n`);\n        return false;\n      }\n\n      // Check for other Windows/installation errors\n      if (requireErr.message?.includes('Could not locate the bindings file') ||\n          requireErr.message?.includes('The specified module could not be found') ||\n          requireErr.code === 'MODULE_NOT_FOUND') {\n\n        console.warn(`\n╔══════════════════════════════════════════════════════════════════════════════╗\n║                     SQLite Native Module Installation Issue                   ║\n╠══════════════════════════════════════════════════════════════════════════════╣\n║                                                                              ║\n║  The native SQLite module failed to load. This is common on Windows when    ║\n║  using 'npx' or when node-gyp build tools are not available.                ║\n║                                                                              ║\n║  Claude Flow will continue with JSON fallback storage (still works fine).   ║\n║                                                                              ║\n║  To enable SQLite storage:                                                   ║\n║                                                                              ║\n║  Option 1 - Install Build Tools (Windows):                                   ║\n║  > npm install --global windows-build-tools                                  ║\n║  > npm install claude-flow@alpha                                             ║\n║                                                                              ║\n║  Option 2 - Use WSL (Windows Subsystem for Linux):                           ║\n║  Install WSL and run Claude Flow inside a Linux environment                  ║\n║                                                                              ║\n╚══════════════════════════════════════════════════════════════════════════════╝\n`);\n      }\n      \n      return false;\n    }\n  }\n}\n\n/**\n * Check if SQLite is available\n */\nexport async function isSQLiteAvailable() {\n  if (sqliteAvailable !== null) {\n    return sqliteAvailable;\n  }\n  \n  await tryLoadSQLite();\n  return sqliteAvailable;\n}\n\n/**\n * Get SQLite Database constructor or null\n */\nexport async function getSQLiteDatabase() {\n  if (!sqliteAvailable && loadError === null) {\n    await tryLoadSQLite();\n  }\n  \n  return Database;\n}\n\n/**\n * Get the load error if any\n */\nexport function getLoadError() {\n  return loadError;\n}\n\n/**\n * Create a SQLite database instance with fallback\n */\nexport async function createDatabase(dbPath) {\n  const DB = await getSQLiteDatabase();\n  \n  if (!DB) {\n    throw new Error('SQLite is not available. Use fallback storage instead.');\n  }\n  \n  try {\n    return new DB(dbPath);\n  } catch (err) {\n    // Additional Windows-specific error handling\n    if (err.message.includes('EPERM') || err.message.includes('access denied')) {\n      throw new Error(`Cannot create database at ${dbPath}. Permission denied. Try using a different directory or running with administrator privileges.`);\n    }\n    throw err;\n  }\n}\n\n/**\n * Check if running on Windows\n */\nexport function isWindows() {\n  return process.platform === 'win32';\n}\n\n/**\n * Get platform-specific storage recommendations\n */\nexport function getStorageRecommendations() {\n  if (isWindows()) {\n    return {\n      recommended: 'in-memory',\n      reason: 'Windows native module compatibility',\n      alternatives: [\n        'Install Windows build tools for SQLite support',\n        'Use WSL (Windows Subsystem for Linux)',\n        'Use Docker container with Linux'\n      ]\n    };\n  }\n  \n  return {\n    recommended: 'sqlite',\n    reason: 'Best performance and persistence',\n    alternatives: ['in-memory for testing']\n  };\n}\n\n// Pre-load SQLite on module import\ntryLoadSQLite().catch(() => {\n  // Silently handle initial load failure\n});\n\nexport default {\n  isSQLiteAvailable,\n  getSQLiteDatabase,\n  getLoadError,\n  createDatabase,\n  isWindows,\n  getStorageRecommendations\n};"],"names":["createRequire","path","fileURLToPath","__filename","url","__dirname","dirname","Database","sqliteAvailable","loadError","tryLoadSQLite","require","requireErr","module","default","importErr","isVersionMismatch","message","includes","errorMsg","compiledMatch","match","requiredMatch","nodeVersionMap","versionInfo","compiled","required","padEnd","console","warn","code","isSQLiteAvailable","getSQLiteDatabase","getLoadError","createDatabase","dbPath","DB","Error","err","isWindows","process","platform","getStorageRecommendations","recommended","reason","alternatives","catch"],"mappings":"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"}