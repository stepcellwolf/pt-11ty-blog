{"version":3,"sources":["../../../src/memory/advanced-serializer.js"],"sourcesContent":["/**\n * Advanced TypeScript-aware serializer for session persistence\n * Handles complex data structures, functions, and type preservation\n * \n * @module advanced-serializer\n */\n\n/**\n * Enhanced serializer that handles TypeScript-specific data types\n * and complex JavaScript objects that standard JSON can't handle\n */\nexport class AdvancedSerializer {\n  constructor(options = {}) {\n    this.options = {\n      enableCompression: options.enableCompression || false,\n      maxDepth: options.maxDepth || 100,\n      preserveUndefined: options.preserveUndefined !== false,\n      preserveFunctions: options.preserveFunctions || false,\n      preserveSymbols: options.preserveSymbols || false,\n      customSerializers: new Map(options.customSerializers || []),\n      ...options\n    };\n    \n    // Built-in type handlers\n    this.typeHandlers = new Map([\n      ['Date', this._serializeDate.bind(this)],\n      ['Map', this._serializeMap.bind(this)],\n      ['Set', this._serializeSet.bind(this)],\n      ['RegExp', this._serializeRegExp.bind(this)],\n      ['Error', this._serializeError.bind(this)],\n      ['BigInt', this._serializeBigInt.bind(this)],\n      ['ArrayBuffer', this._serializeArrayBuffer.bind(this)],\n      ['TypedArray', this._serializeTypedArray.bind(this)],\n      ['Function', this._serializeFunction.bind(this)],\n      ['Symbol', this._serializeSymbol.bind(this)]\n    ]);\n\n    // Deserialization handlers\n    this.deserializers = new Map([\n      ['__Date__', this._deserializeDate.bind(this)],\n      ['__Map__', this._deserializeMap.bind(this)],\n      ['__Set__', this._deserializeSet.bind(this)],\n      ['__RegExp__', this._deserializeRegExp.bind(this)],\n      ['__Error__', this._deserializeError.bind(this)],\n      ['__BigInt__', this._deserializeBigInt.bind(this)],\n      ['__ArrayBuffer__', this._deserializeArrayBuffer.bind(this)],\n      ['__TypedArray__', this._deserializeTypedArray.bind(this)],\n      ['__Function__', this._deserializeFunction.bind(this)],\n      ['__Symbol__', this._deserializeSymbol.bind(this)],\n      ['__undefined__', () => undefined],\n      ['__NaN__', () => NaN],\n      ['__Infinity__', () => Infinity],\n      ['__-Infinity__', () => -Infinity]\n    ]);\n  }\n\n  /**\n   * Serialize any JavaScript/TypeScript value to a JSON-compatible string\n   */\n  serialize(value, context = { depth: 0, seen: new WeakSet() }) {\n    try {\n      const serialized = this._serializeValue(value, context);\n      const result = JSON.stringify(serialized);\n      \n      if (this.options.enableCompression && result.length > 1024) {\n        // In production, use actual compression library\n        return this._compress(result);\n      }\n      \n      return result;\n    } catch (error) {\n      throw new SerializationError(`Serialization failed: ${error.message}`, {\n        originalError: error,\n        value: this._safeStringify(value)\n      });\n    }\n  }\n\n  /**\n   * Deserialize a string back to the original JavaScript/TypeScript value\n   */\n  deserialize(serialized) {\n    try {\n      let data = serialized;\n      \n      // Handle compression\n      if (this.options.enableCompression && this._isCompressed(serialized)) {\n        data = this._decompress(serialized);\n      }\n      \n      const parsed = JSON.parse(data);\n      return this._deserializeValue(parsed);\n    } catch (error) {\n      throw new DeserializationError(`Deserialization failed: ${error.message}`, {\n        originalError: error,\n        serialized: serialized?.substring?.(0, 200) + '...'\n      });\n    }\n  }\n\n  /**\n   * Serialize session-specific data with enhanced TypeScript support\n   */\n  serializeSessionData(sessionData) {\n    const startTime = Date.now();\n    \n    try {\n      // Enhanced session data with metadata\n      const enhancedData = {\n        ...sessionData,\n        __serializer_meta__: {\n          version: '1.0.0',\n          timestamp: new Date().toISOString(),\n          nodeVersion: process.version,\n          platform: process.platform,\n          serializer: 'AdvancedSerializer'\n        }\n      };\n\n      const result = this.serialize(enhancedData);\n      \n      // Log performance metrics\n      const duration = Date.now() - startTime;\n      if (duration > 100) {\n        console.warn(`[AdvancedSerializer] Slow serialization: ${duration}ms for ${result.length} bytes`);\n      }\n      \n      return result;\n    } catch (error) {\n      throw new SessionSerializationError(`Session serialization failed: ${error.message}`, {\n        originalError: error,\n        sessionId: sessionData?.id,\n        dataKeys: Object.keys(sessionData || {})\n      });\n    }\n  }\n\n  /**\n   * Deserialize session data with validation and recovery\n   */\n  deserializeSessionData(serialized) {\n    try {\n      const data = this.deserialize(serialized);\n      \n      // Validate serializer metadata\n      if (data.__serializer_meta__) {\n        const meta = data.__serializer_meta__;\n        if (meta.serializer !== 'AdvancedSerializer') {\n          console.warn(`[AdvancedSerializer] Data serialized with different serializer: ${meta.serializer}`);\n        }\n        \n        // Remove metadata before returning\n        delete data.__serializer_meta__;\n      }\n      \n      return data;\n    } catch (error) {\n      // Attempt fallback deserialization\n      try {\n        console.warn(`[AdvancedSerializer] Attempting fallback deserialization`);\n        const fallbackData = JSON.parse(serialized);\n        \n        // Basic cleanup of common serialization issues\n        return this._cleanupFallbackData(fallbackData);\n      } catch (fallbackError) {\n        throw new SessionDeserializationError(`Session deserialization failed: ${error.message}`, {\n          originalError: error,\n          fallbackError: fallbackError.message\n        });\n      }\n    }\n  }\n\n  /**\n   * Internal value serialization with type preservation\n   */\n  _serializeValue(value, context) {\n    // Handle circular references\n    if (context.depth > this.options.maxDepth) {\n      return { __circular__: true };\n    }\n\n    // Handle null and primitives\n    if (value === null) return null;\n    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n      return value;\n    }\n\n    // Handle special values\n    if (value === undefined && this.options.preserveUndefined) {\n      return { __type__: '__undefined__' };\n    }\n    if (typeof value === 'number' && isNaN(value)) {\n      return { __type__: '__NaN__' };\n    }\n    if (value === Infinity) {\n      return { __type__: '__Infinity__' };\n    }\n    if (value === -Infinity) {\n      return { __type__: '__-Infinity__' };\n    }\n\n    // Handle objects with circular reference detection\n    if (typeof value === 'object') {\n      if (context.seen.has(value)) {\n        return { __circular__: true };\n      }\n      context.seen.add(value);\n    }\n\n    // Handle typed objects\n    const typeName = this._getObjectType(value);\n    if (this.typeHandlers.has(typeName)) {\n      return this.typeHandlers.get(typeName)(value, context);\n    }\n\n    // Handle custom serializers\n    for (const [matcher, serializer] of this.options.customSerializers) {\n      if (typeof matcher === 'function' && matcher(value)) {\n        return serializer(value, context);\n      }\n    }\n\n    // Handle arrays\n    if (Array.isArray(value)) {\n      return value.map(item => this._serializeValue(item, {\n        ...context,\n        depth: context.depth + 1\n      }));\n    }\n\n    // Handle plain objects\n    if (value && typeof value === 'object') {\n      const result = {};\n      for (const [key, val] of Object.entries(value)) {\n        // Handle symbol keys if enabled\n        if (typeof key === 'symbol' && this.options.preserveSymbols) {\n          result[`__symbol_${key.toString()}__`] = this._serializeValue(val, {\n            ...context,\n            depth: context.depth + 1\n          });\n        } else if (typeof key === 'string') {\n          result[key] = this._serializeValue(val, {\n            ...context,\n            depth: context.depth + 1\n          });\n        }\n      }\n      return result;\n    }\n\n    // Handle functions if enabled\n    if (typeof value === 'function' && this.options.preserveFunctions) {\n      return this._serializeFunction(value, context);\n    }\n\n    // Fallback for unknown types\n    return { __unknown__: this._safeStringify(value) };\n  }\n\n  /**\n   * Internal value deserialization\n   */\n  _deserializeValue(value) {\n    if (value === null || typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n      return value;\n    }\n\n    if (Array.isArray(value)) {\n      return value.map(item => this._deserializeValue(item));\n    }\n\n    if (value && typeof value === 'object') {\n      // Handle special markers\n      if (value.__circular__) {\n        return '[Circular Reference]';\n      }\n      \n      if (value.__unknown__) {\n        return `[Unknown Type: ${value.__unknown__}]`;\n      }\n\n      // Handle typed values\n      if (value.__type__ && this.deserializers.has(value.__type__)) {\n        return this.deserializers.get(value.__type__)(value);\n      }\n\n      // Handle regular objects\n      const result = {};\n      for (const [key, val] of Object.entries(value)) {\n        // Handle symbol keys\n        if (key.startsWith('__symbol_') && key.endsWith('__')) {\n          const symbolKey = Symbol.for(key.slice(9, -2));\n          result[symbolKey] = this._deserializeValue(val);\n        } else {\n          result[key] = this._deserializeValue(val);\n        }\n      }\n      return result;\n    }\n\n    return value;\n  }\n\n  /**\n   * Type-specific serializers\n   */\n  _serializeDate(date) {\n    return {\n      __type__: '__Date__',\n      value: date.toISOString()\n    };\n  }\n\n  _serializeMap(map) {\n    return {\n      __type__: '__Map__',\n      entries: Array.from(map.entries()).map(([k, v]) => [\n        this._serializeValue(k, { depth: 0, seen: new WeakSet() }),\n        this._serializeValue(v, { depth: 0, seen: new WeakSet() })\n      ])\n    };\n  }\n\n  _serializeSet(set) {\n    return {\n      __type__: '__Set__',\n      values: Array.from(set).map(v => this._serializeValue(v, { depth: 0, seen: new WeakSet() }))\n    };\n  }\n\n  _serializeRegExp(regexp) {\n    return {\n      __type__: '__RegExp__',\n      source: regexp.source,\n      flags: regexp.flags\n    };\n  }\n\n  _serializeError(error) {\n    return {\n      __type__: '__Error__',\n      name: error.name,\n      message: error.message,\n      stack: error.stack,\n      cause: error.cause ? this._serializeValue(error.cause, { depth: 0, seen: new WeakSet() }) : undefined\n    };\n  }\n\n  _serializeBigInt(bigint) {\n    return {\n      __type__: '__BigInt__',\n      value: bigint.toString()\n    };\n  }\n\n  _serializeArrayBuffer(buffer) {\n    return {\n      __type__: '__ArrayBuffer__',\n      data: Array.from(new Uint8Array(buffer))\n    };\n  }\n\n  _serializeTypedArray(array) {\n    return {\n      __type__: '__TypedArray__',\n      constructor: array.constructor.name,\n      data: Array.from(array)\n    };\n  }\n\n  _serializeFunction(func) {\n    if (!this.options.preserveFunctions) {\n      return { __type__: '__Function__', name: func.name || '[Anonymous]' };\n    }\n    \n    return {\n      __type__: '__Function__',\n      name: func.name,\n      source: func.toString(),\n      isAsync: func.constructor.name === 'AsyncFunction',\n      isGenerator: func.constructor.name === 'GeneratorFunction'\n    };\n  }\n\n  _serializeSymbol(symbol) {\n    return {\n      __type__: '__Symbol__',\n      description: symbol.description,\n      key: Symbol.keyFor(symbol)\n    };\n  }\n\n  /**\n   * Type-specific deserializers\n   */\n  _deserializeDate(data) {\n    return new Date(data.value);\n  }\n\n  _deserializeMap(data) {\n    const map = new Map();\n    for (const [k, v] of data.entries) {\n      map.set(this._deserializeValue(k), this._deserializeValue(v));\n    }\n    return map;\n  }\n\n  _deserializeSet(data) {\n    return new Set(data.values.map(v => this._deserializeValue(v)));\n  }\n\n  _deserializeRegExp(data) {\n    return new RegExp(data.source, data.flags);\n  }\n\n  _deserializeError(data) {\n    const error = new Error(data.message);\n    error.name = data.name;\n    error.stack = data.stack;\n    if (data.cause !== undefined) {\n      error.cause = this._deserializeValue(data.cause);\n    }\n    return error;\n  }\n\n  _deserializeBigInt(data) {\n    return BigInt(data.value);\n  }\n\n  _deserializeArrayBuffer(data) {\n    return new Uint8Array(data.data).buffer;\n  }\n\n  _deserializeTypedArray(data) {\n    const Constructor = globalThis[data.constructor];\n    if (!Constructor) {\n      throw new Error(`Unknown TypedArray constructor: ${data.constructor}`);\n    }\n    return new Constructor(data.data);\n  }\n\n  _deserializeFunction(data) {\n    if (!this.options.preserveFunctions || !data.source) {\n      return function restoredFunction() {\n        throw new Error(`Function ${data.name} was not preserved during serialization`);\n      };\n    }\n\n    try {\n      // This is potentially unsafe - use with caution in production\n      if (data.isAsync) {\n        return new Function(`return (${data.source})`)();\n      } else if (data.isGenerator) {\n        return new Function(`return (${data.source})`)();\n      } else {\n        return new Function(`return (${data.source})`)();\n      }\n    } catch (error) {\n      console.warn(`Failed to restore function ${data.name}:`, error.message);\n      return function restoredFunction() {\n        throw new Error(`Function ${data.name} could not be restored: ${error.message}`);\n      };\n    }\n  }\n\n  _deserializeSymbol(data) {\n    if (data.key) {\n      return Symbol.for(data.key);\n    }\n    return Symbol(data.description);\n  }\n\n  /**\n   * Utility methods\n   */\n  _getObjectType(obj) {\n    if (obj instanceof Date) return 'Date';\n    if (obj instanceof Map) return 'Map';\n    if (obj instanceof Set) return 'Set';\n    if (obj instanceof RegExp) return 'RegExp';\n    if (obj instanceof Error) return 'Error';\n    if (typeof obj === 'bigint') return 'BigInt';\n    if (obj instanceof ArrayBuffer) return 'ArrayBuffer';\n    if (ArrayBuffer.isView(obj) && !(obj instanceof DataView)) return 'TypedArray';\n    if (typeof obj === 'function') return 'Function';\n    if (typeof obj === 'symbol') return 'Symbol';\n    return 'Object';\n  }\n\n  _safeStringify(value) {\n    try {\n      return JSON.stringify(value);\n    } catch {\n      return '[Non-serializable]';\n    }\n  }\n\n  _cleanupFallbackData(data) {\n    // Basic cleanup for common serialization issues\n    if (typeof data === 'object' && data !== null) {\n      for (const [key, value] of Object.entries(data)) {\n        if (typeof value === 'string') {\n          // Try to parse common serialized values\n          if (value === 'undefined') {\n            data[key] = undefined;\n          } else if (value === 'NaN') {\n            data[key] = NaN;\n          } else if (value === 'Infinity') {\n            data[key] = Infinity;\n          } else if (value === '-Infinity') {\n            data[key] = -Infinity;\n          }\n        } else if (typeof value === 'object') {\n          data[key] = this._cleanupFallbackData(value);\n        }\n      }\n    }\n    return data;\n  }\n\n  _compress(data) {\n    // Placeholder for compression - implement actual compression in production\n    return `__compressed__${Buffer.from(data).toString('base64')}`;\n  }\n\n  _decompress(data) {\n    // Placeholder for decompression\n    if (data.startsWith('__compressed__')) {\n      return Buffer.from(data.substring(14), 'base64').toString();\n    }\n    return data;\n  }\n\n  _isCompressed(data) {\n    return typeof data === 'string' && data.startsWith('__compressed__');\n  }\n}\n\n/**\n * Custom error classes for better error handling\n */\nexport class SerializationError extends Error {\n  constructor(message, details = {}) {\n    super(message);\n    this.name = 'SerializationError';\n    this.details = details;\n  }\n}\n\nexport class DeserializationError extends Error {\n  constructor(message, details = {}) {\n    super(message);\n    this.name = 'DeserializationError';\n    this.details = details;\n  }\n}\n\nexport class SessionSerializationError extends SerializationError {\n  constructor(message, details = {}) {\n    super(message, details);\n    this.name = 'SessionSerializationError';\n  }\n}\n\nexport class SessionDeserializationError extends DeserializationError {\n  constructor(message, details = {}) {\n    super(message, details);\n    this.name = 'SessionDeserializationError';\n  }\n}\n\n/**\n * Factory function for creating pre-configured serializers\n */\nexport function createSessionSerializer(options = {}) {\n  return new AdvancedSerializer({\n    preserveUndefined: true,\n    preserveFunctions: false, // Disabled for security\n    preserveSymbols: false,\n    enableCompression: true,\n    maxDepth: 50,\n    ...options\n  });\n}\n\n/**\n * Utility functions for common serialization tasks\n */\nexport function serializeSessionCheckpoint(checkpointData) {\n  const serializer = createSessionSerializer();\n  return serializer.serializeSessionData(checkpointData);\n}\n\nexport function deserializeSessionCheckpoint(serializedData) {\n  const serializer = createSessionSerializer();\n  return serializer.deserializeSessionData(serializedData);\n}\n\nexport function serializeSessionMetadata(metadata) {\n  const serializer = createSessionSerializer({ maxDepth: 20 });\n  return serializer.serialize(metadata);\n}\n\nexport function deserializeSessionMetadata(serializedMetadata) {\n  const serializer = createSessionSerializer({ maxDepth: 20 });\n  return serializer.deserialize(serializedMetadata);\n}\n\n// Export default instance for convenience\nexport default new AdvancedSerializer();"],"names":["AdvancedSerializer","options","enableCompression","maxDepth","preserveUndefined","preserveFunctions","preserveSymbols","customSerializers","Map","typeHandlers","_serializeDate","bind","_serializeMap","_serializeSet","_serializeRegExp","_serializeError","_serializeBigInt","_serializeArrayBuffer","_serializeTypedArray","_serializeFunction","_serializeSymbol","deserializers","_deserializeDate","_deserializeMap","_deserializeSet","_deserializeRegExp","_deserializeError","_deserializeBigInt","_deserializeArrayBuffer","_deserializeTypedArray","_deserializeFunction","_deserializeSymbol","undefined","NaN","Infinity","serialize","value","context","depth","seen","WeakSet","serialized","_serializeValue","result","JSON","stringify","length","_compress","error","SerializationError","message","originalError","_safeStringify","deserialize","data","_isCompressed","_decompress","parsed","parse","_deserializeValue","DeserializationError","substring","serializeSessionData","sessionData","startTime","Date","now","enhancedData","__serializer_meta__","version","timestamp","toISOString","nodeVersion","process","platform","serializer","duration","console","warn","SessionSerializationError","sessionId","id","dataKeys","Object","keys","deserializeSessionData","meta","fallbackData","_cleanupFallbackData","fallbackError","SessionDeserializationError","__circular__","__type__","isNaN","has","add","typeName","_getObjectType","get","matcher","Array","isArray","map","item","key","val","entries","toString","__unknown__","startsWith","endsWith","symbolKey","Symbol","for","slice","date","from","k","v","set","values","regexp","source","flags","name","stack","cause","bigint","buffer","Uint8Array","array","func","isAsync","isGenerator","symbol","description","keyFor","Set","RegExp","Error","BigInt","Constructor","globalThis","restoredFunction","Function","obj","ArrayBuffer","isView","DataView","Buffer","details","createSessionSerializer","serializeSessionCheckpoint","checkpointData","deserializeSessionCheckpoint","serializedData","serializeSessionMetadata","metadata","deserializeSessionMetadata","serializedMetadata"],"mappings":"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"}