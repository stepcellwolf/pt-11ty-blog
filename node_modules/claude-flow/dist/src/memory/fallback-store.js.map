{"version":3,"sources":["../../../src/memory/fallback-store.js"],"sourcesContent":["/**\n * Fallback memory store that tries SQLite first, then falls back to in-memory storage\n * Designed to handle npx environments where native modules may fail to load\n */\n\nimport { SqliteMemoryStore } from './sqlite-store.js';\nimport { InMemoryStore } from './in-memory-store.js';\nimport { isSQLiteAvailable, getLoadError, isWindows } from './sqlite-wrapper.js';\n\nclass FallbackMemoryStore {\n  constructor(options = {}) {\n    this.options = options;\n    this.primaryStore = null;\n    this.fallbackStore = null;\n    this.useFallback = false;\n    this.initializationAttempted = false;\n  }\n\n  async initialize() {\n    if (this.initializationAttempted) return;\n    this.initializationAttempted = true;\n\n    // Check if SQLite is available before attempting initialization\n    const sqliteAvailable = await isSQLiteAvailable();\n    \n    if (!sqliteAvailable) {\n      // Skip SQLite initialization if module can't be loaded\n      const loadError = getLoadError();\n      console.error(\n        `[${new Date().toISOString()}] WARN [fallback-store] SQLite module not available:`,\n        loadError?.message || 'Unknown error',\n      );\n      \n      // Use in-memory store directly\n      this.fallbackStore = new InMemoryStore(this.options);\n      await this.fallbackStore.initialize();\n      this.useFallback = true;\n      \n      this._logFallbackUsage();\n      return;\n    }\n\n    // Try to initialize SQLite store\n    try {\n      this.primaryStore = new SqliteMemoryStore(this.options);\n      await this.primaryStore.initialize();\n      console.error(\n        `[${new Date().toISOString()}] INFO [fallback-store] Successfully initialized SQLite store`,\n      );\n      this.useFallback = false;\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [fallback-store] SQLite initialization failed:`,\n        error.message,\n      );\n\n      // Fall back to in-memory store\n      this.fallbackStore = new InMemoryStore(this.options);\n      await this.fallbackStore.initialize();\n      this.useFallback = true;\n\n      this._logFallbackUsage();\n    }\n  }\n\n  _logFallbackUsage() {\n    console.error(\n      `[${new Date().toISOString()}] INFO [fallback-store] Using in-memory store (data will not persist across sessions)`,\n    );\n    \n    if (isWindows()) {\n      console.error(\n        `[${new Date().toISOString()}] INFO [fallback-store] Windows detected. For persistent storage options, see: https://github.com/ruvnet/claude-code-flow/docs/windows-installation.md`,\n      );\n    } else {\n      console.error(\n        `[${new Date().toISOString()}] INFO [fallback-store] To enable persistent storage, install the package locally: npm install claude-flow@alpha`,\n      );\n    }\n  }\n\n  get activeStore() {\n    return this.useFallback ? this.fallbackStore : this.primaryStore;\n  }\n\n  async store(key, value, options = {}) {\n    await this.initialize();\n    return this.activeStore.store(key, value, options);\n  }\n\n  async retrieve(key, options = {}) {\n    await this.initialize();\n    return this.activeStore.retrieve(key, options);\n  }\n\n  async list(options = {}) {\n    await this.initialize();\n    return this.activeStore.list(options);\n  }\n\n  async delete(key, options = {}) {\n    await this.initialize();\n    return this.activeStore.delete(key, options);\n  }\n\n  async search(pattern, options = {}) {\n    await this.initialize();\n    return this.activeStore.search(pattern, options);\n  }\n\n  async cleanup() {\n    await this.initialize();\n    return this.activeStore.cleanup();\n  }\n\n  close() {\n    if (this.primaryStore) {\n      this.primaryStore.close();\n    }\n    if (this.fallbackStore) {\n      this.fallbackStore.close();\n    }\n  }\n\n  isUsingFallback() {\n    return this.useFallback;\n  }\n}\n\n// Export a singleton instance for MCP server\nexport const memoryStore = new FallbackMemoryStore();\n\nexport { FallbackMemoryStore };\nexport default FallbackMemoryStore;\n"],"names":["SqliteMemoryStore","InMemoryStore","isSQLiteAvailable","getLoadError","isWindows","FallbackMemoryStore","options","primaryStore","fallbackStore","useFallback","initializationAttempted","initialize","sqliteAvailable","loadError","console","error","Date","toISOString","message","_logFallbackUsage","activeStore","store","key","value","retrieve","list","delete","search","pattern","cleanup","close","isUsingFallback","memoryStore"],"mappings":"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"}