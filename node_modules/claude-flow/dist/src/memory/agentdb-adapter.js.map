{"version":3,"sources":["../../../src/memory/agentdb-adapter.js"],"sourcesContent":["/**\n * AgentDB Memory Adapter - v1.3.9 Integration\n * Extends EnhancedMemory with vector search capabilities\n * 100% backward compatible with existing memory operations\n */\n\nimport { EnhancedMemory } from './enhanced-memory.js';\nimport { AgentDBBackend } from './backends/agentdb.js';\n\nexport class AgentDBMemoryAdapter extends EnhancedMemory {\n  constructor(options = {}) {\n    super(options);\n\n    /**\n     * Operational modes:\n     * - 'hybrid': AgentDB for new features, fallback to legacy (default, recommended)\n     * - 'agentdb': AgentDB only, fail if unavailable\n     * - 'legacy': Legacy only, no AgentDB features\n     */\n    this.mode = options.mode || 'hybrid';\n\n    /**\n     * AgentDB instance for vector operations\n     * Null if mode is 'legacy' or initialization fails\n     */\n    this.agentdb = null;\n\n    /**\n     * Track initialization state\n     */\n    this.agentdbInitialized = false;\n    this.agentdbError = null;\n  }\n\n  async initialize() {\n    // Always initialize legacy memory first\n    await super.initialize();\n\n    // Initialize AgentDB if mode allows\n    if (this.mode !== 'legacy') {\n      try {\n        this.agentdb = new AgentDBBackend({\n          dbPath: this.options.agentdbPath || '.agentdb/claude-flow.db',\n          quantization: this.options.quantization || 'scalar',\n          enableHNSW: this.options.enableHNSW !== false,\n        });\n\n        await this.agentdb.initialize();\n        this.agentdbInitialized = true;\n\n        console.error(\n          `[${new Date().toISOString()}] INFO [agentdb-adapter] AgentDB initialized in ${this.mode} mode`,\n        );\n      } catch (error) {\n        this.agentdbError = error;\n\n        if (this.mode === 'agentdb') {\n          // Fail hard if AgentDB-only mode\n          throw new Error(`AgentDB initialization failed in agentdb-only mode: ${error.message}`);\n        }\n\n        // Hybrid mode: warn and continue with legacy\n        console.error(\n          `[${new Date().toISOString()}] WARN [agentdb-adapter] AgentDB initialization failed, using legacy mode: ${error.message}`,\n        );\n      }\n    }\n  }\n\n  /**\n   * Check if AgentDB is available\n   * @returns {boolean} True if AgentDB is initialized and ready\n   */\n  isAgentDBAvailable() {\n    return this.agentdbInitialized && this.agentdb !== null;\n  }\n\n  /**\n   * Store data with optional vector embedding\n   * Backward compatible with legacy store() method\n   *\n   * @param {string} key - Storage key\n   * @param {*} value - Value to store\n   * @param {Object} options - Storage options\n   * @param {string} options.embedding - Optional embedding vector for semantic search\n   * @param {Object} options.metadata - Metadata for the entry\n   * @param {string} options.namespace - Namespace for organization\n   * @param {number} options.ttl - Time to live in seconds\n   * @returns {Promise<*>} Storage result\n   */\n  async storeWithEmbedding(key, value, options = {}) {\n    // Always store in legacy for backward compatibility\n    const legacyResult = await this.store(key, value, options);\n\n    // If embedding provided and AgentDB available, store vector\n    if (options.embedding && this.isAgentDBAvailable()) {\n      try {\n        await this.agentdb.storeVector(key, options.embedding, {\n          value,\n          metadata: options.metadata,\n          namespace: options.namespace,\n          timestamp: Date.now(),\n        });\n      } catch (error) {\n        console.error(\n          `[${new Date().toISOString()}] WARN [agentdb-adapter] Vector storage failed: ${error.message}`,\n        );\n        // Don't fail if vector storage fails in hybrid mode\n      }\n    }\n\n    return legacyResult;\n  }\n\n  /**\n   * Perform semantic vector search\n   * Falls back to legacy search if AgentDB unavailable\n   *\n   * @param {Array<number>|string} query - Query vector or embedding\n   * @param {Object} options - Search options\n   * @param {number} options.k - Number of results (default: 10)\n   * @param {string} options.namespace - Filter by namespace\n   * @param {Object} options.filter - Additional filters\n   * @returns {Promise<Array>} Search results with similarity scores\n   */\n  async vectorSearch(query, options = {}) {\n    if (!this.isAgentDBAvailable()) {\n      // Fallback to legacy pattern search\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-adapter] AgentDB unavailable, falling back to legacy search`,\n      );\n\n      const pattern = typeof query === 'string' ? query : '*';\n      return this.search(pattern, {\n        namespace: options.namespace,\n        limit: options.k || 10,\n      });\n    }\n\n    try {\n      return await this.agentdb.search(query, {\n        k: options.k || 10,\n        namespace: options.namespace,\n        filter: options.filter,\n      });\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] ERROR [agentdb-adapter] Vector search failed: ${error.message}`,\n      );\n\n      // Fallback to legacy in hybrid mode\n      if (this.mode === 'hybrid') {\n        const pattern = typeof query === 'string' ? query : '*';\n        return this.search(pattern, {\n          namespace: options.namespace,\n          limit: options.k || 10,\n        });\n      }\n\n      throw error;\n    }\n  }\n\n  /**\n   * Retrieve semantically similar data\n   * Combines vector search with legacy retrieval\n   *\n   * @param {string} query - Query text or embedding\n   * @param {Object} options - Retrieval options\n   * @returns {Promise<*>} Retrieved value or null\n   */\n  async semanticRetrieve(query, options = {}) {\n    if (!this.isAgentDBAvailable()) {\n      // Fallback to exact key match\n      return this.retrieve(query, options);\n    }\n\n    try {\n      const results = await this.vectorSearch(query, {\n        k: 1,\n        namespace: options.namespace,\n        filter: options.filter,\n      });\n\n      if (results.length === 0) {\n        return null;\n      }\n\n      // Return the most similar result\n      return results[0].value || results[0].metadata?.value;\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-adapter] Semantic retrieve failed: ${error.message}`,\n      );\n\n      // Fallback to exact match\n      return this.retrieve(query, options);\n    }\n  }\n\n  /**\n   * Store knowledge with semantic embedding\n   * Enhanced version of storeKnowledge with vector support\n   */\n  async storeKnowledgeWithEmbedding(domain, key, value, metadata = {}, embedding = null) {\n    // Store in legacy knowledge base\n    const legacyResult = await this.storeKnowledge(domain, key, value, metadata);\n\n    // If embedding provided, store vector\n    if (embedding && this.isAgentDBAvailable()) {\n      try {\n        await this.agentdb.storeVector(`knowledge:${domain}:${key}`, embedding, {\n          domain,\n          key,\n          value,\n          metadata,\n          createdAt: Date.now(),\n        });\n      } catch (error) {\n        console.error(\n          `[${new Date().toISOString()}] WARN [agentdb-adapter] Knowledge vector storage failed: ${error.message}`,\n        );\n      }\n    }\n\n    return legacyResult;\n  }\n\n  /**\n   * Search knowledge semantically\n   * Enhanced version of searchKnowledge with vector support\n   */\n  async searchKnowledgeSemantic(domain, queryEmbedding, options = {}) {\n    if (!this.isAgentDBAvailable()) {\n      // Fallback to legacy pattern search\n      return this.searchKnowledge(domain, '*');\n    }\n\n    try {\n      return await this.agentdb.search(queryEmbedding, {\n        k: options.limit || 50,\n        filter: { domain },\n      });\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-adapter] Semantic knowledge search failed: ${error.message}`,\n      );\n      return this.searchKnowledge(domain, '*');\n    }\n  }\n\n  /**\n   * Get AgentDB statistics\n   * @returns {Promise<Object>} Database statistics\n   */\n  async getAgentDBStats() {\n    if (!this.isAgentDBAvailable()) {\n      return {\n        available: false,\n        error: this.agentdbError?.message || 'AgentDB not initialized',\n      };\n    }\n\n    try {\n      return await this.agentdb.getStats();\n    } catch (error) {\n      return {\n        available: true,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * Optimize AgentDB indices\n   * @returns {Promise<Object>} Optimization results\n   */\n  async optimizeAgentDB() {\n    if (!this.isAgentDBAvailable()) {\n      throw new Error('AgentDB not available for optimization');\n    }\n\n    return this.agentdb.optimize();\n  }\n\n  /**\n   * Export data including vectors\n   * @param {string} namespace - Optional namespace filter\n   * @returns {Promise<Object>} Exported data with vectors\n   */\n  async exportDataWithVectors(namespace = null) {\n    const legacyData = await this.exportData(namespace);\n\n    if (!this.isAgentDBAvailable()) {\n      return {\n        legacy: legacyData,\n        vectors: null,\n        agentdbAvailable: false,\n      };\n    }\n\n    try {\n      const vectorData = await this.agentdb.exportVectors(namespace);\n      return {\n        legacy: legacyData,\n        vectors: vectorData,\n        agentdbAvailable: true,\n      };\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-adapter] Vector export failed: ${error.message}`,\n      );\n      return {\n        legacy: legacyData,\n        vectors: null,\n        agentdbAvailable: true,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * Cleanup both legacy and AgentDB data\n   * @returns {Promise<Object>} Cleanup results\n   */\n  async cleanupAll() {\n    const legacyCleanup = await this.cleanupExpired();\n\n    if (!this.isAgentDBAvailable()) {\n      return {\n        legacy: legacyCleanup,\n        agentdb: null,\n      };\n    }\n\n    try {\n      const agentdbCleanup = await this.agentdb.cleanup();\n      return {\n        legacy: legacyCleanup,\n        agentdb: agentdbCleanup,\n      };\n    } catch (error) {\n      console.error(\n        `[${new Date().toISOString()}] WARN [agentdb-adapter] AgentDB cleanup failed: ${error.message}`,\n      );\n      return {\n        legacy: legacyCleanup,\n        agentdb: null,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * Close both legacy and AgentDB connections\n   * @returns {Promise<void>}\n   */\n  async close() {\n    await super.close?.();\n\n    if (this.isAgentDBAvailable()) {\n      try {\n        await this.agentdb.close();\n      } catch (error) {\n        console.error(\n          `[${new Date().toISOString()}] WARN [agentdb-adapter] AgentDB close failed: ${error.message}`,\n        );\n      }\n    }\n  }\n}\n\nexport default AgentDBMemoryAdapter;\n"],"names":["EnhancedMemory","AgentDBBackend","AgentDBMemoryAdapter","options","mode","agentdb","agentdbInitialized","agentdbError","initialize","dbPath","agentdbPath","quantization","enableHNSW","console","error","Date","toISOString","Error","message","isAgentDBAvailable","storeWithEmbedding","key","value","legacyResult","store","embedding","storeVector","metadata","namespace","timestamp","now","vectorSearch","query","pattern","search","limit","k","filter","semanticRetrieve","retrieve","results","length","storeKnowledgeWithEmbedding","domain","storeKnowledge","createdAt","searchKnowledgeSemantic","queryEmbedding","searchKnowledge","getAgentDBStats","available","getStats","optimizeAgentDB","optimize","exportDataWithVectors","legacyData","exportData","legacy","vectors","agentdbAvailable","vectorData","exportVectors","cleanupAll","legacyCleanup","cleanupExpired","agentdbCleanup","cleanup","close"],"mappings":"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"}