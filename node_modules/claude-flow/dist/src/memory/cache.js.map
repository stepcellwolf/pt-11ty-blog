{"version":3,"sources":["../../../src/memory/cache.ts"],"sourcesContent":["/**\n * Memory cache implementation with LRU eviction\n */\n\nimport type { MemoryEntry } from '../utils/types.js';\nimport type { ILogger } from '../core/logger.js';\n\ninterface CacheEntry {\n  data: MemoryEntry;\n  size: number;\n  lastAccessed: number;\n  dirty: boolean;\n}\n\n/**\n * LRU cache for memory entries\n */\nexport class MemoryCache {\n  private cache = new Map<string, CacheEntry>();\n  private currentSize = 0;\n  private hits = 0;\n  private misses = 0;\n\n  constructor(\n    private maxSize: number,\n    private logger: ILogger,\n  ) {}\n\n  /**\n   * Gets an entry from the cache\n   */\n  get(id: string): MemoryEntry | undefined {\n    const entry = this.cache.get(id);\n\n    if (!entry) {\n      this.misses++;\n      return undefined;\n    }\n\n    // Update access time\n    entry.lastAccessed = Date.now();\n    this.hits++;\n\n    return entry.data;\n  }\n\n  /**\n   * Sets an entry in the cache\n   */\n  set(id: string, data: MemoryEntry, dirty = true): void {\n    const size = this.calculateSize(data);\n\n    // Check if we need to evict entries\n    if (this.currentSize + size > this.maxSize) {\n      this.evict(size);\n    }\n\n    const entry: CacheEntry = {\n      data,\n      size,\n      lastAccessed: Date.now(),\n      dirty,\n    };\n\n    // Update size if replacing existing entry\n    const existing = this.cache.get(id);\n    if (existing) {\n      this.currentSize -= existing.size;\n    }\n\n    this.cache.set(id, entry);\n    this.currentSize += size;\n  }\n\n  /**\n   * Deletes an entry from the cache\n   */\n  delete(id: string): void {\n    const entry = this.cache.get(id);\n    if (entry) {\n      this.currentSize -= entry.size;\n      this.cache.delete(id);\n    }\n  }\n\n  /**\n   * Gets entries by prefix\n   */\n  getByPrefix(prefix: string): MemoryEntry[] {\n    const results: MemoryEntry[] = [];\n\n    for (const [id, entry] of this.cache) {\n      if (id.startsWith(prefix)) {\n        entry.lastAccessed = Date.now();\n        results.push(entry.data);\n      }\n    }\n\n    return results;\n  }\n\n  /**\n   * Gets all dirty entries\n   */\n  getDirtyEntries(): MemoryEntry[] {\n    const dirtyEntries: MemoryEntry[] = [];\n\n    for (const entry of this.cache.values()) {\n      if (entry.dirty) {\n        dirtyEntries.push(entry.data);\n      }\n    }\n\n    return dirtyEntries;\n  }\n\n  /**\n   * Marks entries as clean\n   */\n  markClean(ids: string[]): void {\n    for (const id of ids) {\n      const entry = this.cache.get(id);\n      if (entry) {\n        entry.dirty = false;\n      }\n    }\n  }\n\n  /**\n   * Gets all entries\n   */\n  getAllEntries(): MemoryEntry[] {\n    return Array.from(this.cache.values()).map((entry) => entry.data);\n  }\n\n  /**\n   * Gets cache metrics\n   */\n  getMetrics(): {\n    size: number;\n    entries: number;\n    hitRate: number;\n    maxSize: number;\n  } {\n    const totalRequests = this.hits + this.misses;\n    const hitRate = totalRequests > 0 ? this.hits / totalRequests : 0;\n\n    return {\n      size: this.currentSize,\n      entries: this.cache.size,\n      hitRate,\n      maxSize: this.maxSize,\n    };\n  }\n\n  /**\n   * Clears the cache\n   */\n  clear(): void {\n    this.cache.clear();\n    this.currentSize = 0;\n    this.hits = 0;\n    this.misses = 0;\n  }\n\n  /**\n   * Performs cache maintenance\n   */\n  performMaintenance(): void {\n    // Remove expired entries if needed\n    // For now, just log metrics\n    const metrics = this.getMetrics();\n    this.logger.debug('Cache maintenance', metrics);\n  }\n\n  private calculateSize(entry: MemoryEntry): number {\n    // Rough estimate of memory size\n    let size = 0;\n\n    // String fields\n    size += entry.id.length * 2; // UTF-16\n    size += entry.agentId.length * 2;\n    size += entry.sessionId.length * 2;\n    size += entry.type.length * 2;\n    size += entry.content.length * 2;\n\n    // Tags\n    size += entry.tags.reduce((sum, tag) => sum + tag.length * 2, 0);\n\n    // JSON objects (rough estimate)\n    size += JSON.stringify(entry.context).length * 2;\n    if (entry.metadata) {\n      size += JSON.stringify(entry.metadata).length * 2;\n    }\n\n    // Fixed size fields\n    size += 8; // timestamp\n    size += 4; // version\n    size += 100; // overhead\n\n    return size;\n  }\n\n  private evict(requiredSpace: number): void {\n    this.logger.debug('Cache eviction triggered', {\n      requiredSpace,\n      currentSize: this.currentSize,\n    });\n\n    // Sort entries by last accessed time (oldest first)\n    const entries = Array.from(this.cache.entries()).sort(\n      (a, b) => a[1].lastAccessed - b[1].lastAccessed,\n    );\n\n    let freedSpace = 0;\n    const evicted: string[] = [];\n\n    for (const [id, entry] of entries) {\n      if (freedSpace >= requiredSpace) {\n        break;\n      }\n\n      // Don't evict dirty entries if possible\n      if (entry.dirty && evicted.length > 0) {\n        continue;\n      }\n\n      this.cache.delete(id);\n      this.currentSize -= entry.size;\n      freedSpace += entry.size;\n      evicted.push(id);\n    }\n\n    this.logger.debug('Cache entries evicted', {\n      count: evicted.length,\n      freedSpace,\n    });\n  }\n}\n"],"names":["MemoryCache","cache","Map","currentSize","hits","misses","maxSize","logger","get","id","entry","undefined","lastAccessed","Date","now","data","set","dirty","size","calculateSize","evict","existing","delete","getByPrefix","prefix","results","startsWith","push","getDirtyEntries","dirtyEntries","values","markClean","ids","getAllEntries","Array","from","map","getMetrics","totalRequests","hitRate","entries","clear","performMaintenance","metrics","debug","length","agentId","sessionId","type","content","tags","reduce","sum","tag","JSON","stringify","context","metadata","requiredSpace","sort","a","b","freedSpace","evicted","count"],"mappings":"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"}