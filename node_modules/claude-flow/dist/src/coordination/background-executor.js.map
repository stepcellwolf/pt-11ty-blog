{"version":3,"sources":["../../../src/coordination/background-executor.ts"],"sourcesContent":["import { spawn, ChildProcess } from 'node:child_process';\nimport { EventEmitter } from 'node:events';\nimport { Logger } from '../core/logger.js';\nimport { generateId } from '../utils/helpers.js';\nimport * as fs from 'node:fs/promises';\nimport * as path from 'node:path';\n\nexport interface BackgroundTask {\n  id: string;\n  type: 'claude-spawn' | 'script' | 'command';\n  command: string;\n  args: string[];\n  options?: {\n    cwd?: string;\n    env?: Record<string, string>;\n    timeout?: number;\n    retries?: number;\n    detached?: boolean;\n  };\n  status: 'pending' | 'running' | 'completed' | 'failed';\n  pid?: number;\n  output?: string;\n  error?: string;\n  startTime?: Date;\n  endTime?: Date;\n  retryCount: number;\n}\n\nexport interface BackgroundExecutorConfig {\n  maxConcurrentTasks: number;\n  defaultTimeout: number;\n  logPath: string;\n  enablePersistence: boolean;\n  checkInterval: number;\n  cleanupInterval: number;\n  maxRetries: number;\n}\n\nexport class BackgroundExecutor extends EventEmitter {\n  private logger: Logger;\n  private config: BackgroundExecutorConfig;\n  private tasks: Map<string, BackgroundTask>;\n  private processes: Map<string, ChildProcess>;\n  private queue: string[];\n  private isRunning: boolean = false;\n  private checkTimer?: NodeJS.Timeout;\n  private cleanupTimer?: NodeJS.Timeout;\n\n  constructor(config: Partial<BackgroundExecutorConfig> = {}) {\n    super();\n    this.logger = new Logger('BackgroundExecutor');\n    this.config = {\n      maxConcurrentTasks: 5,\n      defaultTimeout: 300000, // 5 minutes\n      logPath: './background-tasks',\n      enablePersistence: true,\n      checkInterval: 1000, // 1 second\n      cleanupInterval: 60000, // 1 minute\n      maxRetries: 3,\n      ...config,\n    };\n\n    this.tasks = new Map();\n    this.processes = new Map();\n    this.queue = [];\n  }\n\n  async start(): Promise<void> {\n    if (this.isRunning) return;\n\n    this.logger.info('Starting background executor...');\n    this.isRunning = true;\n\n    // Create log directory\n    if (this.config.enablePersistence) {\n      await fs.mkdir(this.config.logPath, { recursive: true });\n    }\n\n    // Start background processing\n    this.checkTimer = setInterval(() => {\n      this.processQueue();\n      this.checkRunningTasks();\n    }, this.config.checkInterval);\n\n    // Start cleanup timer\n    this.cleanupTimer = setInterval(() => {\n      this.cleanupCompletedTasks();\n    }, this.config.cleanupInterval);\n\n    this.emit('executor:started');\n  }\n\n  async stop(): Promise<void> {\n    if (!this.isRunning) return;\n\n    this.logger.info('Stopping background executor...');\n    this.isRunning = false;\n\n    // Clear timers\n    if (this.checkTimer) {\n      clearInterval(this.checkTimer);\n      this.checkTimer = undefined;\n    }\n\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n      this.cleanupTimer = undefined;\n    }\n\n    // Kill all running processes\n    for (const [taskId, process] of this.processes) {\n      this.logger.warn(`Killing process for task ${taskId}`);\n      process.kill('SIGTERM');\n    }\n\n    this.emit('executor:stopped');\n  }\n\n  async submitTask(\n    type: BackgroundTask['type'],\n    command: string,\n    args: string[] = [],\n    options: BackgroundTask['options'] = {},\n  ): Promise<string> {\n    const taskId = generateId('bgtask');\n    const task: BackgroundTask = {\n      id: taskId,\n      type,\n      command,\n      args,\n      options: {\n        timeout: this.config.defaultTimeout,\n        retries: this.config.maxRetries,\n        ...options,\n      },\n      status: 'pending',\n      retryCount: 0,\n    };\n\n    this.tasks.set(taskId, task);\n    this.queue.push(taskId);\n\n    if (this.config.enablePersistence) {\n      await this.saveTaskState(task);\n    }\n\n    this.logger.info(`Submitted background task: ${taskId} - ${command}`);\n    this.emit('task:submitted', task);\n\n    // Process immediately if possible\n    this.processQueue();\n\n    return taskId;\n  }\n\n  async submitClaudeTask(\n    prompt: string,\n    tools: string[] = [],\n    options: Partial<{\n      cwd: string;\n      env: Record<string, string>;\n      timeout: number;\n      model?: string;\n      maxTokens?: number;\n    }> = {},\n  ): Promise<string> {\n    // Build claude command arguments\n    const args = ['-p', prompt];\n\n    if (tools.length > 0) {\n      args.push('--allowedTools', tools.join(','));\n    }\n\n    if (options.model) {\n      args.push('--model', options.model);\n    }\n\n    if (options.maxTokens) {\n      args.push('--max-tokens', options.maxTokens.toString());\n    }\n\n    args.push('--dangerously-skip-permissions');\n\n    return this.submitTask('claude-spawn', 'claude', args, {\n      ...options,\n      detached: true, // Run in background\n    });\n  }\n\n  private async processQueue(): Promise<void> {\n    if (!this.isRunning) return;\n\n    // Check how many tasks are running\n    const runningTasks = Array.from(this.tasks.values()).filter(\n      (t) => t.status === 'running',\n    ).length;\n\n    const availableSlots = this.config.maxConcurrentTasks - runningTasks;\n\n    // Process pending tasks\n    for (let i = 0; i < availableSlots && this.queue.length > 0; i++) {\n      const taskId = this.queue.shift();\n      if (!taskId) continue;\n\n      const task = this.tasks.get(taskId);\n      if (!task || task.status !== 'pending') continue;\n\n      await this.executeTask(task);\n    }\n  }\n\n  private async executeTask(task: BackgroundTask): Promise<void> {\n    try {\n      task.status = 'running';\n      task.startTime = new Date();\n\n      this.logger.info(`Executing task ${task.id}: ${task.command} ${task.args.join(' ')}`);\n\n      // Create log files for task\n      const logDir = path.join(this.config.logPath, task.id);\n      if (this.config.enablePersistence) {\n        await fs.mkdir(logDir, { recursive: true });\n      }\n\n      // Spawn process\n      const process = spawn(task.command, task.args, {\n        cwd: task.options?.cwd,\n        env: { ...process.env, ...task.options?.env },\n        detached: task.options?.detached,\n        stdio: ['ignore', 'pipe', 'pipe'],\n      });\n\n      task.pid = process.pid;\n      this.processes.set(task.id, process);\n\n      // Collect output\n      let stdout = '';\n      let stderr = '';\n\n      process.stdout?.on('data', (data) => {\n        stdout += data.toString();\n        this.emit('task:output', { taskId: task.id, data: data.toString() });\n      });\n\n      process.stderr?.on('data', (data) => {\n        stderr += data.toString();\n        this.emit('task:error', { taskId: task.id, data: data.toString() });\n      });\n\n      // Handle process completion\n      process.on('close', async (code) => {\n        task.endTime = new Date();\n        task.output = stdout;\n        task.error = stderr;\n\n        if (code === 0) {\n          task.status = 'completed';\n          this.logger.info(`Task ${task.id} completed successfully`);\n          this.emit('task:completed', task);\n        } else {\n          task.status = 'failed';\n          this.logger.error(`Task ${task.id} failed with code ${code}`);\n\n          // Retry logic\n          if (task.retryCount < (task.options?.retries || 0)) {\n            task.retryCount++;\n            task.status = 'pending';\n            this.queue.push(task.id);\n            this.logger.info(\n              `Retrying task ${task.id} (${task.retryCount}/${task.options?.retries})`,\n            );\n            this.emit('task:retry', task);\n          } else {\n            this.emit('task:failed', task);\n          }\n        }\n\n        this.processes.delete(task.id);\n\n        if (this.config.enablePersistence) {\n          await this.saveTaskOutput(task);\n        }\n      });\n\n      // Set timeout if specified\n      if (task.options?.timeout) {\n        setTimeout(() => {\n          if (this.processes.has(task.id)) {\n            this.logger.warn(`Task ${task.id} timed out after ${task.options?.timeout}ms`);\n            process.kill('SIGTERM');\n          }\n        }, task.options.timeout);\n      }\n\n      // For detached processes, unref to allow main process to exit\n      if (task.options?.detached) {\n        process.unref();\n      }\n\n      this.emit('task:started', task);\n\n      if (this.config.enablePersistence) {\n        await this.saveTaskState(task);\n      }\n    } catch (error) {\n      task.status = 'failed';\n      task.error = String(error);\n      task.endTime = new Date();\n\n      this.logger.error(`Failed to execute task ${task.id}:`, error);\n      this.emit('task:failed', task);\n\n      if (this.config.enablePersistence) {\n        await this.saveTaskState(task);\n      }\n    }\n  }\n\n  private checkRunningTasks(): void {\n    // Check for hung or timed out tasks\n    const now = Date.now();\n\n    for (const [taskId, task] of this.tasks) {\n      if (task.status !== 'running' || !task.startTime) continue;\n\n      const runtime = now - task.startTime.getTime();\n      const timeout = task.options?.timeout || this.config.defaultTimeout;\n\n      if (runtime > timeout) {\n        const process = this.processes.get(taskId);\n        if (process) {\n          this.logger.warn(`Killing timed out task ${taskId}`);\n          process.kill('SIGTERM');\n\n          // Force kill after 5 seconds\n          setTimeout(() => {\n            if (this.processes.has(taskId)) {\n              process.kill('SIGKILL');\n            }\n          }, 5000);\n        }\n      }\n    }\n  }\n\n  private cleanupCompletedTasks(): void {\n    const cutoffTime = Date.now() - 3600000; // 1 hour\n\n    for (const [taskId, task] of this.tasks) {\n      if (task.status === 'completed' || task.status === 'failed') {\n        if (task.endTime && task.endTime.getTime() < cutoffTime) {\n          this.tasks.delete(taskId);\n          this.logger.debug(`Cleaned up old task: ${taskId}`);\n        }\n      }\n    }\n  }\n\n  private async saveTaskState(task: BackgroundTask): Promise<void> {\n    if (!this.config.enablePersistence) return;\n\n    try {\n      const taskFile = path.join(this.config.logPath, task.id, 'task.json');\n      await fs.writeFile(taskFile, JSON.stringify(task, null, 2));\n    } catch (error) {\n      this.logger.error(`Failed to save task state for ${task.id}:`, error);\n    }\n  }\n\n  private async saveTaskOutput(task: BackgroundTask): Promise<void> {\n    if (!this.config.enablePersistence) return;\n\n    try {\n      const logDir = path.join(this.config.logPath, task.id);\n\n      if (task.output) {\n        await fs.writeFile(path.join(logDir, 'stdout.log'), task.output);\n      }\n\n      if (task.error) {\n        await fs.writeFile(path.join(logDir, 'stderr.log'), task.error);\n      }\n\n      // Save final task state\n      await this.saveTaskState(task);\n    } catch (error) {\n      this.logger.error(`Failed to save task output for ${task.id}:`, error);\n    }\n  }\n\n  // Public API methods\n  getTask(taskId: string): BackgroundTask | undefined {\n    return this.tasks.get(taskId);\n  }\n\n  getTasks(status?: BackgroundTask['status']): BackgroundTask[] {\n    const tasks = Array.from(this.tasks.values());\n    return status ? tasks.filter((t) => t.status === status) : tasks;\n  }\n\n  async waitForTask(taskId: string, timeout?: number): Promise<BackgroundTask> {\n    return new Promise((resolve, reject) => {\n      const task = this.tasks.get(taskId);\n      if (!task) {\n        reject(new Error('Task not found'));\n        return;\n      }\n\n      if (task.status === 'completed' || task.status === 'failed') {\n        resolve(task);\n        return;\n      }\n\n      const timeoutHandle = timeout\n        ? setTimeout(() => {\n            reject(new Error('Wait timeout'));\n          }, timeout)\n        : undefined;\n\n      const checkTask = () => {\n        const currentTask = this.tasks.get(taskId);\n        if (!currentTask) {\n          if (timeoutHandle) clearTimeout(timeoutHandle);\n          reject(new Error('Task disappeared'));\n          return;\n        }\n\n        if (currentTask.status === 'completed' || currentTask.status === 'failed') {\n          if (timeoutHandle) clearTimeout(timeoutHandle);\n          resolve(currentTask);\n        } else {\n          setTimeout(checkTask, 100);\n        }\n      };\n\n      checkTask();\n    });\n  }\n\n  async killTask(taskId: string): Promise<void> {\n    const task = this.tasks.get(taskId);\n    if (!task) {\n      throw new Error('Task not found');\n    }\n\n    const process = this.processes.get(taskId);\n    if (process) {\n      this.logger.info(`Killing task ${taskId}`);\n      process.kill('SIGTERM');\n\n      // Force kill after 5 seconds\n      setTimeout(() => {\n        if (this.processes.has(taskId)) {\n          process.kill('SIGKILL');\n        }\n      }, 5000);\n    }\n\n    task.status = 'failed';\n    task.error = 'Task killed by user';\n    task.endTime = new Date();\n\n    this.emit('task:killed', task);\n  }\n\n  getStatus(): {\n    running: number;\n    pending: number;\n    completed: number;\n    failed: number;\n    queueLength: number;\n  } {\n    const tasks = Array.from(this.tasks.values());\n    return {\n      running: tasks.filter((t) => t.status === 'running').length,\n      pending: tasks.filter((t) => t.status === 'pending').length,\n      completed: tasks.filter((t) => t.status === 'completed').length,\n      failed: tasks.filter((t) => t.status === 'failed').length,\n      queueLength: this.queue.length,\n    };\n  }\n}\n"],"names":["spawn","EventEmitter","Logger","generateId","fs","path","BackgroundExecutor","logger","config","tasks","processes","queue","isRunning","checkTimer","cleanupTimer","maxConcurrentTasks","defaultTimeout","logPath","enablePersistence","checkInterval","cleanupInterval","maxRetries","Map","start","info","mkdir","recursive","setInterval","processQueue","checkRunningTasks","cleanupCompletedTasks","emit","stop","clearInterval","undefined","taskId","process","warn","kill","submitTask","type","command","args","options","task","id","timeout","retries","status","retryCount","set","push","saveTaskState","submitClaudeTask","prompt","tools","length","join","model","maxTokens","toString","detached","runningTasks","Array","from","values","filter","t","availableSlots","i","shift","get","executeTask","startTime","Date","logDir","cwd","env","stdio","pid","stdout","stderr","on","data","code","endTime","output","error","delete","saveTaskOutput","setTimeout","has","unref","String","now","runtime","getTime","cutoffTime","debug","taskFile","writeFile","JSON","stringify","getTask","getTasks","waitForTask","Promise","resolve","reject","Error","timeoutHandle","checkTask","currentTask","clearTimeout","killTask","getStatus","running","pending","completed","failed","queueLength"],"mappings":"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"}