{"version":3,"sources":["../../../src/coordination/circuit-breaker.ts"],"sourcesContent":["/**\n * Circuit breaker pattern for fault tolerance\n */\n\nimport type { ILogger } from '../core/logger.js';\nimport type { IEventBus } from '../core/event-bus.js';\n\nexport interface CircuitBreakerConfig {\n  failureThreshold: number; // Number of failures before opening\n  successThreshold: number; // Number of successes before closing\n  timeout: number; // Time in ms before attempting to close\n  halfOpenLimit: number; // Max requests in half-open state\n}\n\nexport enum CircuitState {\n  CLOSED = 'closed',\n  OPEN = 'open',\n  HALF_OPEN = 'half-open',\n}\n\nexport interface CircuitBreakerMetrics {\n  state: CircuitState;\n  failures: number;\n  successes: number;\n  lastFailureTime?: Date;\n  lastSuccessTime?: Date;\n  totalRequests: number;\n  rejectedRequests: number;\n  halfOpenRequests: number;\n}\n\n/**\n * Circuit breaker for protecting against cascading failures\n */\nexport class CircuitBreaker {\n  private state: CircuitState = CircuitState.CLOSED;\n  private failures = 0;\n  private successes = 0;\n  private lastFailureTime?: Date;\n  private lastSuccessTime?: Date;\n  private nextAttempt?: Date;\n  private halfOpenRequests = 0;\n  private totalRequests = 0;\n  private rejectedRequests = 0;\n\n  constructor(\n    private name: string,\n    private config: CircuitBreakerConfig,\n    private logger: ILogger,\n    private eventBus?: IEventBus,\n  ) {}\n\n  /**\n   * Execute a function with circuit breaker protection\n   */\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\n    this.totalRequests++;\n\n    // Check if we should execute\n    if (!this.canExecute()) {\n      this.rejectedRequests++;\n      const error = new Error(`Circuit breaker '${this.name}' is OPEN`);\n      this.logStateChange('Request rejected');\n      throw error;\n    }\n\n    try {\n      // Execute the function\n      const result = await fn();\n\n      // Record success\n      this.onSuccess();\n\n      return result;\n    } catch (error) {\n      // Record failure\n      this.onFailure();\n\n      throw error;\n    }\n  }\n\n  /**\n   * Check if execution is allowed\n   */\n  private canExecute(): boolean {\n    switch (this.state) {\n      case CircuitState.CLOSED:\n        return true;\n\n      case CircuitState.OPEN:\n        // Check if we should transition to half-open\n        if (this.nextAttempt && new Date() >= this.nextAttempt) {\n          this.transitionTo(CircuitState.HALF_OPEN);\n          return true;\n        }\n        return false;\n\n      case CircuitState.HALF_OPEN:\n        // Allow limited requests in half-open state\n        return this.halfOpenRequests < this.config.halfOpenLimit;\n\n      default:\n        return false;\n    }\n  }\n\n  /**\n   * Handle successful execution\n   */\n  private onSuccess(): void {\n    this.lastSuccessTime = new Date();\n\n    switch (this.state) {\n      case CircuitState.CLOSED:\n        this.failures = 0; // Reset failure count\n        break;\n\n      case CircuitState.HALF_OPEN:\n        this.successes++;\n        this.halfOpenRequests++;\n\n        // Check if we should close the circuit\n        if (this.successes >= this.config.successThreshold) {\n          this.transitionTo(CircuitState.CLOSED);\n        }\n        break;\n\n      case CircuitState.OPEN:\n        // Shouldn't happen, but handle gracefully\n        this.transitionTo(CircuitState.HALF_OPEN);\n        break;\n    }\n  }\n\n  /**\n   * Handle failed execution\n   */\n  private onFailure(): void {\n    this.lastFailureTime = new Date();\n\n    switch (this.state) {\n      case CircuitState.CLOSED:\n        this.failures++;\n\n        // Check if we should open the circuit\n        if (this.failures >= this.config.failureThreshold) {\n          this.transitionTo(CircuitState.OPEN);\n        }\n        break;\n\n      case CircuitState.HALF_OPEN:\n        // Single failure in half-open state reopens the circuit\n        this.transitionTo(CircuitState.OPEN);\n        break;\n\n      case CircuitState.OPEN:\n        // Already open, update next attempt time\n        this.nextAttempt = new Date(Date.now() + this.config.timeout);\n        break;\n    }\n  }\n\n  /**\n   * Transition to a new state\n   */\n  private transitionTo(newState: CircuitState): void {\n    const oldState = this.state;\n    this.state = newState;\n\n    this.logger.info(`Circuit breaker '${this.name}' state change`, {\n      from: oldState,\n      to: newState,\n      failures: this.failures,\n      successes: this.successes,\n    });\n\n    // Reset counters based on new state\n    switch (newState) {\n      case CircuitState.CLOSED:\n        this.failures = 0;\n        this.successes = 0;\n        this.halfOpenRequests = 0;\n        delete this.nextAttempt;\n        break;\n\n      case CircuitState.OPEN:\n        this.successes = 0;\n        this.halfOpenRequests = 0;\n        this.nextAttempt = new Date(Date.now() + this.config.timeout);\n        break;\n\n      case CircuitState.HALF_OPEN:\n        this.successes = 0;\n        this.failures = 0;\n        this.halfOpenRequests = 0;\n        break;\n    }\n\n    // Emit state change event\n    if (this.eventBus) {\n      this.eventBus.emit('circuitbreaker:state-change', {\n        name: this.name,\n        from: oldState,\n        to: newState,\n        metrics: this.getMetrics(),\n      });\n    }\n  }\n\n  /**\n   * Force the circuit to a specific state\n   */\n  forceState(state: CircuitState): void {\n    this.logger.warn(`Forcing circuit breaker '${this.name}' to state`, { state });\n    this.transitionTo(state);\n  }\n\n  /**\n   * Get current state\n   */\n  getState(): CircuitState {\n    return this.state;\n  }\n\n  /**\n   * Get circuit breaker metrics\n   */\n  getMetrics(): CircuitBreakerMetrics {\n    const metrics: CircuitBreakerMetrics = {\n      state: this.state,\n      failures: this.failures,\n      successes: this.successes,\n      totalRequests: this.totalRequests,\n      rejectedRequests: this.rejectedRequests,\n      halfOpenRequests: this.halfOpenRequests,\n    };\n\n    if (this.lastFailureTime !== undefined) {\n      metrics.lastFailureTime = this.lastFailureTime;\n    }\n\n    if (this.lastSuccessTime !== undefined) {\n      metrics.lastSuccessTime = this.lastSuccessTime;\n    }\n\n    return metrics;\n  }\n\n  /**\n   * Reset the circuit breaker\n   */\n  reset(): void {\n    this.logger.info(`Resetting circuit breaker '${this.name}'`);\n    this.state = CircuitState.CLOSED;\n    this.failures = 0;\n    this.successes = 0;\n    delete this.lastFailureTime;\n    delete this.lastSuccessTime;\n    delete this.nextAttempt;\n    this.halfOpenRequests = 0;\n    this.totalRequests = 0;\n    this.rejectedRequests = 0;\n  }\n\n  /**\n   * Log state change with consistent format\n   */\n  private logStateChange(message: string): void {\n    this.logger.debug(`Circuit breaker '${this.name}': ${message}`, {\n      state: this.state,\n      failures: this.failures,\n      successes: this.successes,\n      nextAttempt: this.nextAttempt,\n    });\n  }\n}\n\n/**\n * Manager for multiple circuit breakers\n */\nexport class CircuitBreakerManager {\n  private breakers = new Map<string, CircuitBreaker>();\n\n  constructor(\n    private defaultConfig: CircuitBreakerConfig,\n    private logger: ILogger,\n    private eventBus?: IEventBus,\n  ) {}\n\n  /**\n   * Get or create a circuit breaker\n   */\n  getBreaker(name: string, config?: Partial<CircuitBreakerConfig>): CircuitBreaker {\n    let breaker = this.breakers.get(name);\n\n    if (!breaker) {\n      const finalConfig = { ...this.defaultConfig, ...config };\n      breaker = new CircuitBreaker(name, finalConfig, this.logger, this.eventBus);\n      this.breakers.set(name, breaker);\n    }\n\n    return breaker;\n  }\n\n  /**\n   * Execute with circuit breaker\n   */\n  async execute<T>(\n    name: string,\n    fn: () => Promise<T>,\n    config?: Partial<CircuitBreakerConfig>,\n  ): Promise<T> {\n    const breaker = this.getBreaker(name, config);\n    return breaker.execute(fn);\n  }\n\n  /**\n   * Get all circuit breakers\n   */\n  getAllBreakers(): Map<string, CircuitBreaker> {\n    return new Map(this.breakers);\n  }\n\n  /**\n   * Get metrics for all breakers\n   */\n  getAllMetrics(): Record<string, CircuitBreakerMetrics> {\n    const metrics: Record<string, CircuitBreakerMetrics> = {};\n\n    for (const [name, breaker] of this.breakers) {\n      metrics[name] = breaker.getMetrics();\n    }\n\n    return metrics;\n  }\n\n  /**\n   * Reset a specific breaker\n   */\n  resetBreaker(name: string): void {\n    const breaker = this.breakers.get(name);\n    if (breaker) {\n      breaker.reset();\n    }\n  }\n\n  /**\n   * Reset all breakers\n   */\n  resetAll(): void {\n    for (const breaker of this.breakers.values()) {\n      breaker.reset();\n    }\n  }\n\n  /**\n   * Force a breaker to a specific state\n   */\n  forceState(name: string, state: CircuitState): void {\n    const breaker = this.breakers.get(name);\n    if (breaker) {\n      breaker.forceState(state);\n    }\n  }\n}\n"],"names":["CircuitState","CircuitBreaker","state","failures","successes","lastFailureTime","lastSuccessTime","nextAttempt","halfOpenRequests","totalRequests","rejectedRequests","name","config","logger","eventBus","execute","fn","canExecute","error","Error","logStateChange","result","onSuccess","onFailure","Date","transitionTo","halfOpenLimit","successThreshold","failureThreshold","now","timeout","newState","oldState","info","from","to","emit","metrics","getMetrics","forceState","warn","getState","undefined","reset","message","debug","CircuitBreakerManager","breakers","Map","defaultConfig","getBreaker","breaker","get","finalConfig","set","getAllBreakers","getAllMetrics","resetBreaker","resetAll","values"],"mappings":"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"}